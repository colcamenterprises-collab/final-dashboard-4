PHASE H ‚Äî BUSINESS EXPENSE STABILITY PATCH
‚ö†Ô∏è DO NOT ADD FEATURES ‚Ä¢ DO NOT CHANGE UI ‚Ä¢ DO NOT ADD ANALYTICS
Objective: Make business expense lodging 100% reliable and crash-proof so the system can be used daily without errors.
üîí RULES (NON-NEGOTIABLE)
Backend only
NO UI changes
NO schema redesign
NO analytics / reporting
NO new pages
NO breaking changes
If a table or column does not exist ‚Üí fail safely with empty results
All endpoints must return 200 or 400, never 500
üéØ PRIMARY GOAL
Staff and managers must be able to lodge business expenses reliably without causing:
500 errors
broken Finance pages
broken Daily Summary pages
broken P&L pages
üß± PHASE H TASKS (EXECUTE IN ORDER)
H1 ‚Äî HARDEN EXPENSE CREATION (WRITE PATH)
Files to inspect:
server/routes/expenses*.ts
server/services/expense*.ts
Actions:
Wrap all DB writes in try/catch
If optional fields are missing ‚Üí store null, not crash
Validate minimum required fields only:
amount
category
payment_method (CASH | BANK)
Return HTTP 400 with { success:false, reason } if invalid
Never throw raw DB errors to client
‚úÖ Result: Expense submission can never crash the server
H2 ‚Äî DEFENSIVE READS FOR EXPENSE QUERIES
Endpoints to harden:
/api/expenses
/api/finance/*
/api/profit-loss
Actions:
If table does not exist ‚Üí return []
If column missing ‚Üí omit field
Use COALESCE for sums
Never assume multi-tenant columns (e.g. restaurant_id)
Always return:
Copy code
Json
{ "success": true, "data": [] }
‚úÖ Result: Finance pages never 500 even if data is missing
H3 ‚Äî CASH vs BANK EXPENSE NORMALISATION
Goal: Stop mixing shift cash expenses with business bank expenses.
Actions:
Enforce:
payment_method = BANK ‚Üí business expense
payment_method = CASH ‚Üí shift expense
If missing ‚Üí default to BANK
Do not recalculate or infer totals
‚úÖ Result: Expenses are safely categorized for later analysis
H4 ‚Äî LEGACY TABLE SAFETY
Known legacy risks:
expensesLegacy
daily_reports_v2
old finance joins
Actions:
Wrap all legacy reads with:
Copy code
Ts
if (!tableExists) return [];
Never JOIN legacy tables blindly
Never assume migration completeness
‚úÖ Result: Old systems can exist without breaking the app
H5 ‚Äî DATA CONFIDENCE & SUMMARY SAFETY
Endpoints:
/api/data-confidence
/api/daily-summary
/api/reports/*
Actions:
Remove assumptions about verified, approved, or locked columns
Compute confidence purely from row existence
If nothing exists ‚Üí return:
Copy code
Json
{ "status": "NO_DATA" }
‚úÖ Result: Daily Summary never crashes even on empty days
H6 ‚Äî GLOBAL FAIL-SAFE PATTERN
Apply this pattern everywhere expenses are touched:
Copy code
Ts
try {
  // db logic
} catch (err) {
  console.error('[EXPENSE_SAFE_FAIL]', err);
  return res.status(200).json({
    success: true,
    data: [],
    warning: 'SAFE_FALLBACK_USED'
  });
}
‚úÖ Result: System degrades safely, never hard-fails
üß™ REQUIRED VERIFICATION (MANDATORY)
After patch:
[ ] Create BANK expense ‚Üí succeeds
[ ] Create CASH expense ‚Üí succeeds
[ ] View Expenses page ‚Üí loads
[ ] View P&L page ‚Üí loads
[ ] View Daily Summary ‚Üí loads
[ ] No endpoint returns 500
[ ] Empty DB still loads all pages
üß† IMPORTANT CONTEXT (DO NOT CHANGE)
Ingredient usage logic (PHASE G) is authoritative
Expense logic is input only, not analytical yet
This patch exists purely to keep the business running
‚úÖ COMPLETION CONDITION
PHASE H is complete only when:
All expense-related endpoints return safely
No Finance / Summary page crashes
Business expenses can be lodged daily without risk
üö® DO NOT:
Add charts
Add calculations
Add reconciliation
Touch ingredient logic
Touch purchasing logic
Touch navigation
Touch UI
END OF PATCH ‚Äî EXECUTE EXACTLY AS WRITTEN