ğŸ”’ PATCH 13 â€” RECEIPT â†’ RECIPE â†’ INGREDIENT TRUTH ENGINE (MARKET-LEADING)
STATUS: PRODUCTION-CRITICAL
SCOPE: Backend + Analysis UI (read-only)
PRIORITY: Highest
GOAL:
For any shift, deterministically show exact ingredient usage derived from receipts, fully accounting for recipes + modifiers, with zero guessing and full auditability.
This is the patch that turns your system into a real restaurant intelligence platform.
ğŸ§  WHAT THIS PATCH DELIVERS (EXACTLY)
1ï¸âƒ£ Canonical Ingredient Usage per Shift (Receipt-Driven)
For any business date:
Receipts â†’ Items â†’ Recipes â†’ Ingredients
Output:
Ingredient name
Quantity used
Unit (g / ml / unit)
Source count (how many sold items contributed)
No fallback
No estimation
No manual entry
Example output:
Copy code

Burger Bun        52 units
Beef Patty        4,680 g
Cheddar Slice     52 units
Burger Sauce      1,040 g
Salt                84 g
2ï¸âƒ£ Modifier-Aware Ingredient Math (NON-NEGOTIABLE)
Modifiers MUST affect ingredient usage.
Examples:
âŒ NO CHEESE â†’ subtract cheese
â• EXTRA CHEESE â†’ add cheese
ğŸ¥“ ADD BACON â†’ add bacon ingredients
ğŸ„ Animal Style â†’ add sauce + onions
Rules:
Modifier â†’ recipe override layer
Stored explicitly
Applied arithmetically
Logged per receipt line
3ï¸âƒ£ Deterministic Engine (Rebuildable, Auditable)
Rebuild any date from July 1 onward
Same input = same output
Deletes prior truth run before rebuild
Emits:
SUCCESS / PARTIAL / FAILED
Confidence score
Flag list
4ï¸âƒ£ Market-Leading Analysis UI (Read-Only, Beautiful)
New Analysis page:
/analysis/ingredient-usage
Sections:
ğŸ”¢ Summary cards (Receipts, Items, Ingredients, Coverage %)
ğŸ“¦ Ingredient Usage Table
ğŸ§© Modifier Impact Breakdown
ğŸš© Flags & Gaps (whatâ€™s blocking 100%)
ğŸ§¾ Receipt Trace (click ingredient â†’ see receipts)
Design rules:
Clean
Minimal
No editing
Truth inspection only
ğŸ§± DATABASE (ADD-ONLY â€” DO NOT TOUCH EXISTING)
Tables to ADD:
receipt_truth_run
Copy code
Sql
id
business_date
started_at
completed_at
status
receipt_count
line_item_count
confidence_score
notes
receipt_truth_ingredient_usage
Copy code
Sql
id
truth_run_id
ingredient_id
ingredient_name
quantity_used
unit
source_item_count
confidence
receipt_truth_modifier_effect
Copy code
Sql
id
truth_run_id
receipt_id
pos_item_name
modifier_name
ingredient_id
quantity_delta
receipt_truth_flags
Copy code
Sql
id
truth_run_id
type
message
entity_ref
âš™ï¸ BACKEND â€” ENGINE (MANDATORY FLOW)
File:
server/services/receiptIngredientTruthEngine.ts
Execution Order (DO NOT CHANGE):
Resolve shift window
17:00 â†’ 03:00 (BKK)
Load receipts
Source: Loyverse API ONLY
Expand receipt line items
Include modifiers
Resolve POS item â†’ Recipe
If missing â†’ FLAG
Resolve Recipe â†’ Ingredients
If missing â†’ FLAG
Apply modifier overrides
Add / subtract ingredient deltas
Aggregate ingredient usage
Score confidence
Persist truth tables
ğŸŒ API ROUTES (NEW ONLY)
Copy code
Http
POST /api/analysis/ingredient-usage/rebuild
GET  /api/analysis/ingredient-usage?date=YYYY-MM-DD
Responses MUST include:
ingredient_usage[]
modifier_effects[]
flags[]
confidence_score
ğŸš« ABSOLUTE PROHIBITIONS
The agent MUST NOT:
Guess ingredient quantities
Infer recipes
Auto-map modifiers
Touch receipts ingestion
Touch shopping list logic
Touch P&L
Touch expenses
Touch existing schemas
Cache results
Hide missing data
If data is missing â†’ FLAG IT
âœ… ACCEPTANCE CRITERIA (ALL REQUIRED)
[ ] Single Smash Burger Ã—15 â†’ exact bun, patty, cheese, sauce usage
[ ] Modifier â€œNO CHEESEâ€ reduces cheese count
[ ] Modifier â€œEXTRA BACONâ€ increases bacon usage
[ ] Rebuild July 1 â†’ Today
[ ] Same rebuild = identical numbers
[ ] UI shows ingredient totals + traceability
[ ] Flags visible for unmapped items
[ ] Confidence score < 100 explained
ğŸ§¾ DELIVERY FORMAT (STRICT)
SQL migration(s)
receiptIngredientTruthEngine.ts
Routes file
UI page
No unrelated file changes
One execution only
If blocked â†’ STOP and REPORT