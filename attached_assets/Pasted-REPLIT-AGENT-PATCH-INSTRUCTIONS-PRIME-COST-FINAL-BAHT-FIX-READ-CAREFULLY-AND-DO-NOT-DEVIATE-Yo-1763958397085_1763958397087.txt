REPLIT AGENT PATCH INSTRUCTIONS â€” PRIME COST (FINAL BAHT FIX)

READ CAREFULLY AND DO NOT DEVIATE.
You are not allowed to modify anything except the file listed below.


---

âœ… TARGET FILE TO REPLACE

Replace the entire contents of:

server/services/primeCost.ts

with the following exact script:


---

ðŸŸ§ FULL FILE CONTENT â€” OVERWRITE COMPLETELY

// server/services/primeCost.ts
import db from "../db";

//
// PRIME COST SERVICE (FINAL BAHT VERSION)
// Expenses are stored in FULL Thai Baht (NOT cents).
// Remove all divide-by-100 logic permanently.
// --------------------------------------------------

/**
 * Get the latest recorded shift_date from daily_sales_v2.
 * We always trust the database â€” NO calculated time logic.
 */
export async function getLatestShiftDate() {
  const result = await db.query(`
    SELECT shift_date
    FROM daily_sales_v2
    WHERE shift_date IS NOT NULL
    ORDER BY shift_date DESC
    LIMIT 1;
  `);

  if (result.rows.length === 0) return null;

  const d = result.rows[0].shift_date;
  return d.toISOString().split("T")[0];
}

/**
 * Get all F&B expenses for a specific shift date.
 * costCents is actually BAHT now â€” do NOT divide.
 */
async function getFnbForDate(date: string) {
  const result = await db.query(
    `
      SELECT "costCents"
      FROM expenses
      WHERE "shiftDate"::date = $1::date
        AND LOWER("expenseType") IN (
          'food','f&b','fnb','ingredients','meat','rolls','burger buns','stock','purchase'
        );
    `,
    [date]
  );

  return result.rows.reduce(
    (sum, r) => sum + Number(r.costCents || 0),
    0
  );
}

/**
 * Get daily prime cost metrics.
 */
export async function getPrimeCostForDate(date: string) {
  const salesRow = await db.query(
    `
      SELECT "totalSales", "wagesTotal"
      FROM daily_sales_v2
      WHERE "shift_date" = $1::date
      LIMIT 1;
    `,
    [date]
  );

  if (salesRow.rows.length === 0) {
    return {
      date,
      sales: 0,
      wages: 0,
      fnb: 0,
      primeCost: 0,
      primePct: null,
    };
  }

  const sales = Number(salesRow.rows[0].totalSales || 0);
  const wages = Number(salesRow.rows[0].wagesTotal || 0);
  const fnb = await getFnbForDate(date);

  const primeCost = wages + fnb;
  const primePct = sales > 0 ? (primeCost / sales) * 100 : null;

  return {
    date,
    sales,
    wages,
    fnb,
    primeCost,
    primePct,
  };
}

/**
 * Get Month-To-Date prime cost metrics.
 */
export async function getPrimeCostMTD(date: string) {
  // Beginning of month (YYYY-MM-01)
  const start = date.slice(0, 7) + "-01";

  const result = await db.query(
    `
      SELECT 
        COALESCE(SUM("totalSales"), 0) AS sales,
        COALESCE(SUM("wagesTotal"), 0) AS wages
      FROM daily_sales_v2
      WHERE "shift_date" >= $1::date
        AND "shift_date" <= $2::date;
    `,
    [start, date]
  );

  const sales = Number(result.rows[0].sales || 0);
  const wages = Number(result.rows[0].wages || 0);

  // Fetch MTD F&B expenses
  const fnbRows = await db.query(
    `
      SELECT "costCents"
      FROM expenses
      WHERE "shiftDate"::date >= $1::date
        AND "shiftDate"::date <= $2::date
        AND LOWER("expenseType") IN (
          'food','f&b','fnb','ingredients','meat','rolls','burger buns','stock','purchase'
        );
    `,
    [start, date]
  );

  const fnb = fnbRows.rows.reduce(
    (sum, r) => sum + Number(r.costCents || 0),
    0
  );

  const primeCost = wages + fnb;
  const primePct = sales > 0 ? (primeCost / sales) * 100 : null;

  return {
    start,
    end: date,
    sales,
    wages,
    fnb,
    primeCost,
    primePct,
  };
}


---

ðŸŸ¥ STRICT RULES FOR THE AGENT

DO NOT modify any other file.

DO NOT rename any variables, functions, or imports.

DO NOT change any routes.

DO NOT add any migrations.

DO NOT touch the frontend.

ONLY replace server/services/primeCost.ts exactly as above.


After completion:

1. Restart backend


2. Confirm API endpoint works:
GET /api/metrics/prime-cost


3. Stop. Do not touch anything else.




---