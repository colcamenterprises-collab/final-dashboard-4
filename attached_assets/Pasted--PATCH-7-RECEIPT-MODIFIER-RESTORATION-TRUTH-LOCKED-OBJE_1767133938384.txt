ğŸ”’ PATCH 7 â€” RECEIPT MODIFIER RESTORATION (TRUTH-LOCKED)
OBJECTIVE
Restore modifier visibility in Receipt Analysis using real Loyverse data, not guesses.
Modifiers must:
Come only from the Loyverse API
Be visible per item and aggregated
Never be removed because theyâ€™re â€œinconvenientâ€
Backdate correctly (â‰¥ 2024-07-01)
This patch restores what F&B Analysis had, without touching receipts, sales totals, or ingredients logic.
NON-NEGOTIABLE RULES
âŒ NO database deletes
âŒ NO fake modifiers
âŒ NO hiding sections if data is incomplete
âŒ NO receipt math changes
âœ… READ-ONLY truth inspection
âœ… Loyverse API is source of truth
DATA SOURCE (LOCKED)
Loyverse receipt payload:
Copy code
Json
receipt.line_items[].modifiers[]
Fields used:
name
price
quantity
line_item_id
receipt_id
PATCH CONTENTS
1ï¸âƒ£ BACKEND â€” MODIFIER INGEST & STORAGE (ADD ONLY)
Add table (additive only)
Copy code
Sql
receipt_truth_modifier
- id (uuid, pk)
- business_date (date)
- receipt_id (string)
- line_item_id (string)
- modifier_name (text)
- quantity (numeric)
- price (numeric)
2ï¸âƒ£ BACKEND â€” SERVICE UPDATE
File:
server/services/receiptTruthSummary.ts
ADD after line item expansion:
Copy code
Ts
for (const modifier of line.modifiers ?? []) {
  await db.insert(receipt_truth_modifier).values({
    business_date,
    receipt_id: receipt.id,
    line_item_id: line.id,
    modifier_name: modifier.name,
    quantity: modifier.quantity ?? 1,
    price: modifier.price ?? 0,
  });
}
ğŸš« Do NOT transform
ğŸš« Do NOT map
ğŸš« Do NOT infer
3ï¸âƒ£ BACKEND â€” AGGREGATION ENDPOINT
NEW endpoint
Copy code

GET /api/analysis/receipts-truth/modifiers?date=YYYY-MM-DD
Returns:
Copy code
Json
{
  "totalModifiers": 62,
  "modifiers": [
    {
      "name": "ğŸ¥“ Crispy Bacon",
      "count": 18,
      "gross": 540
    },
    {
      "name": "âŒ NO PICKLES",
      "count": 12,
      "gross": 0
    }
  ]
}
Rules:
Count = number of modifier instances
Gross = sum(price Ã— quantity)
Zero-price modifiers must appear
4ï¸âƒ£ FRONTEND â€” RECEIPT ANALYSIS UI (RESTORE SECTION)
File:
client/src/pages/ReceiptAnalysis.tsx
ADD TAB: Modifiers
Display:
Modifier
Count
Gross Impact
Rules:
Show even if price = 0
Sorted by count desc
No hiding
No fallback text
If empty â†’ show:
â€œNo modifiers present in POS data for this dateâ€
5ï¸âƒ£ SAFETY LOCKS
If no modifiers found â†’ UI still renders section
If Loyverse returns empty modifiers â†’ display empty state
If rebuild not run â†’ banner: â€œReceipt truth not built for this dateâ€
ACCEPTANCE CRITERIA (MANDATORY)
âœ… Modifiers visible per date
âœ… Matches Loyverse receipt modifiers
âœ… Zero-price modifiers shown
âœ… Backdated dates work
âœ… No receipt totals change
âœ… No ingredient logic touched
âœ… No UI sections silently removed