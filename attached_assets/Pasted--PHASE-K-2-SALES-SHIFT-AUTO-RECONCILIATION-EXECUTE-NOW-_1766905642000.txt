üîß PHASE K-2 ‚Äî SALES & SHIFT AUTO-RECONCILIATION (EXECUTE NOW)
STATUS: üî¥ CRITICAL
GOAL: Make Sales & Shift Analysis correct, automatic, and trustworthy
SCOPE: Backend logic + minimal UI behaviour only
NO DESIGN CHANGES
üéØ CORE OBJECTIVE (NON-NEGOTIABLE)
Sales & Shift Analysis MUST auto-reconcile when a date is selected.
Manual ‚ÄúSync POS‚Äù must never be required to see correct data.
üö´ ABSOLUTE PROHIBITIONS
Agent MUST NOT:
Add new tables
Change schemas
Add analytics or charts
Block pages with modals
Throw 500 errors for missing data
Require manual sync for normal operation
üß± REQUIRED FIXES (EXECUTE IN ORDER)
K-2.1 REMOVE MANUAL SYNC AS A DEPENDENCY
UI Behaviour
Keep Sync POS button
Change meaning to:
‚ÄúRetry POS import‚Äù (optional recovery action)
REQUIRED:
Page load must not depend on clicking Sync POS
Selecting a date must immediately attempt reconciliation
K-2.2 AUTO-RECONCILE ON DATE SELECTION
When a date is selected in Sales & Shift Analysis:
Determine business date window (17:00 ‚Üí 03:00)
Load:
POS receipts for that date
Daily Sales V2 for that date
Run reconciliation logic automatically
‚ö†Ô∏è NO user action
‚ö†Ô∏è NO modal
‚ö†Ô∏è NO sync click
K-2.3 SAFE RECONCILIATION LOGIC (MANDATORY)
Implement this exact decision table:
POS
Daily Sales
Result
‚úÖ
‚úÖ
Reconcile + show variance
‚ùå
‚úÖ
Show Daily Sales + warning
‚úÖ
‚ùå
Show POS + warning
‚ùå
‚ùå
Empty state + warning
IMPORTANT
Never throw
Never return 500
Always return HTTP 200
K-2.4 FIX SYNC ENDPOINT (STOP 500 ERRORS)
Wrap POS sync endpoint in full defensive logic:
If POS data missing ‚Üí return:
Copy code
Json
{
  "status": "PARTIAL_DATA",
  "reason": "POS_MISSING"
}
If Daily Sales missing ‚Üí return:
Copy code
Json
{
  "status": "PARTIAL_DATA",
  "reason": "DAILY_SALES_MISSING"
}
If both present ‚Üí return:
Copy code
Json
{
  "status": "OK",
  "reconciled": true
}
‚ö†Ô∏è DO NOT THROW ‚ö†Ô∏è Log SAFE_FALLBACK_USED
K-2.5 UI STATUS (NO REDESIGN)
Replace blocking error modal with inline banner text:
‚úÖ Reconciled
‚ö†Ô∏è Missing POS receipts
‚ö†Ô∏è Daily Sales form not submitted
‚ùå Variance detected (amount mismatch)
Page must remain usable in ALL cases
K-2.6 DATA CONSISTENCY CHECK
Ensure:
Bottom table = Daily Sales V2 (already correct)
Top comparison = derived reconciliation
If reconciliation missing ‚Üí derive on read
‚ùå No ‚ÄúSync required‚Äù message
‚ùå No hidden state
‚úÖ COMPLETION CRITERIA (DO NOT STOP EARLY)
This patch is ONLY complete when:
Selecting a date always shows data
Sync button is optional, not required
No 500 errors anywhere
Warnings explain missing data clearly
Daily Sales totals and POS totals visibly reconcile
Page never blocks the user
üîí FINAL LOCK STATEMENT
Sales & Shift Analysis is financial infrastructure, not a feature.
It must be:
Automatic
Defensive
Predictable
Boring
Fix the contract.
Then we polish UI.