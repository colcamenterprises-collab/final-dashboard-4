ğŸ”´ PHASE M â€” RECEIPTS TRUTH SUMMARY (PRODUCTION PATCH)
MODE: EXECUTE IMMEDIATELY
PRIORITY: CRITICAL
SCOPE: BACKEND + MINIMAL UI (NEW PAGE ONLY)
GOAL: Receipts are the truth. This page proves it.
ğŸ¯ OBJECTIVE
Create a Receipts Summary system that:
Summarises every receipt for a business date
Shows exactly what was sold
Stores a locked daily batch summary
Feeds all analysis, reconciliation, and audits
Makes missing data visible immediately
If numbers are wrong anywhere else, this page is where the error lives.
ğŸš« ABSOLUTE RULES
âŒ Do NOT modify Daily Sales, Purchasing, Recipes, POS ingestion
âŒ Do NOT infer, estimate, or â€œfixâ€ data
âŒ Do NOT hide missing data
âŒ Do NOT change existing pages
âœ… ADD new tables
âœ… ADD new services
âœ… ADD new API routes
âœ… ADD one new Analysis page
ğŸ§± PHASE M1 â€” DATABASE (ADD ONLY)
1ï¸âƒ£ receipt_batch_summary
Copy code
Sql
CREATE TABLE receipt_batch_summary (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  business_date DATE NOT NULL UNIQUE,
  shift_start TIMESTAMP NOT NULL,
  shift_end TIMESTAMP NOT NULL,

  receipt_count INTEGER NOT NULL,
  line_item_count INTEGER NOT NULL,

  gross_sales NUMERIC NOT NULL,
  net_sales NUMERIC NOT NULL,

  created_at TIMESTAMP DEFAULT now()
);
2ï¸âƒ£ receipt_batch_items
Copy code
Sql
CREATE TABLE receipt_batch_items (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  batch_id UUID REFERENCES receipt_batch_summary(id) ON DELETE CASCADE,

  category TEXT,
  sku TEXT,
  item_name TEXT,
  modifiers TEXT,

  quantity NUMERIC NOT NULL,
  gross_sales NUMERIC NOT NULL,
  net_sales NUMERIC NOT NULL
);
âš™ï¸ PHASE M2 â€” BACKEND SERVICE
Create:
Copy code

server/services/receiptBatchSummary.ts
Execution logic (STRICT):
Resolve business date â†’ 18:00 â†’ 03:00
Query lv_receipt + receipt line items
If 0 receipts â†’ THROW ERROR
Aggregate:
Total receipts
Total line items
Gross / net sales
Item + modifier rollups
Delete existing batch for that date
Insert fresh batch + items
Return summary
â— NO fallback. NO silent success.
ğŸŒ PHASE M3 â€” API ROUTES
Add:
ğŸ” Rebuild batch
Copy code

POST /api/analysis/receipts/rebuild
Body: { business_date: "YYYY-MM-DD" }
Deletes existing batch
Recomputes from receipts
Fails loudly if receipts missing
ğŸ“Š Get batch summary
Copy code

GET /api/analysis/receipts/summary?date=YYYY-MM-DD
Returns:
Copy code
Json
{
  "business_date": "2025-12-13",
  "receipt_count": 87,
  "line_item_count": 143,
  "gross_sales": 15420,
  "net_sales": 14890,
  "items": [
    {
      "category": "Smash Burgers",
      "item": "Single Smash Burger",
      "modifiers": "No Pickles, Extra Cheese",
      "quantity": 19,
      "gross_sales": 3230
    }
  ]
}
ğŸ§© PHASE M4 â€” UI PAGE (MINIMAL, READ-ONLY)
Route
Copy code

/analysis/receipts
Sidebar
Add under ANALYSIS:
Copy code

Receipts (Truth)
Page Layout (NO DESIGN EXPERIMENTS)
Header
Business Date selector
Receipt count
Gross / Net sales
â€œRebuild from Receiptsâ€ button
Table
Category
Item
Modifiers
Quantity
Gross sales
Banner Logic
âŒ If no batch â†’ RED banner:
â€œNO RECEIPT BATCH â€” TRUTH MISSINGâ€
âŒ If rebuild fails â†’ RED banner with error
âœ… If exists â†’ GREEN:
â€œReceipt truth confirmedâ€
ğŸ” PHASE M5 â€” OWNERSHIP RULE
Add inline note (top of page):
Receipts are the single source of truth.
All sales, stock, and ingredient analysis must reconcile to this page.
âœ… ACCEPTANCE CRITERIA (NON-NEGOTIABLE)
[ ] Batch rebuild works for historical dates
[ ] Receipt count matches Loyverse export (like the file Cam provided)
[ ] Item quantities match raw receipt data
[ ] Missing receipts are visible immediately
[ ] No other system modified
[ ] No UI regressions
ğŸ§  FINAL NOTE TO AGENT
If receipt numbers do not match POS exports, STOP and report.
Do not â€œfixâ€ downstream systems.
Truth lives here.