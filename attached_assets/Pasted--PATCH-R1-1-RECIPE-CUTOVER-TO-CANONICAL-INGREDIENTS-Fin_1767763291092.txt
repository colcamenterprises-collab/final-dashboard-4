üîê PATCH R1.1 ‚Äî RECIPE CUTOVER TO CANONICAL INGREDIENTS
Finalise decoupling. Fix recipe screen & maths permanently.
‚ö†Ô∏è AGENT RULES
‚ùå DO NOT query purchasing tables in recipes
‚ùå DO NOT display purchase info in recipe UI
‚ùå DO NOT convert units at runtime
‚úÖ Recipes use canonical ingredients ONLY
‚úÖ Cost = unit_cost_per_base √ó portion_qty
1Ô∏è‚É£ BACKEND ‚Äî RECIPE COST (FINAL)
File: server/services/recipeCost.service.ts
üëâ REPLACE ENTIRE COST RESOLUTION
Copy code
Ts
import { db } from "@/db";
import { recipeIngredient, ingredient } from "@/shared/schema";
import { eq } from "drizzle-orm";

export async function calculateRecipeCost(recipeId: string) {
  const rows = await db
    .select({
      qty: recipeIngredient.portionQty,
      unitCost: ingredient.unitCostPerBase,
    })
    .from(recipeIngredient)
    .innerJoin(
      ingredient,
      eq(recipeIngredient.ingredientId, ingredient.id)
    )
    .where(eq(recipeIngredient.recipeId, recipeId));

  let total = 0;

  for (const row of rows) {
    const line = Number(row.qty) * Number(row.unitCost);

    if (!Number.isFinite(line) || line < 0) {
      throw new Error("Invalid canonical ingredient cost");
    }

    total += line;
  }

  return Number(total.toFixed(2));
}
2Ô∏è‚É£ BACKEND ‚Äî REMOVE LEGACY JOINS
File: server/routes/recipes.ts
üëâ REMOVE ANY OF THE FOLLOWING IF PRESENT
Copy code
Ts
purchasingItem
purchaseUnit
purchaseUnitQty
unitPrice
supplier
Recipes must not reference purchasing in this file.
3Ô∏è‚É£ SCHEMA ‚Äî ENSURE RECIPE INGREDIENT IS CLEAN
File: shared/schema.ts
üëâ CONFIRM / ADJUST recipe_ingredient
Copy code
Ts
export const recipeIngredient = pgTable("recipe_ingredient", {
  id: uuid("id").defaultRandom().primaryKey(),

  recipeId: uuid("recipe_id").notNull(),
  ingredientId: uuid("ingredient_id").notNull(),

  portionQty: numeric("portion_qty", {
    precision: 10,
    scale: 4,
  }).notNull(),
});
‚ùå NO purchasing references
‚ùå NO portion units
4Ô∏è‚É£ UI ‚Äî RECIPE INGREDIENT LIST (HARD CUT)
File: client/src/components/recipes/RecipeEditModal.tsx
üëâ REPLACE INGREDIENT ROW RENDER
Copy code
Tsx
<tr>
  <td>{ing.name}</td>

  <td>
    <input
      type="number"
      value={ing.portionQty}
      min={0}
      step={0.01}
      onChange={(e) =>
        updateIngredient(index, {
          portionQty: Number(e.target.value),
        })
      }
    />
  </td>

  <td className="text-sm text-gray-500">
    {ing.baseUnit}
  </td>

  <td className="text-right">
    ‡∏ø{(ing.unitCostPerBase * ing.portionQty).toFixed(2)}
  </td>

  <td>
    <button onClick={() => removeIngredient(index)}>üóë</button>
  </td>
</tr>
5Ô∏è‚É£ UI ‚Äî REMOVE PURCHASE DISPLAY (CRITICAL)
File: RecipeEditModal.tsx
üëâ DELETE ANY UI THAT SHOWS
pack
bag
jar
servings
purchase
supplier
unit price from purchasing
The recipe screen must show:
Ingredient name
Portion qty
Base unit
Cost
Nothing else.
6Ô∏è‚É£ API ‚Äî INGREDIENT PICKER (CANONICAL)
File: client/src/components/recipes/AddIngredientRow.tsx
üëâ ENSURE INGREDIENT LIST COMES FROM
Copy code
Ts
GET /api/ingredients/canonical
And NOT purchasing endpoints.
7Ô∏è‚É£ REQUIRED RETEST (MANDATORY)
After this patch:
Bacon Scrap
unit_cost_per_base = 0.35
qty = 20
cost = ‡∏ø7.00
Crispy Fried Onions
unit_cost_per_base ‚âà 0.158
qty = 20
cost ‚âà ‡∏ø3.16
Cheese Sauce
must be grams OR ml
no servings anywhere
If any recipe shows a cost greater than pack cost ‚Üí STOP.
üîí PATCH R1.1 COMPLETE
This fully ends:
purchasing bleed-through
unit confusion
runtime conversions
random numbers
Recipes are now:
deterministic
auditable
safe for online ordering