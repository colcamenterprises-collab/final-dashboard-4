ğŸ”’ REPLIT AGENT PATCH â€” RECIPE INGREDIENT FLOW LOCKDOWN
PATCH NAME
PATCH-LOCK-RECIPE-INGREDIENT-FLOW-v1
STATUS
MANDATORY Â· NON-NEGOTIABLE Â· DO NOT DEVIATE
ğŸ¯ OBJECTIVE (LOCKDOWN)
Permanently lock the recipe builder so that:
â€œAdd Ingredientâ€ is UI-only
NO backend call occurs when adding ingredients
Ingredients are saved ONLY when â€œSave Recipeâ€ is clicked
No reference to ingredient_authority exists anywhere
Legacy ingredients are the single source of truth
This patch is defensive and architectural.
Future agents MUST NOT reinterpret or optimize this.
ğŸ” RULES (HARD LOCK)
âŒ ABSOLUTELY FORBIDDEN
âŒ Creating or referencing ingredient_authority
âŒ API calls on â€œAdd Ingredientâ€
âŒ Per-ingredient persistence
âŒ Mock ingredient data
âŒ Schema changes
âŒ Backend writes before Save Recipe
âŒ â€œOptimizingâ€ this flow
âœ… REQUIRED BEHAVIOR
âœ… Ingredient selection is read-only
âœ… Ingredient addition is local state only
âœ… Backend write happens once per recipe save
âœ… Mixed units supported (each / g / ml / etc.)
âœ… Costs calculated client-side, saved server-side
ğŸ“ FILES IN SCOPE (DO NOT EXPAND)
FRONTEND
Copy code

client/src/pages/menu/recipes/NewRecipe.tsx
client/src/pages/menu/recipes/RecipeEditor.tsx
BACKEND (READ-ONLY)
Copy code

server/routes/ingredients-legacy.ts
server/storage.ts
No other files may be modified.
ğŸ§  REQUIRED IMPLEMENTATION (AUTHORITATIVE)
1ï¸âƒ£ Ingredient Fetch (READ-ONLY)
Copy code
Ts
GET /api/ingredients/legacy
This endpoint is lookup only
No mutations
No transforms beyond mapping
2ï¸âƒ£ Add Ingredient (UI-ONLY)
When user clicks Add Ingredient:
Copy code
Ts
// MUST be local state only
setRecipeIngredients(prev => [
  ...prev,
  {
    name: ingredient.name,
    portionQty: 1,
    portionUnit: ingredient.defaultUnit ?? "each",
    unitCost: ingredient.unitPrice,
    calculatedCost: 0
  }
]);
ğŸš« NO fetch / POST / PUT allowed here
3ï¸âƒ£ Portion Unit MUST Be Editable
Portion unit dropdown/input MUST be editable
Examples that MUST work in the same recipe:
1 each Burger Bun
2 slice Cheese
90 g Beef Patty
20 g Mayo
ğŸš« Units must NOT default to grams globally
ğŸš« Units must NOT be locked
4ï¸âƒ£ Save Recipe (SINGLE WRITE)
Only when Save Recipe is clicked:
Copy code
Ts
POST /api/recipes
{
  name,
  yield,
  ingredients: [
    {
      name,
      portionQty,
      portionUnit,
      calculatedCost
    }
  ],
  totalCost
}
âœ” One payload
âœ” One write
âœ” Atomic
ğŸ§ª SUCCESS CRITERIA (MUST VERIFY)
Agent MUST verify all of the following before stopping:
âœ… Typing chee filters correctly (no full-match bug)
âœ… â€œAdd Ingredientâ€ NEVER triggers network request
âœ… Mixed units display correctly
âœ… No 400 errors possible during ingredient add
âœ… Recipe saves successfully
âœ… Reloading recipe preserves units & costs
âœ… No duplicate ingredient injection
âœ… No console errors
ğŸ›‘ PERMANENT COMMENT (ADD TO CODE)
Agent MUST add this comment verbatim near ingredient logic:
Copy code
Ts
/**
 * ğŸ”’ LOCKED RECIPE INGREDIENT FLOW
 * Ingredients are added via LOCAL STATE ONLY.
 * Do NOT introduce backend calls when adding ingredients.
 * Persistence occurs ONLY on Save Recipe.
 * Violating this will reintroduce 400 errors and broken recipes.
 */
ğŸ§  AGENT ACKNOWLEDGEMENT (REQUIRED)
Agent must explicitly state:
â€œI acknowledge that the recipe ingredient add flow is UI-only by design and must not be altered.â€
ğŸ“Œ FINAL STATE (WHAT THIS ACHIEVES)
One ingredient truth
One recipe write
Zero phantom tables
Zero backend coupling
Zero future regressions