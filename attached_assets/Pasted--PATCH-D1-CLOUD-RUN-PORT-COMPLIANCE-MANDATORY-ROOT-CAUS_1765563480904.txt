ğŸ”§ PATCH D1 â€” CLOUD RUN PORT COMPLIANCE (MANDATORY)

ROOT CAUSE (FACTS)

Cloud Run only allows ONE HTTP port, exposed as external port 80.

Your app currently violates this because:

Server listens on 3000

Replit forwards 3000 â†’ 4200

Another service still references 5000

Cloud Run expects ONE process listening on $PORT, mapped to 80


This causes health check failure even though the app â€œrunsâ€.


---

âœ… CORRECT CLOUD RUN RULE (NON-NEGOTIABLE)

Your server must:

Listen on process.env.PORT

Default to 8080 (Cloud Run standard)

Expose ONE port only

Replit must forward that port â†’ external 80



---

ğŸ› ï¸ EXACT FIX â€” AGENT INSTRUCTIONS

Copy-paste verbatim to the Replit agent.


---

ğŸ”’ RULES

âŒ Do NOT change frontend

âŒ Do NOT add ports

âŒ Do NOT run background services before server starts

âœ… ONLY do whatâ€™s listed



---

STEP 1 â€” FIX SERVER PORT (CRITICAL)

Open:

server/index.ts

Find any app.listen(...).

Replace with exactly this:

const PORT = Number(process.env.PORT) || 8080;

app.listen(PORT, () => {
  console.log(`âœ… Server listening on port ${PORT}`);
});

â— Remove all other hardcoded ports (3000, 5000, etc.)


---

STEP 2 â€” VERIFY NO SECOND LISTENER EXISTS

Run:

grep -R "listen(" -n server

Expected result:

ONE app.listen

If more â†’ STOP and remove extras



---

STEP 3 â€” FIX .replit PORT FORWARDING

Open:

.replit

You MUST have exactly one port mapping:

[[ports]]
localPort = 8080
externalPort = 80

âŒ Remove:

Any port 3000

Any port 4200

Any port 5000

Any second [[ports]] block



---

STEP 4 â€” ENSURE START COMMAND IS CLEAN

Verify package.json:

"scripts": {
  "build": "vite build",
  "start": "node dist/index.js"
}

âŒ No concurrently âŒ No dev servers âŒ No secondary processes


---

STEP 5 â€” REBUILD (REQUIRED)

rm -rf dist
npm run build

Verify:

ls dist/public/index.html


---

STEP 6 â€” DEPLOY

1. Replit â†’ Deploy


2. Click Publish


3. Wait for green success




---

âœ… EXPECTED RESULT

After this patch:

Cloud Run health checks PASS

App responds on external port 80

Frontend loads correctly

POS / Menu / Dashboard routes work



---

ğŸš¨ WHY THIS MUST BE DONE THIS WAY

Cloud Run does not care what Replit â€œruns successfullyâ€.

It ONLY checks:

Is HTTP responding on port 80

From one process

On one port


Right now you violate all three.

This patch fixes all three, permanently.


---

AFTER DEPLOY â€” TELL ME:

Reply with one line only:

> â€œDeploy passed / still failedâ€


