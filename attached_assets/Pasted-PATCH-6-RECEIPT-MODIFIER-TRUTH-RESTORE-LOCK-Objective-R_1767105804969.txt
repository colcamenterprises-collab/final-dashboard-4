PATCH 6 ‚Äî RECEIPT MODIFIER TRUTH (RESTORE & LOCK)
Objective
Restore Modifiers to Receipts (Truth) using Loyverse API only, with:
Full visibility
Correct counts
Correct price impact
Traceability to receipt + line item
Zero guessing
No hiding. No derivation. No DB shortcuts.
üîí NON-NEGOTIABLE RULES (FOR REPLIT AGENT)
SOURCE OF TRUTH
Modifiers MUST come from lv_receipt.raw_json.line_items[].modifiers[]
OR directly from live Loyverse API payload
‚ùå Never inferred
‚ùå Never recalculated
NO DELETIONS
Do NOT delete existing tables, endpoints, or UI
Only add missing functionality
FAIL LOUD
If modifiers missing ‚Üí show NO MODIFIER DATA FOUND
Do NOT suppress or hide sections
1Ô∏è‚É£ BACKEND ‚Äî MODIFIER TRUTH TABLE
Table (Additive Only)
Copy code
Sql
receipt_truth_modifier
----------------------
id UUID PK
business_date DATE
receipt_id TEXT
line_item_id TEXT
modifier_name TEXT
modifier_qty NUMERIC
modifier_price NUMERIC
modifier_total NUMERIC
source TEXT DEFAULT 'LOYVERSE_API'
created_at TIMESTAMPTZ
2Ô∏è‚É£ BACKEND ‚Äî MODIFIER EXTRACTION LOGIC
Source
From each receipt:
Copy code
Json
line_items[].modifiers[]
Extraction Rules
For every modifier:
modifier_name ‚Üí exact string from Loyverse
modifier_qty ‚Üí default 1 if missing
modifier_price ‚Üí from Loyverse (0 allowed)
modifier_total = qty √ó price
Linked to:
receipt_id
line_item_id
business_date
üö´ If no modifiers on an item ‚Üí do nothing
üö´ If modifier array missing ‚Üí log warning
3Ô∏è‚É£ API ENDPOINTS (ADD ONLY)
Rebuild Modifiers (API-Only)
Copy code

POST /api/analysis/receipts-truth/modifiers/rebuild
Pulls fresh data from Loyverse API
Rebuilds per business date
Writes to receipt_truth_modifier
Read Modifiers
Copy code

GET /api/analysis/receipts-truth/modifiers?date=YYYY-MM-DD
Returns:
Copy code
Json
{
  "totalModifiers": 62,
  "uniqueModifiers": 23,
  "modifiers": [
    {
      "name": "‚ùå NO PICKLES",
      "count": 6,
      "totalValue": 0
    },
    {
      "name": "ü•ì Crispy Bacon",
      "count": 6,
      "totalValue": 180
    }
  ]
}
4Ô∏è‚É£ UI ‚Äî RECEIPTS (TRUTH) PAGE (RESTORE SECTION)
Restore Modifiers Tab
Placed next to Items / Categories
Display:
Modifier name
Count used
Total price impact
Linked receipt count
Example:
Copy code

Modifiers (62 total)

ü•ì Crispy Bacon        √ó6     ‡∏ø180
‚ùå NO PICKLES         √ó6     ‡∏ø0
üêÑ Animal Style       √ó5     ‡∏ø0
Coke Zero             √ó6     ‡∏ø240
Status Banner Logic
üü¢ MODIFIER TRUTH CONFIRMED
üî¥ NO MODIFIERS FOUND (if none)
üü† MODIFIERS NOT BUILT (if rebuild not run)
5Ô∏è‚É£ ACCEPTANCE CRITERIA (YOU VERIFY WITH YOUR EYES)
For Dec 29:
Modifier counts match Loyverse receipt exports
Free modifiers (NO PICKLES etc.) show qty but 0 value
Paid modifiers (bacon, cheese, drinks in meals) show value
Totals reconcile with Gross Sales
If numbers are wrong ‚Üí error is visible on this page, nowhere else.
WHY THIS FIX IS CORRECT
The agent removed the modifier section because they couldn‚Äôt reconcile it
That was the wrong move
Modifiers are first-class POS truth
They affect:
Food usage
Margin
Fraud detection
Ingredient reconciliation
We restore them exactly as sold, not as guessed.