PATCH 12 ‚Äî IMPLEMENTATION (COPY-PASTE FOR REPLIT AGENT)
1Ô∏è‚É£ BACKEND ‚Äî FIX EXPENSE CREATE (SOURCE OF TRUTH)
File: server/routes/businessExpenses.ts
ENFORCE REQUIRED FIELDS
Copy code
Ts
if (!amount || !date || !category || !supplier) {
  return res.status(400).json({
    error: "Missing required expense fields"
  });
}
NORMALIZE AMOUNT (CRITICAL)
Copy code
Ts
const normalizedAmount = Number(amount);
if (Number.isNaN(normalizedAmount)) {
  return res.status(400).json({ error: "Invalid amount" });
}
WRITE EXPENSE (NO SIDE EFFECTS)
Copy code
Ts
const expense = await db.businessExpense.create({
  data: {
    date,
    supplier,
    category,
    description: description ?? null,
    amount: normalizedAmount,
    source: "MANUAL",
    createdAt: new Date()
  }
});
RETURN CREATED RECORD
Copy code
Ts
return res.json({ success: true, expense });
üö´ DO NOT write to P&L here
üö´ DO NOT mutate other tables
2Ô∏è‚É£ BACKEND ‚Äî P&L DERIVATION (READ-ONLY, DETERMINISTIC)
File: server/services/pnlService.ts
P&L MUST DERIVE FROM:
Sales ‚Üí receipt truth tables
Expenses ‚Üí businessExpense
Wages ‚Üí shift wages table
Copy code
Ts
totalExpenses =
  SUM(businessExpense.amount)
+ SUM(shiftExpenses.amount)
+ SUM(wages.amount);
NO UI CALCULATIONS ALLOWED
3Ô∏è‚É£ FRONTEND ‚Äî EXPENSE MODAL FIX
File: client/src/components/ExpenseModal.tsx
ENSURE PAYLOAD MATCHES BACKEND
Copy code
Ts
{
  date,
  supplier,
  category,
  description,
  amount: Number(amount)
}
ON SUCCESS
Copy code
Ts
onSuccess();
invalidateQuery(["expenses"]);
invalidateQuery(["pnl"]);
ON ERROR
Copy code
Ts
toast.error(response.error ?? "Failed to save expense");
4Ô∏è‚É£ FRONTEND ‚Äî HOME PAGE (P&L ONLY)
File: client/src/pages/Home.tsx
üö´ REMOVE any:
direct expense queries
cached totals
client-side math
‚úÖ ONLY:
Copy code
Ts
GET /api/pnl/summary
Home page must never calculate money.
5Ô∏è‚É£ GUARARDS (LOCK IT DOWN)
ADD ASSERTIONS
Expense modal cannot submit without required fields
Backend rejects malformed payloads loudly
P&L endpoint throws if source tables empty
ACCEPTANCE CRITERIA (ALL MUST PASS)
‚úÖ Expense modal submits without 500
‚úÖ Expense appears in Expenses table immediately
‚úÖ P&L updates automatically (no refresh hacks)
‚úÖ Home dashboard reflects new totals
‚úÖ No receipt logic touched
‚úÖ No schema drift
‚úÖ No silent fallback paths