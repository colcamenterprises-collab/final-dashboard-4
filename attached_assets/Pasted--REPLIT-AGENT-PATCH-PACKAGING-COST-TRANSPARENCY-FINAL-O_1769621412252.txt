üîß REPLIT AGENT PATCH ‚Äî PACKAGING & COST TRANSPARENCY (FINAL)
OBJECTIVE
Make ingredient costing correct, transparent, and production-safe, including packaging items (boxes, bags, packs of 50, etc.), with no changes to recipe math or schema.
HARD RULES (DO NOT BREAK)
‚ùå Do NOT change recipe cost math
‚ùå Do NOT add or modify database schema
‚ùå Do NOT store cost inside recipes
‚ùå Do NOT introduce syncing or caching
‚ùå Do NOT add new ingredient tables
‚ùå Do NOT touch POS, stock ledgers, or history
PATCH SCOPE (FILES ALLOWED)
Backend
server/utils/computeUnitCostPerBase.ts (or equivalent helper)
server/routes/ingredients.ts
server/controllers/ingredientsController.ts (if present)
Frontend
client/src/pages/menu/IngredientManagement.tsx
client/src/pages/menu/RecipeEditor.tsx
PATCH 1 ‚Äî SERVER: UNIT COST NORMALIZATION (MANDATORY)
File
server/utils/computeUnitCostPerBase.ts
REQUIRED LOGIC (FULL REPLACEMENT)
Copy code
Ts
export function computeUnitCostPerBase(
  costTHB: number,
  packagingQty: number | null,
  unit: string
): number {
  if (!costTHB || costTHB <= 0) return 0;

  const normalizedUnit = unit?.toLowerCase().trim();

  // EACH-based items (packaging, buns, bags, etc.)
  if (normalizedUnit === 'each') {
    if (!packagingQty || packagingQty <= 0) return costTHB;
    return costTHB / packagingQty;
  }

  // Weight-based
  if (normalizedUnit === 'kg') {
    return costTHB / 1000;
  }

  if (normalizedUnit === 'g') {
    return costTHB;
  }

  // Volume-based
  if (normalizedUnit === 'litre' || normalizedUnit === 'l') {
    return costTHB / 1000;
  }

  if (normalizedUnit === 'ml') {
    return costTHB;
  }

  // Fallback (no conversion)
  return costTHB;
}
PATCH 2 ‚Äî SERVER: INGREDIENT API MUST RETURN TRANSPARENT COST DATA
File
server/routes/ingredients.ts
REQUIRED RESPONSE FIELDS (DO NOT OMIT)
For each ingredient returned by /api/ingredients, ensure response includes:
Copy code
Ts
{
  id,
  name,
  category,
  supplier,
  costTHB,
  packagingQty,
  unit,
  unitCostPerBase, // computed via computeUnitCostPerBase
}
‚ùó unitCostPerBase must be computed server-side
‚ùó Frontend must NOT recompute
PATCH 3 ‚Äî FRONTEND: INGREDIENT MANAGEMENT (VISIBILITY)
File
client/src/pages/menu/IngredientManagement.tsx
REQUIRED UI (DISPLAY ONLY)
For every ingredient row, show:
Copy code

Purchase:
‡∏ø{costTHB} / {packagingQty} {unit}

Cost Breakdown:
‚Üí ‡∏ø{unitCostPerBase} per base unit
Packaging Example
Copy code

‡∏ø250 / box of 50 (each)
‚Üí ‡∏ø5.00 per item
Weight Example
Copy code

‡∏ø29 / 1kg
‚Üí ‡∏ø0.029 per gram
‚ùå No editing logic changes
‚ùå No recalculation on frontend
PATCH 4 ‚Äî FRONTEND: RECIPE EDITOR COST BREAKDOWN PANEL
File
client/src/pages/menu/RecipeEditor.tsx
ADD READ-ONLY PANEL PER INGREDIENT LINE
Display the following (derived from API data):
Copy code

Ingredient: Onion
Purchase: ‡∏ø29 / 1kg
Base cost: ‡∏ø0.029 per gram
Quantity used: 29 g
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Line cost: ‡∏ø0.84
‚ùå No logic changes
‚ùå No local math beyond qty √ó unitCostPerBase
‚ùå No persistence
PATCH 5 ‚Äî VALIDATION GUARD (NON-BLOCKING)
Location
Ingredient Management UI
If:
unit === 'each'
packagingQty <= 1
Show warning text (UI only):
Copy code

‚ö† Packaging item has no quantity breakdown
‚úî Allow save
‚ùå Do NOT block
ACCEPTANCE TESTS (MUST PASS)
Packaging
Box of 50 bags @ ‡∏ø250
‚Üí unitCostPerBase = ‡∏ø5
‚Üí Recipe uses 2 ‚Üí ‡∏ø10
Weight
Onion 1kg @ ‡∏ø29
‚Üí unitCostPerBase = ‡∏ø0.029
‚Üí Recipe uses 100g ‚Üí ‡∏ø2.90
Live Propagation
Change ingredient price
‚Üí All recipe totals update immediately
‚Üí No reload required
FINAL CHECK
No schema changes
No new tables
No broken routes
No styling regressions
Cost math unchanged
Cost visibility restored
‚úÖ EXECUTE THIS PATCH AS-IS
‚ùå DO NOT IMPROVISE
‚ùå DO NOT ADD FEATURES
Once this lands, the system is trustworthy again.