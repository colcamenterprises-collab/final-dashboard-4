ğŸ” PATCH 4 â€” RECEIPT ITEM CATEGORIZATION & AGGREGATION (LOCKED)
ğŸ¯ Objective (Non-Negotiable)
Expose human-verifiable, itemized receipt truth in the Receipts (Truth) page:
Categorised items (Burgers / Sides / Drinks / Meal Deals)
Aggregated counts per item
Modifier counts separated
Backdatable by date (â‰¥ 2024-07-01)
No hidden logic
No DB-derived sales math
No guessing
This must match what existed in F&B Analysis, but now driven from Receipt Truth (PATCH 1â€“3).
ğŸš« Absolute Prohibitions
The agent MUST NOT:
Derive totals from lv_receipt, lv_line_item, or any analytics table
Auto-categorise based on string heuristics
Collapse modifiers into items
Write to or delete existing receipt truth tables
Change PATCH 1â€“3 logic
Introduce fallback logic
If data is missing â†’ show it missing
ğŸ§± Data Sources (LOCKED)
READ-ONLY SOURCES ONLY
receipt_truth_line
receipt_truth_modifier
receipt_truth_summary
No other tables allowed.
ğŸ§© Step 1 â€” Canonical Category Mapping (VISIBLE + EDITABLE)
Create table (additive only):
Copy code
Sql
receipt_truth_category_map
--------------------------------
id (uuid, pk)
pos_category_name (text, unique)
canonical_category (enum)
created_at
Canonical categories (ENUM):
Copy code

BURGERS
SIDES
DRINKS
MEAL_DEALS
OTHER
Rules:
Category comes from POS category, not item name
If unmapped â†’ OTHER
UI must surface unmapped categories clearly
ğŸ§© Step 2 â€” Aggregated Item View (THE CORE ASK)
Create derived table (rebuildable, not hand-edited):
Copy code
Sql
receipt_truth_item_aggregate
--------------------------------
business_date (date)
canonical_category
item_name
total_quantity
gross_amount
Build logic (STRICT):
Source: receipt_truth_line
Group by:
business_date
canonical_category
item_name
Quantity = SUM(line.quantity)
Gross = SUM(line.gross_amount)
Do not merge modifiers
Refund receipts already excluded by PATCH 1
ğŸ§© Step 3 â€” Modifier Aggregation (SEPARATE)
Create derived table:
Copy code
Sql
receipt_truth_modifier_aggregate
--------------------------------
business_date
modifier_name
total_quantity
Rules:
Source: receipt_truth_modifier
One modifier = one count
Zero-price modifiers INCLUDED
No modifier is ever collapsed into an item
ğŸ§© Step 4 â€” UI: Receipts (Truth) Page Expansion
Add sections (IN THIS ORDER):
1ï¸âƒ£ Item Summary by Category
Example display:
Copy code

BURGERS
- Single Smash Burger â€” 15
- Double Smash Burger â€” 11

SIDES
- French Fries â€” 28
- Cajun Fries â€” 9

DRINKS
- Coke â€” 7
- Sprite â€” 5
2ï¸âƒ£ Modifier Summary
Example:
Copy code

Modifiers
- Animal Style â€” 12
- No Pickles â€” 9
- Extra Cheese â€” 6
3ï¸âƒ£ Totals by Category (Counts Only)
Copy code

Total Burgers Sold: 42
Total Side Orders: 51
Total Drinks: 19
Total Meal Deals: 17
ğŸ§© Step 5 â€” Backdating Support (MANDATORY)
Date picker must allow:
Any date â‰¥ 2024-07-01
Rebuild must:
Recompute item + modifier aggregates for that date
UI must clearly show:
â€œData rebuilt from receipts for YYYY-MM-DDâ€
ğŸ§ª Acceptance Criteria (THESE ARE BINARY)
âœ… I can visually confirm:
Counts per item
Counts per modifier
Category totals
Across multiple dates in December
And earlier months (July â†’ now)
âŒ If anything is:
Lumped as â€œUncategorizedâ€
Missing without explanation
Not visible in UI
â†’ Patch is considered FAILED
ğŸ§  Design Principle (DO NOT DEVIATE)
Receipts are the truth.
Aggregation is allowed.
Interpretation is not.
ğŸ“¦ Deliverables
The agent must deliver:
Schema changes (additive only)
Rebuild logic
UI updates to /analysis/receipts
No changes elsewhere
ğŸ›‘ Stop Condition
Once PATCH 4 is live and verified by eye, we stop.
Only after you sign this off, we proceed to:
Ingredient expansion confidence
Stock reconciliation
Variance detection