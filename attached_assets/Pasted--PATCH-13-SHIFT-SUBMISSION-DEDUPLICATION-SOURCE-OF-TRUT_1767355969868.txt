ğŸ”’ PATCH 13 â€” SHIFT SUBMISSION DEDUPLICATION & SOURCE-OF-TRUTH LOCK
ğŸš¨ The Problem (Root Cause)
Youâ€™re seeing:
Daily Sales & Stock V2 Form 1 submitted twice
Library shows two records
Shift expenses duplicated
P&L inflated
Shopping list & cost signals corrupted
This means the system currently allows multiple authoritative submissions for the same shift.
That is unacceptable for an accounting / ops system.
ğŸ¯ PATCH 13 OBJECTIVE (NON-NEGOTIABLE)
For any given business day + shift window, there must be ONE and ONLY ONE authoritative Form 1 submission.
Everything else must be:
Rejected, or
Explicitly treated as a revision, never a duplicate
ğŸ§± WHAT PATCH 13 WILL DO (EXACTLY)
1ï¸âƒ£ Define a Shift Identity
We formally define a shift as:
Copy code

restaurant_id
+ shift_date (YYYY-MM-DD)
+ shift_type ('DAILY_SALES_V2')
This becomes immutable truth.
2ï¸âƒ£ Database-Level Protection (Critical)
We add a UNIQUE CONSTRAINT so duplicates are physically impossible.
Why this matters
UI bugs
Double clicks
Network retries
Agent misfires
Zapier retries
None of these can ever create duplicates again.
3ï¸âƒ£ Backend Enforcement Logic
When Form 1 is submitted:
If NO shift exists
âœ… Create new record
âœ… Mark as authoritative = true
If shift already exists
âŒ Reject with 409 Conflict â¡ï¸ Clear message:
â€œDaily Sales already submitted for this shift.â€
(No silent overwrites. No second rows.)
4ï¸âƒ£ Expense Deduplication Safety
Shift expenses are currently being:
Inserted per submission
Without checking shift ownership
Patch 13 will:
Attach expenses to the shift ID
Prevent re-insertion if shift already finalized
This stops:
Double wages
Double shopping
Inflated P&L
5ï¸âƒ£ Library Cleanup (UI Truth)
In the Form Library:
Only the authoritative submission is shown
Any legacy duplicates are:
Marked superseded
Hidden from totals
Still auditable (nothing deleted)
6ï¸âƒ£ Forward Compatibility (Important)
This patch sets the foundation for:
PATCH 14: Shift ingredient usage truth
PATCH 15: Variance detection
PATCH 16: Theft / leakage alerts
Without this, none of those can be trusted.
ğŸ§  WHY THIS IS MARKET-LEADING
Most POS / restaurant systems:
Allow silent duplicates
â€œHopeâ€ the staff doesnâ€™t double-submit
Fix it manually later
This system:
Prevents the error
Explains the rejection
Locks financial truth at the source
Thatâ€™s enterprise-grade ops.
ğŸ“¦ REPLIT AGENT â€” SINGLE DROP-IN PATCH INSTRUCTION
Below is exactly what you asked for.
ğŸ” REPLIT AGENT PATCH â€” PATCH 13
PATCH NAME:
PATCH_13_SHIFT_DEDUPLICATION_LOCK
OBJECTIVE:
Ensure only one authoritative Daily Sales & Stock V2 (Form 1) submission exists per shift. Prevent duplicate expenses, duplicate P&L impact, and duplicate library entries.
ğŸ”’ DATABASE (REQUIRED)
Add a unique constraint to the Daily Sales table:
Copy code
Sql
CREATE UNIQUE INDEX IF NOT EXISTS unique_daily_sales_shift
ON daily_sales
(restaurant_id, shift_date, shift_type);
ğŸ”§ BACKEND â€” FORM 1 SUBMIT HANDLER
Before creating a new Daily Sales record:
Query by (restaurant_id, shift_date, shift_type)
If record exists:
Return HTTP 409 Conflict
Message: "Daily Sales already submitted for this shift"
If no record exists:
Create record
Set:
authoritative = true
submitted_at = now()
ğŸ’° SHIFT EXPENSE HANDLING
When inserting shift expenses:
Require shift_id
If shift already has expenses:
Do NOT insert again
Log warning
Return success without duplication
ğŸ“š FORM LIBRARY
Only show:
authoritative = true
superseded = false
Any legacy duplicates:
Mark superseded = true
Exclude from totals, P&L, shopping list
ğŸš« ABSOLUTE PROHIBITIONS
âŒ Do NOT delete historical records
âŒ Do NOT auto-merge duplicates
âŒ Do NOT touch receipt ingestion
âŒ Do NOT touch ingredient logic
âœ… ACCEPTANCE CRITERIA
Submitting Form 1 twice for same date â†’ blocked
Expenses appear once
P&L correct
Library shows one entry per shift
System remains auditable
Cam â€” once PATCH 13 is in:
Youâ€™ve locked financial truth
PATCH 14 (Sold Items â†’ Ingredient Usage) becomes safe to execute
Variance detection becomes real, not theoretical
When youâ€™re ready, Iâ€™ll design PATCH 14 at the same level â€” deterministic, auditable, zero fluff.
Youâ€™re doing this the right way now.