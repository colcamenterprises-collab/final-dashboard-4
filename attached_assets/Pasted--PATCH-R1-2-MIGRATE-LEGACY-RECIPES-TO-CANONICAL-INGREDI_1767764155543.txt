üîê PATCH R1.2 ‚Äî MIGRATE LEGACY RECIPES TO CANONICAL INGREDIENTS
‚ö†Ô∏è AGENT RULES
‚ùå DO NOT change purchasing
‚ùå DO NOT change ingredient costs
‚ùå DO NOT change recipe math
‚úÖ One-time data migration only
‚úÖ Idempotent (safe to re-run)
1Ô∏è‚É£ DATABASE ‚Äî ADD TEMP SAFETY INDEX (OPTIONAL BUT SAFE)
File: shared/schema.ts
üëâ ADD (if not present)
Copy code
Ts
import { index } from "drizzle-orm/pg-core";

index("idx_recipe_ingredient_purchasing")
  .on(recipeIngredient.purchasingItemId);
2Ô∏è‚É£ MIGRATION SCRIPT (CORE)
File: server/scripts/migrateLegacyRecipeIngredients.ts
üëâ CREATE FILE
Copy code
Ts
import { db } from "@/db";
import {
  recipeIngredient,
  ingredient,
} from "@/shared/schema";
import { eq, isNull } from "drizzle-orm";

/**
 * Migrates legacy recipe ingredients that reference purchasingItemId
 * to canonical ingredientId.
 *
 * SAFE TO RE-RUN.
 */
async function migrate() {
  const legacyRows = await db
    .select()
    .from(recipeIngredient)
    .where(isNull(recipeIngredient.ingredientId));

  console.log(`Found ${legacyRows.length} legacy recipe ingredients`);

  for (const row of legacyRows) {
    if (!row.purchasingItemId) continue;

    const ing = await db
      .select()
      .from(ingredient)
      .where(
        eq(
          ingredient.sourcePurchasingItemId,
          row.purchasingItemId
        )
      )
      .then((r) => r[0]);

    if (!ing) {
      console.warn(
        `No canonical ingredient for purchasingItemId ${row.purchasingItemId}`
      );
      continue;
    }

    await db
      .update(recipeIngredient)
      .set({
        ingredientId: ing.id,
      })
      .where(eq(recipeIngredient.id, row.id));
  }

  console.log("Legacy recipe migration complete");
}

migrate()
  .then(() => process.exit(0))
  .catch((err) => {
    console.error(err);
    process.exit(1);
  });
3Ô∏è‚É£ RUN MIGRATION (ONE-TIME)
Command
Copy code

npx ts-node server/scripts/migrateLegacyRecipeIngredients.ts
Expected output:
Copy code

Found XX legacy recipe ingredients
Legacy recipe migration complete
4Ô∏è‚É£ POST-MIGRATION VERIFICATION (MANDATORY)
SQL CHECK
Copy code
Sql
SELECT COUNT(*) 
FROM recipe_ingredient
WHERE ingredient_id IS NULL;
Expected:
Copy code

0
5Ô∏è‚É£ LOCK LEGACY PATH (AFTER CONFIRMATION)
File: shared/schema.ts
üëâ MAKE ingredientId REQUIRED
Copy code
Ts
ingredientId: uuid("ingredient_id").notNull(),
File: server/services/recipeAuthority.ts
üëâ REMOVE legacy fallback
‚ùå Remove purchasingItemId handling
‚ùå Remove dual-format support
(Do not do this until verification passes.)
6Ô∏è‚É£ REQUIRED FINAL RETEST
Edit existing recipes
Change portion qty
Cost updates correctly
No references to purchasing anywhere
No unit confusion