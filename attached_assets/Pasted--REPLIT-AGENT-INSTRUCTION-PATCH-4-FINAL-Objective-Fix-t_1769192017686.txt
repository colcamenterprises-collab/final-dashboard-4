ğŸ”’ REPLIT AGENT INSTRUCTION â€” PATCH 4 (FINAL)
Objective
Fix the â€œAdd Ingredientâ€ button in the New Recipe Builder so it works correctly with the legacy ingredient system without touching backend logic, schema, or cost calculations.
Ingredient search and visibility are already correct.
This patch fixes the 400 error on Add Ingredient only.
ğŸš¨ RULES (NON-NEGOTIABLE)
âŒ DO NOT modify backend routes
âŒ DO NOT modify schema
âŒ DO NOT introduce ingredient IDs
âŒ DO NOT change cost logic
âŒ DO NOT add writes to ingredient tables
âŒ DO NOT refactor layout or UI
âœ… FRONTEND ONLY
âœ… SINGLE PATCH
âœ… COPY-PASTE SAFE
ğŸ”§ ROOT CAUSE (FOR CONTEXT ONLY â€” DO NOT â€œFIXâ€ BACKEND)
The Add Ingredient button still posts the old contract (ingredientId) while the UI now uses legacy name-based ingredients, causing a 400 error.
The backend already supports name-based ingredient adds (legacy behavior).
We must translate on the frontend, not change the backend.
ğŸ¯ FILE TO UPDATE
Copy code

client/src/pages/menu/recipes/NewRecipe.tsx
If the filename differs slightly, update only the add-ingredient click handler, not layout, styling, or surrounding logic.
ğŸ” REQUIRED CHANGE (FULL REPLACEMENT)
Locate the Add Ingredient click handler
It will look similar to this:
Copy code
Ts
onClick={() => addIngredient(item)}
ğŸ”„ REPLACE IT WITH THIS EXACT LOGIC
Copy code
Ts
onClick={async () => {
  try {
    await fetch(`/api/recipes/${recipeId}/ingredients`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        ingredientName: item.name,   // âœ… name-based (legacy-compatible)
        quantity: 1,
        unit: item.unit,
      }),
    });

    // Refresh recipe ingredients list
    await reloadRecipe();
  } catch (err) {
    console.error("Failed to add ingredient", err);
  }
}}
ğŸ§ª REQUIRED VERIFICATION (MANDATORY)
After applying the patch:
Go to:
Copy code

/menu/recipes/new
Search:
Copy code

cheese
Click Add Ingredient
âœ… No error
âœ… Ingredient appears in table
Enter:
Copy code

95g
Cost should calculate to approximately:
Copy code

à¸¿30.3
âœ… ACCEPTANCE CRITERIA (ALL MUST PASS)
âœ… Ingredient search works
âœ… â€œAdd Ingredientâ€ does NOT throw 400
âœ… Ingredient appears immediately in table
âœ… Cost math unchanged
âœ… No backend files modified
âœ… No schema changes
âœ… No new endpoints
âœ… No regressions in /menu/recipes/:id
ğŸ§± FINAL STATE AFTER THIS PATCH
Single ingredient truth
Canonical read path
Legacy-compatible write path
New + old recipe pages aligned
Zero backend risk
Locked system
ğŸ“¢ COMPLETION RESPONSE (ONE LINE ONLY)
When finished, respond with:
â€œAdd Ingredient now worksâ€