ğŸ”§ PATCH 11 â€” EXPENSES WRITE PATH FIX (CRITICAL)
ğŸ¯ Objective
Fix the 500 error when lodging Business Expenses so this workflow works end-to-end:
Expenses Modal â†’ Expenses Table â†’ P&L â†’ Home Dashboard
No side effects. No receipt logic touched.
ğŸš¨ Confirmed Problem
UI submits expense correctly
Backend returns:
500 {"error":"Failed to create expense"}
Result:
Expense NOT saved
Expenses table NOT updated
P&L NOT updated
Home dashboard shows zero / stale data
This is a broken write path, not a UI issue.
ğŸ”’ Rules (Non-Negotiable)
âŒ Do NOT touch receipts
âŒ Do NOT touch recipes
âŒ Do NOT touch ingredients
âŒ Do NOT modify schema unless explicitly listed
âœ… Fix ONLY expense creation + propagation
ğŸ§± Root Cause (Whatâ€™s Actually Broken)
One or more of the following (agent must verify, not guess):
Amount parsing bug
Frontend sends "501.30" (string)
Backend expects number
Prisma / SQL rejects it
Missing required field
Common offenders:
businessDate
category
supplier
source = BUSINESS
Transaction not committed
Expense insert succeeds
P&L derivation never runs
âœ… Required Fixes (MANDATORY)
1ï¸âƒ£ Backend: Expense Create Endpoint
File: server/routes/expenses.ts (or equivalent)
Enforce strict input handling:
Copy code
Ts
const amount = Number(req.body.amount);
if (isNaN(amount)) {
  return res.status(400).json({ error: "Invalid amount" });
}
Ensure required fields exist:
Copy code
Ts
if (!req.body.date || !req.body.category || !req.body.supplier) {
  return res.status(400).json({ error: "Missing required fields" });
}
2ï¸âƒ£ Ensure Expense Is Written Correctly
Expense must insert into:
expenses (or business_expenses)
Required fields:
date
amount
category
supplier
description
source = 'BUSINESS'
No silent defaults.
3ï¸âƒ£ Trigger P&L Update (CRITICAL)
Immediately after expense insert:
Either:
Call existing P&L rebuild function
OR
Insert into derived P&L table if thatâ€™s the architecture
âš ï¸ If this step is skipped, the Home page will NEVER update.
4ï¸âƒ£ Frontend: Modal Submission Safety
File: client/src/components/ExpenseModal.tsx (or similar)
Before POST:
Copy code
Ts
amount: Number(amount)
Do not send strings.
5ï¸âƒ£ Error Transparency
If insert fails:
Backend must return real Prisma / SQL error
Frontend must display it (not generic â€œFailed to create expenseâ€)
ğŸ§ª Acceptance Tests (Agent MUST Verify)
âœ… Create Business Expense â†’ Success toast
âœ… Expense appears in Expenses table immediately
âœ… P&L updates (MTD / YTD not zero)
âœ… Home dashboard reflects updated P&L
âœ… No 500 errors
âœ… No console errors
âœ… Reload page â†’ data persists
ğŸš« Explicitly Out of Scope
Receipts
Shopping list
Recipes
Ingredients
Modifiers
UI redesign
ğŸ“¦ Deliverable
One patch
Minimal diff
No refactors
No assumptions