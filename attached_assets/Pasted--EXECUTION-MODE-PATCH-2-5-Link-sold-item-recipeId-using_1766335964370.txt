ğŸ” EXECUTION MODE â€” PATCH 2.5
Link sold_item â†’ recipeId using existing mappings
ğŸ¯ OBJECTIVE
Populate sold_item.recipeId during derivation by reusing existing mapping logic:
Copy code

POS SKU
 â†’ ExternalSkuMap
 â†’ internal menu item
 â†’ menu_item_recipes_v3
 â†’ recipeId
After this:
Patch 2 (ingredient usage) will immediately populate
No guessing
No heuristics
No schema changes
ğŸš¨ ABSOLUTE RULES (AGENT MUST FOLLOW)
âŒ DO NOT add new tables
âŒ DO NOT change schema
âŒ DO NOT change existing mapping tables
âŒ DO NOT infer recipes by name
âŒ DO NOT touch UI
âŒ DO NOT modify Patch 2 or Patch 3 logic
âœ… ONLY modify the SoldItem derivation service
âœ… Use existing tables only
âœ… If mapping not found â†’ leave recipeId = null
ğŸ“ FILE TO MODIFY (ONLY THIS FILE)
Copy code

server/services/soldItemDeriver.ts
ğŸ”§ CHANGE REQUIRED (MINIMAL DIFF)
1ï¸âƒ£ Import Prisma + mapping tables (if not already)
At the top (adjust import path if needed):
Copy code
Ts
import { prisma } from "../db";
2ï¸âƒ£ Add this helper function inside the file
Copy code
Ts
async function resolveRecipeIdFromSku(
  sku: string | null,
  channel: string
): Promise<string | null> {
  if (!sku) return null;

  // POS SKU â†’ internal item
  const skuMap = await prisma.externalSkuMap.findFirst({
    where: {
      channel,
      channelSku: sku
    }
  });

  if (!skuMap) return null;

  // internal item â†’ recipe
  const recipe = await prisma.menuItemRecipeV3.findFirst({
    where: {
      menuItemId: skuMap.internalId
    }
  });

  return recipe?.recipeId ?? null;
}
âš ï¸ Notes:
Uses existing tables only
No fallback logic
One-to-one mapping only
3ï¸âƒ£ Modify the soldItem.create block
BEFORE (current):
Copy code
Ts
recipeId: null,
AFTER (replace with):
Copy code
Ts
recipeId: await resolveRecipeIdFromSku(
  item.sku,
  item.receipt.provider
),
Thatâ€™s it.
No other changes.
ğŸ” REQUIRED REBUILD SEQUENCE (IN THIS ORDER)
The agent must run these commands in order:
1ï¸âƒ£ Rebuild sold items (with recipe linking):
Copy code

node server/scripts/rebuildSoldItems.ts
2ï¸âƒ£ Rebuild ingredient usage:
Copy code

node server/scripts/rebuildIngredientUsage.ts
3ï¸âƒ£ Rebuild reconciliation (optional but recommended):
Copy code

node server/scripts/rebuildReconciliation.ts
âœ… EXPECTED RESULTS (VALIDATION CHECK)
After rebuilds:
sold_item:
recipeId populated for mapped menu items
recipeId = null for unmapped items (expected)
shift_ingredient_usage:
NOW > 0 rows
Ingredient quantities populated
Units preserved exactly from recipe definitions
No crashes
No UI changes
Deterministic on re-run
ğŸ›‘ STOP CONDITION
After completion, the agent must STOP and report:
Number of sold_item rows with recipeId NOT NULL
Number of shift_ingredient_usage rows created
Any SKUs that failed to map (count only)