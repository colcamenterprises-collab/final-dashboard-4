üîí PATCH 1.6.16 ‚Äî PURCHASING vs INGREDIENT COST MODEL (LOCKDOWN)
üéØ OBJECTIVE (NON-NEGOTIABLE)
Fix the core economic model of the system:
Purchasing List = how items are bought (packs, cartons, kg, boxes)
Ingredients / Recipes = how items are consumed (grams, units, portions)
NO portion math is allowed in Purchasing
ALL portion math lives in Ingredients / Recipes ONLY
This patch corrects pricing, units, and logic across:
Purchasing List
Shopping List
Ingredient Costing
Recipe Cost Totals
üö´ ABSOLUTE PROHIBITIONS (AGENT MUST FOLLOW)
‚ùå DO NOT add portion sizes to Purchasing
‚ùå DO NOT calculate per-gram / per-ml costs in Purchasing
‚ùå DO NOT infer units automatically
‚ùå DO NOT modify receipt logic
‚ùå DO NOT touch sales, modifiers, or shift truth logic
‚ùå DO NOT change schema unless explicitly stated below
üß± CANONICAL MODEL (LOCK THIS IN)
1Ô∏è‚É£ PURCHASING ITEMS (SOURCE OF TRUTH)
Each purchasing item represents exactly what is bought from a supplier.
Required fields (existing or enforced):
Copy code

purchasing_items
- id
- name
- supplier
- sku
- purchase_unit_label   (e.g. "1kg bag", "Box of 50", "24-pack")
- purchase_unit_qty     (numeric, e.g. 1, 50, 24)
- unit_cost             (TOTAL cost of that pack)
‚úÖ unit_cost = price of the whole pack ‚ùå Not price per gram ‚ùå Not price per portion
Examples:
Fries: 100 baht ‚Üí 2kg bag
Coke: 300 baht ‚Üí 24 cans
Burger buns: 8 baht ‚Üí 1 bun
2Ô∏è‚É£ SHOPPING LIST LOGIC (FIX + LOCK)
The Shopping List must:
Use ONLY purchasing_items.unit_cost
Multiply:
Copy code

line_total = qty * unit_cost
Where:
qty = number of packs / cartons / kg to buy
NEVER portions
NEVER grams
üõë REMOVE any use of:
grams
ml
recipe quantities
ingredient yields
3Ô∏è‚É£ SYSTEM-GENERATED ITEMS (MEAT + ROLLS)
MEAT RULE (LOCKED)
Target stock per shift: 16kg
Source: Daily Stock Form V2 ‚Üí end_meat_kg
Formula:
Copy code

to_buy_kg = max(0, 16 - end_meat_kg)
Shopping List entry:
Copy code

Item: Topside Beef
Purchase Unit: 1kg
Qty: to_buy_kg
Unit Cost: price per 1kg (from purchasing_items)
‚ùå NO averaging
‚ùå NO freezing logic
‚ùå NO portion logic
ROLLS RULE (LOCKED)
Target stock: 140 buns
Source: Daily Stock Form V2 ‚Üí end_roll_count
Formula:
Copy code

to_buy_buns = max(0, 140 - end_roll_count)
Shopping List entry:
Copy code

Item: Burger Bun
Purchase Unit: 1 bun
Qty: to_buy_buns
Unit Cost: 8 baht
4Ô∏è‚É£ INGREDIENT COSTING (WHERE PORTIONS BELONG)
Ingredients MUST reference purchasing items and perform portion math here only.
Ingredient fields (already present ‚Äî enforce usage):
Copy code

ingredients
- id
- purchasing_item_id
- portion_qty        (e.g. 150)
- portion_unit       (g, ml, unit)
Cost calculation:
Copy code

ingredient_unit_cost = purchasing.unit_cost / purchasing.purchase_unit_qty
ingredient_cost = ingredient_unit_cost * portion_qty
Examples:
Fries:
Purchase: 2kg bag = 100 baht
Portion: 150g
Cost: (100 / 2000) * 150 = 7.5 baht
5Ô∏è‚É£ RECIPE MODAL FIX (MANDATORY)
UI Change (Recipe Edit Modal)
Rename:
‚ùå ‚ÄúQty‚Äù
‚úÖ ‚ÄúPortion Size‚Äù
Display:
Portion Unit (g / ml / unit)
Portion Cost (calculated, read-only)
Total Recipe Cost
Sum of ingredient_cost
NEVER derived from Purchasing directly
6Ô∏è‚É£ FILES TO TOUCH (ONLY THESE)
Backend
server/services/shoppingListService.ts
server/services/ingredientCostService.ts (if exists)
server/services/recipeCostService.ts
Frontend
client/src/pages/ShoppingList.tsx
client/src/components/RecipeEditModal.tsx
7Ô∏è‚É£ ACCEPTANCE CRITERIA (MUST PASS)
‚úÖ Shopping List shows:
Only pack-based prices
Correct totals
No grams / ml anywhere
‚úÖ Recipe cost:
Cajun Fries ‚â† ‡∏ø19,350
Cajun Fries ‚âà portion-based cost
‚úÖ Ingredients persist correctly
‚úÖ No schema corruption
‚úÖ No sales / receipt changes
‚úÖ No modifier impact
üîê FINAL NOTE TO AGENT
This patch defines the economic spine of the platform.
Once applied:
Purchasing = Buying Reality
Ingredients = Consumption Reality
Recipes = Cost Truth
Shopping List = Actionable Procurement
No future patch is allowed to blur these boundaries.