üîß REPLIT AGENT ‚Äî FINAL COSTING & RECIPE SYSTEM FIX (AUTHORITATIVE)
CONTEXT (DO NOT IGNORE)
The current ingredient + recipe system is mathematically unstable because it pretends yield is exact.
This patch introduces explicit yield modeling with variance, which is how real kitchens work.
This is not a redesign ‚Äî it is a correction.
HARD RULES (NON-NEGOTIABLE)
‚ùå Do NOT infer yield from text
‚ùå Do NOT auto-parse ‚Äúbox of 50‚Äù
‚ùå Do NOT require manual yield entry for deterministic units
‚ùå Do NOT change POS ingestion
‚ùå Do NOT change purchasing list structure
‚ùå Do NOT add new ingredient tables
‚úÖ Use existing ingredient table
‚úÖ Make uncertainty explicit
‚úÖ Make math transparent
‚úÖ Make UI useful
CORE CONCEPT TO IMPLEMENT
Every ingredient has a Yield Method:
Copy code

DIRECT       ‚Üí math is exact (kg, g, ml, each)
ESTIMATED    ‚Üí requires average + variance (rasher, slice, ring, fillet)
PATCH 1 ‚Äî INGREDIENT DATA MODEL (NO NEW TABLE)
Extend the existing ingredient model with the following fields:
Copy code
Ts
yieldMethod: 'DIRECT' | 'ESTIMATED'          // REQUIRED
baseUnit: 'g' | 'ml' | 'each'                // REQUIRED
purchaseQty: number                          // existing
purchaseUnit: 'kg' | 'g' | 'l' | 'ml' | 'each'
purchaseCostTHB: number                     // existing

// ONLY used when yieldMethod = ESTIMATED
avgPortionSize?: number                     // e.g. 14
portionUnit?: 'rasher' | 'slice' | 'ring'   // free text enum
variancePct?: number                        // e.g. 10 (%)
‚ö†Ô∏è Do not backfill fake values
‚ö†Ô∏è Leave estimated fields NULL until user enters them
PATCH 2 ‚Äî YIELD CALCULATION LOGIC (SERVER ONLY)
Create / update utility:
Copy code

server/utils/computeYield.ts
Rules:
DIRECT
Copy code

unitCostPerBase =
  purchaseCostTHB / (purchaseQty converted to baseUnit)
ESTIMATED
Copy code

avgPortionWeight = avgPortionSize
minPortionWeight = avg * (1 - variancePct / 100)
maxPortionWeight = avg * (1 + variancePct / 100)

yieldCountAvg = totalBaseQty / avgPortionWeight
Return all three values:
avg
min
max
üö´ Never collapse this to one number.
PATCH 3 ‚Äî INGREDIENT MANAGEMENT UI (FIX IT PROPERLY)
Route:
Copy code

/menu-management/ingredients
Table MUST show:
Column
Content
Ingredient
Name + supplier
Purchase
‡∏ø / qty / unit
Yield Type
DIRECT or ESTIMATED (badge)
Portion
e.g. ‚Äú14g per rasher (¬±10%)‚Äù
Yield
‚Äú~71 rashers (64‚Äì78)‚Äù
Cost
‚Äú‡∏øX per rasher‚Äù
Actions
Edit / Hide
Edit Modal Logic
If DIRECT:
Hide portion fields completely
If ESTIMATED:
Require:
Avg portion size
Portion unit
Variance %
üö´ No auto-calculation üö´ No guessing üö´ No blocking save ‚Äî but show warning if missing
PATCH 4 ‚Äî RECIPE EDITOR (THIS IS WHERE IT WAS WRONG)
For each ingredient line:
Display (READ-ONLY, VISUAL):
Copy code

Ingredient: Bacon (rasher)
Avg cost: ‡∏ø4.20 per rasher
Expected range: ‡∏ø3.80 ‚Äì ‡∏ø4.60

Quantity used: 2 rashers

Line cost:
- Avg: ‡∏ø8.40
- Range: ‡∏ø7.60 ‚Äì ‡∏ø9.20
Recipe Total MUST show:
Copy code

Total Cost (avg): ‡∏ø38.20
Expected Range: ‡∏ø34.90 ‚Äì ‡∏ø41.10
This is the entire point of a costing system.
PATCH 5 ‚Äî SHIFT USAGE (NO POS CHANGE)
When aggregating usage:
Use avg for reporting
Use min/max for variance detection
Example:
Copy code

Sold: 100 burgers
Expected bacon usage:
- Min: 1.26kg
- Avg: 1.40kg
- Max: 1.54kg
Flag if actual usage falls outside range.
PATCH 6 ‚Äî UI QUALITY (NO MORE SPREADSHEET LOOK)
Minimum UI requirements:
Ingredient cards show:
Icon / photo
Yield badge
Cost confidence bar (green ‚Üí amber ‚Üí red)
Recipe page MUST have:
Image upload
Cost delta preview
‚ÄúIf price changes‚Äù simulation
No tables pretending to be Excel.
ACCEPTANCE TESTS (MUST PASS)
Bacon Example
Input:
Copy code

1kg bacon
Avg rasher: 14g
Variance: 10%
System shows:
Copy code

~71 rashers (64‚Äì78)
‡∏øX per rasher
Recipe Example
Copy code

2 rashers used
System shows:
Copy code

Avg: ‡∏øY
Range: ‡∏øY-10% ‚Üí ‡∏øY+10%
Change ingredient price
‚Üí Recipe updates instantly
‚Üí Range updates instantly
FINAL NOTE (READ THIS)
This patch stops fake precision
This patch models reality
This patch ends the guessing
If the agent deviates from this spec, stop immediately.