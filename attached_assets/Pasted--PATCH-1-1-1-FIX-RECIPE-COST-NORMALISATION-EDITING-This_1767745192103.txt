ğŸ” PATCH 1.1.1 â€” FIX RECIPE COST NORMALISATION + EDITING
This is a real patch. Copy/paste only.
âš ï¸ AGENT RULES
âŒ Do NOT touch purchasing
âŒ Do NOT touch modifiers
âŒ Do NOT change schema
âœ… Fix cost maths
âœ… Fix ingredient editing
âœ… No summaries
1ï¸âƒ£ FIX COST CALCULATION (CRITICAL)
File:
server/services/recipeCost.service.ts
ğŸ‘‰ REPLACE THE INGREDIENT COST LOGIC ENTIRELY
Copy code
Ts
function normalisePurchaseUnitQty(
  qty: number,
  unit: string
): number {
  if (unit === "grams" || unit === "ml") return qty;
  if (unit === "kg" || unit === "l") return qty * 1000;
  return qty; // each / serving
}

const purchaseQtyNormalised = normalisePurchaseUnitQty(
  Number(item.purchaseUnitQty),
  item.purchaseUnit
);

if (!purchaseQtyNormalised || purchaseQtyNormalised <= 0) {
  throw new Error(
    `Invalid purchase unit qty for item ${item.name}`
  );
}

const ingredientCost =
  (Number(item.unitCost) / purchaseQtyNormalised) *
  Number(ingredient.portionQty);
âŒ REMOVE any previous calculation
âŒ NO fallbacks
âŒ NO rounding hacks
2ï¸âƒ£ BLOCK INVALID COSTS (SAFETY)
Still in recipeCost.service.ts, ADD:
Copy code
Ts
if (ingredientCost > Number(item.unitCost)) {
  throw new Error(
    `Ingredient cost exceeds pack cost â€” unit mismatch`
  );
}
This guarantees à¸¿7,000 can never happen again.
3ï¸âƒ£ FIX INGREDIENT EDITING (UI STATE BUG)
File:
client/src/components/recipes/RecipeEditModal.tsx
ğŸ‘‰ FIND ingredient update handler and REPLACE
Copy code
Ts
const updateIngredient = (index: number, updates: any) => {
  setIngredients((prev) =>
    prev.map((ing, i) =>
      i === index ? { ...ing, ...updates } : ing
    )
  );
};
Ensure inputs call it properly:
Copy code
Tsx
<input
  type="number"
  value={ingredient.portionQty}
  onChange={(e) =>
    updateIngredient(index, {
      portionQty: Number(e.target.value),
    })
  }
/>

<select
  value={ingredient.portionUnit}
  onChange={(e) =>
    updateIngredient(index, {
      portionUnit: e.target.value,
    })
  }
>
âŒ Do NOT lock fields once added
âŒ Editing must be live
4ï¸âƒ£ REQUIRED RETEST (MANDATORY)
After patch:
Bacon scrap
1 kg @ à¸¿350
20 g â†’ à¸¿7.00 âœ…
Change 20 â†’ 40 â†’ cost updates live
Change grams â†’ each â†’ blocked
Editing works without delete/re-add