üîí REPLIT AGENT PATCH ‚Äî FOUNDATION: PURCHASING ‚Üí INGREDIENTS ‚Üí RECIPES (PHASE 1)
PATCH NAME
FOUNDATION-01: Canonical Ingredients From Purchasing Items
üéØ OBJECTIVE (NON-NEGOTIABLE)
Establish a single source of truth for ingredients by deriving them from the Purchasing List, without breaking:
POS sync
Daily forms
Purchasing
Shopping list
Analytics
This patch does NOT:
Rebuild recipes
Change costs
Modify Loyverse sync
Add analytics
Touch modifiers
üß† CANONICAL MODEL (LOCK THIS)
Copy code

Purchasing Items (MASTER)
 ‚îú‚îÄ isIngredient = false ‚Üí Non-food / ops items
 ‚îî‚îÄ isIngredient = true  ‚Üí Ingredients

Ingredients (VIEW, NOT SOURCE)
 ‚îî‚îÄ Derived from purchasing_items WHERE isIngredient = true

Recipes (NEXT PATCH)
 ‚îî‚îÄ Menu Item ‚Üí Ingredients ‚Üí Cost
üö´ ABSOLUTE PROHIBITIONS
The agent MUST NOT:
Create new purchasing tables
Duplicate ingredient costs
Introduce new recipe logic
Rename database tables
Delete any data
Backfill historical costs
Add UI features beyond what‚Äôs specified
‚úÖ PATCH SCOPE (WHAT TO DO)
PART A ‚Äî Database (SAFE, ADDITIVE ONLY)
1Ô∏è‚É£ Add ingredient flag to purchasing_items
SQL ONLY (no migrations tooling):
Copy code
Sql
ALTER TABLE purchasing_items
ADD COLUMN IF NOT EXISTS is_ingredient BOOLEAN DEFAULT false;
DO NOT
Remove columns
Change existing costs
Modify IDs
PART B ‚Äî Purchasing List UI (MANAGER ONLY)
2Ô∏è‚É£ Add ‚ÄúIngredient‚Äù toggle
Add a toggle/checkbox column:
Label: Ingredient
Binds to purchasing_items.is_ingredient
Visible to manager/admin only
Inline update (existing update endpoint)
Guard
If PRODUCTION_LOCK=1, toggling is allowed
Deletion still blocked (already implemented)
PART C ‚Äî INGREDIENTS MASTER (CONVERT TO VIEW)
3Ô∏è‚É£ Ingredients Master page MUST:
STOP using any standalone ingredient table
READ ONLY from:
Copy code
Sql
SELECT *
FROM purchasing_items
WHERE is_ingredient = true
ORDER BY category, item;
Editable fields (stored back onto purchasing_items):
Portion unit (g / ml / piece)
Portion size
Optional yield (nullable)
‚ùó Cost is NOT editable here
Cost remains owned by Purchasing List.
PART D ‚Äî UI COPY & CLARITY (CRITICAL)
4Ô∏è‚É£ Rename & clarify semantics (UI-only)
Current Label
Replace With
Recipes
Menu Recipes
‚ÄúNo ingredients‚Äù
No recipe defined
Ingredients Master
Ingredients (from Purchasing)
Add helper text (non-interactive):
‚ÄúIngredients are derived from your Purchasing List. Costs are managed centrally.‚Äù
No logic change.
PART E ‚Äî SAFETY GUARDS
5Ô∏è‚É£ Deletion Protection (REINFORCE)
A Purchasing Item cannot be deleted if:
is_ingredient = true
OR referenced by:
recipe_ingredients (future)
purchasing_shift_items (already exists)
Return:
Copy code
Json
{
  "error": "Item is in use and cannot be deleted"
}
PART F ‚Äî VERIFICATION ENDPOINT (READ-ONLY)
6Ô∏è‚É£ Add debug endpoint
Route
Copy code

GET /api/debug/ingredient-parity
Response
Copy code
Json
{
  "purchasingItems": 75,
  "ingredientItems": 42,
  "isDerived": true,
  "source": "purchasing_items.is_ingredient"
}
No writes.
No auth required (internal only).
‚úÖ ACCEPTANCE CRITERIA (MANDATORY)
The patch is ONLY accepted if:
[ ] Purchasing List shows Ingredient toggle
[ ] Ingredients Master shows ONLY flagged items
[ ] Ingredient cost matches Purchasing List exactly
[ ] No duplicated ingredient tables exist
[ ] No recipe logic changed
[ ] No analytics changed
[ ] No forms broken
[ ] /api/debug/ingredient-parity returns valid data
üß± WHAT THIS ENABLES NEXT (NOT IN THIS PATCH)
Future patches (explicitly out of scope now):
Recipe ingredient binding
Modifier cost logic
Per-item recipe cost rollups
Purchasing anomaly detection
One-click reorder
This patch unblocks all of them cleanly.
üîê FINAL NOTE TO AGENT (IMPORTANT)
This patch is foundational.
Do not optimize.
Do not refactor.
Do not ‚Äúimprove‚Äù UX beyond labels.
Implement exactly as specified.