üîê REPLIT AGENT ‚Äî FINAL PATCH
PATCH: P&L v1 (POS-Driven, Accurate, Locked)
GOAL
Make the Profit & Loss page numerically correct, POS-driven, and production-safe.
This patch fixes data accuracy, removes the header icon, and locks P&L v1 so downstream work (recipes, receipts, online ordering) can proceed safely.
üö´ ABSOLUTE RULES (DO NOT VIOLATE)
‚ùå Do NOT modify Daily Sales & Stock V2
‚ùå Do NOT modify Purchasing / Recipes
‚ùå Do NOT infer or estimate values
‚ùå Do NOT add Grab-specific logic yet
‚ùå Do NOT fabricate zeros
‚ùå Do NOT touch unrelated schemas
‚úÖ PATCH SCOPE (WHAT TO CHANGE)
1Ô∏è‚É£ BACKEND ‚Äî MAKE DATA ACCURATE
A. Sales (SOURCE OF TRUTH)
Sales must come only from POS / Loyverse.
If no POS data exists for a day ‚Üí
gross_sales = 0
net_sales = 0
data_status = 'MISSING'
NO fallback aggregation unless explicitly defined.
B. Expenses
Expenses must be real entries only:
Shift Expenses ‚Üí Daily Sales & Stock V2
Business Expenses ‚Üí expenses table
‚ùå No grouping by guess
‚ùå No default values
‚ùå No legacy aggregation
C. COGS
COGS rules (v1):
If recipe + sold items exist ‚Üí calculate
If recipe missing ‚Üí cogs = 0, data_status = 'PARTIAL'
Never infer food cost
D. pnl_read_model (AUTHORITATIVE)
For each date, write exactly one row:
Copy code

date
gross_sales
net_sales
cogs
gross_profit
operating_expenses
operating_income
non_operating_items
tax
net_income
data_status  // OK | PARTIAL | MISSING
Rebuild must be:
Deterministic
Idempotent
DELETE ‚Üí INSERT per date
2Ô∏è‚É£ API ‚Äî LOCK READ PATH
Required Endpoints
Copy code
Http
GET  /api/pnl/year?year=YYYY        // read-only
POST /api/pnl/rebuild-range         // admin only
Forbidden
‚ùå Any legacy aggregation in controllers
‚ùå Any inline calculation in routes
All logic lives in pnlReadModelService.
3Ô∏è‚É£ FRONTEND ‚Äî DISPLAY REALITY ONLY
A. Data Source
Profit & Loss page must read ONLY:
Copy code

/api/pnl/year
‚ùå No /api/profit-loss
‚ùå No client-side math
B. Header (FIX THIS NOW)
REMOVE THE ICON COMPLETELY
Change header from:
Copy code

üìà Profit & Loss
To:
Copy code

Profit & Loss Statement
Text only. No icons. No emojis.
C. Year Selector
Query years from DB (/api/pnl/years)
Default = latest available year
Must include 2026
D. Section Layout (DISPLAY ONLY WHAT EXISTS)
Copy code

REVENUE
  - POS Sales

COGS
  - Food COGS (if available)

GROSS PROFIT

OPERATING EXPENSES
  - Shift Expenses
  - Business Expenses

OPERATING INCOME

NET INCOME
If a section has no data, show ‚Äî (not 0).
E. Data Integrity Panel (MANDATORY)
Display:
Data Status
POS rows found
Expense rows found
COGS completeness
4Ô∏è‚É£ FINAL VERIFICATION (AGENT MUST CONFIRM)
Agent must explicitly verify:
‚úÖ January loads
‚úÖ Numbers match DB rows
‚úÖ No duplicated expenses
‚úÖ No fabricated sales
‚úÖ Rebuild run twice = identical result
‚úÖ UI shows negative values in red
‚úÖ Header icon removed
üì¶ DELIVERABLE
One clean patch
App builds
P&L numbers are boringly correct
No TODOs
No placeholders
No guesses
üîí STATUS AFTER THIS PATCH
P&L v1 is LOCKED
POS = single source of truth
Ready for:
Receipt ingestion
Recipe / food cost accuracy
Online ordering
Grab reconciliation later (v2)