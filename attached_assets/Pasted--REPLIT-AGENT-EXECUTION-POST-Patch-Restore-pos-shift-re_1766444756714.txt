ğŸ”§ REPLIT AGENT EXECUTION POST
Patch: Restore pos_shift_report Contract (Read-Only Fix)
Context (DO NOT CHANGE)
The application expects a relation named pos_shift_report
The database contains "PosShiftReport" (case-sensitive)
This mismatch breaks analytics, Daily Review UI, and Daily Review email
Data ingestion is working; reads are broken
This fix restores the contract without refactors or data mutation
ğŸ¯ OBJECTIVE
Restore compatibility by creating a read-only SQL VIEW named pos_shift_report that maps to "PosShiftReport".
ğŸ›‘ SAFETY RULES (MANDATORY)
âŒ Do NOT rename tables
âŒ Do NOT alter data
âŒ Do NOT modify ingestion code
âŒ Do NOT touch Prisma schema
âœ… ONLY create a SQL VIEW
âœ… This patch must be reversible and non-destructive
âœ… STEP 1 â€” Create Compatibility View
Run exactly this command:
Copy code
Bash
psql "$DATABASE_URL" <<'SQL'
CREATE OR REPLACE VIEW pos_shift_report AS
SELECT *
FROM "PosShiftReport";
SQL
âœ… STEP 2 â€” Verify View Exists and Has Data
Copy code
Bash
psql "$DATABASE_URL" -c "
SELECT shift_date, COUNT(*) AS rows
FROM pos_shift_report
GROUP BY shift_date
ORDER BY shift_date DESC
LIMIT 7;
"
Expected result:
At least one row returned.
If zero rows â†’ STOP and report.
âœ… STEP 3 â€” Verify View Matches Source Table
Copy code
Bash
psql "$DATABASE_URL" -c "
SELECT
  (SELECT COUNT(*) FROM \"PosShiftReport\") AS source_rows,
  (SELECT COUNT(*) FROM pos_shift_report) AS view_rows;
"
Expected: source_rows = view_rows
âœ… STEP 4 â€” Rebuild Dependent Derived Tables
Run ONLY these rebuilds:
Copy code
Bash
psql "$DATABASE_URL" -c "SELECT rebuild_shift_reconciliation(NULL);"
psql "$DATABASE_URL" -c "SELECT rebuild_daily_reports_v2(NULL);"
âš ï¸ If functions require a date instead of NULL, STOP and report function signature.
âœ… STEP 5 â€” (Optional) Trigger Daily Review Email
If manual runner exists:
Copy code
Bash
node server/scripts/sendDailyReviewEmail.ts --date=yesterday
If not available, SKIP.
ğŸ§ª SUCCESS CRITERIA
pos_shift_report query returns rows
Daily Review UI shows POS totals
Daily Review email includes POS data
No schema changes
No data mutation
ğŸ“Œ NOTES FOR RECORD
This fix restores a broken read contract
Ingestion was never the problem
This explains why shift reports worked previously
Long-term fix may include:
migration-backed view
casing guard test
explicit DB contract documentation
ğŸš¨ STOP AFTER COMPLETION
Do not proceed to refactors or optimizations unless explicitly instructed.
When this is done, tell me:
âœ… Step 2 output (rows per date)
âŒ Any errors encountered