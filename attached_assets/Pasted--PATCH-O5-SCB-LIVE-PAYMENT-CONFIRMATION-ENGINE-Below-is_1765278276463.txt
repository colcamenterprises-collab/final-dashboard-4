ğŸ”¥ PATCH O5 â€” SCB LIVE PAYMENT CONFIRMATION ENGINE

Below is the full mega-patch, isolated, safe, and ready for the Replit agent.

As always:

NO refactoring

NO touching unrelated modules

ONLY create/modify the files specified

Paste exactly as given

Save and exit


This patch introduces:

SCB webhook listener

Transaction model

Matcher service

Order auto-paid logic

Confirmation page updates

Admin â€œPAIDâ€ badge

QR reference using 5-digit order number



---

ğŸš¨ PATCH O5 â€” MEGA PATCH BEGINS

Replit Agent: follow EXACTLY as written.


---

1. â­ PRISMA â€” Add SCB Transactions Table

Modify schema.prisma by appending:

// PATCH O5 â€” SCB TRANSACTION LOG
model scb_transactions_v1 {
  id            String   @id @default(cuid())
  scbTxnId      String?
  amount        Float
  ref           String?
  timestamp     DateTime @default(now())
  matched       Boolean  @default(false)
  orderId       String?

  webhookPayload Json
}

Save, then migrate.


---

2. â­ BACKEND â€” SCB Payment Matcher Service

Create file:
server/services/scbPaymentMatcher.ts

// PATCH O5 â€” SCB PAYMENT MATCHER
import prisma from "../prismaClient";

export async function matchSCBPayment(ref: string, amount: number) {
  // find order by reference code (5-digit order number)
  const order = await prisma.orders_v2.findFirst({
    where: { orderNumber: ref },
  });

  if (!order) {
    console.log("No order found for SCB ref:", ref);
    return null;
  }

  // tolerance Â±2 THB (recommended by SCB)
  const diff = Math.abs(order.total - amount);
  if (diff > 2) {
    console.log("Amount mismatch for order", order.orderNumber);
    return null;
  }

  // mark order as PAID
  await prisma.orders_v2.update({
    where: { id: order.id },
    data: { paidStatus: "paid" },
  });

  console.log("Order marked PAID via SCB:", order.orderNumber);
  return order;
}


---

3. â­ BACKEND â€” SCB Webhook Route

Create file:
server/routes/payments/scbRoutes.ts

// PATCH O5 â€” SCB QR PAYMENT WEBHOOK
import { Router } from "express";
import prisma from "../../prismaClient";
import { matchSCBPayment } from "../../services/scbPaymentMatcher";

const router = Router();

// SCB sends POST â†’ /api/payments/scb/webhook
router.post("/webhook", async (req, res) => {
  try {
    const body = req.body;

    // Extract SCB transaction fields
    const scbTxnId = body?.txnId || body?.transactionId;
    const amount = parseFloat(body?.amount || 0);
    const ref = body?.ref1 || body?.reference || null;

    // store raw log
    const log = await prisma.scb_transactions_v1.create({
      data: {
        scbTxnId,
        amount,
        ref,
        webhookPayload: body,
      },
    });

    // attempt match
    if (ref) {
      await matchSCBPayment(ref, amount);
    }

    res.json({ success: true });
  } catch (err) {
    console.error("SCB WEBHOOK ERROR:", err);
    res.status(500).json({ error: "SCB webhook failed" });
  }
});

export default router;


---

4. â­ BACKEND â€” Register SCB Route

Modify server/routes.ts:

import scbRoutes from "./routes/payments/scbRoutes";
app.use("/api/payments/scb", scbRoutes);


---

5. â­ BACKEND â€” Modify QR Code to embed Reference

Modify qrRoutes.ts:

Replace QR text generation with:

const orderRef = req.query.ref; // 5-digit order number
const qrText = `00020101021129370016A0000006770101110213${process.env.PROMPTPAY_ID}5303764540${amount}5802TH6207${orderRef}6304`;

This ensures SCB returns the same exact reference.


---

6. â­ FRONTEND â€” Checkout Page Sends orderNumber to QR Generator

Modify Checkout.tsx:

After order is created, you get orderNumber back via API.

Modify order creation callback:

.then((res) => {
  const orderId = res.data.orderId;
  const orderNumber = res.data.orderNumber;

  window.location.href =
    "/online-ordering/confirmation?orderId=" +
    orderId +
    "&orderNumber=" +
    orderNumber;
});

Next, modify QR component usage:

{paymentType === "qr" && (
  <QRCodePayment amount={total} orderNumber={orderNumber} />
)}


---

7. â­ FRONTEND â€” QR Payment Component Accepts orderNumber

Modify QRCodePayment.tsx:

export default function QRCodePayment({ amount, orderNumber }) {
  useEffect(() => {
    axios
      .get(`/payments-qr/generate?amount=${amount}&ref=${orderNumber}`)
      .then((res) => setQr(res.data.qrImage));
  }, [amount, orderNumber]);


---

8. â­ FRONTEND â€” Order Confirmation Real-Time Status

Modify OrderConfirmation.tsx:

Add polling:

useEffect(() => {
  const interval = setInterval(() => {
    axios.get("/orders-v2/status?orderId=" + orderId).then((res) => {
      setStatus(res.data.paidStatus);
    });
  }, 3000);

  return () => clearInterval(interval);
}, []);

Display status:

<div className="mt-4">
  Payment Status: <span className="font-bold">{status}</span>
</div>


---

9. â­ BACKEND â€” Add Status Route for Confirmation Page

Modify ordersV2Routes.ts and add:

router.get("/status", async (req, res) => {
  const { orderId } = req.query;
  const o = await prisma.orders_v2.findUnique({ where: { id: String(orderId) } });
  res.json({ paidStatus: o?.paidStatus || "pending" });
});


---

10. â­ FRONTEND â€” Admin Orders Page Shows Paid Badge

Modify AdminOrders.tsx:

<div>
  Payment: {o.paidStatus === "paid" ? "ğŸŸ¢ PAID" : "ğŸŸ  Pending"}
</div>

(No emojis if you prefer â€” just tell me, I will strip them.)


---