
---

ðŸš€ **PATCH O14 â€” CHUNK 2/5

MULTI-TENANT AUTHENTICATION + RESTAURANT USERS**

This patch introduces:

Restaurant-scoped user accounts

Role system

Secure JWT login

Staff PIN login preserved for POS

API protection for future SaaS mode

NO IMPACT on SBB operations

Tenant = 1 for Smash Brothers Burgers


This is the core of SaaS user management.


---

ðŸ§± 1. DATABASE â€” ADD RESTAURANT USER ACCOUNTS

Modify schema.prisma (additive only):

model restaurant_users {
  id            Int       @id @default(autoincrement())
  restaurantId  Int
  email         String    @unique
  passwordHash  String
  role          String    // owner, manager, staff, pos
  createdAt     DateTime  @default(now())

  restaurant    restaurants @relation(fields: [restaurantId], references: [id])
}

âš ï¸ DO NOT TOUCH ANY OTHER MODELS.
This is isolated and safe.


---

ðŸ§± 2. BACKEND â€” AUTH SERVICE

Create file:

server/services/auth/authService.ts

import bcrypt from "bcryptjs";
import jwt from "jsonwebtoken";
import db from "../../db";

export const AuthService = {
  async register({ email, password, role = "manager", restaurantId }) {
    const passwordHash = await bcrypt.hash(password, 10);

    return db.restaurant_users.create({
      data: {
        email,
        passwordHash,
        role,
        restaurantId,
      }
    });
  },

  async login({ email, password }) {
    const user = await db.restaurant_users.findUnique({
      where: { email }
    });
    if (!user) return null;

    const match = await bcrypt.compare(password, user.passwordHash);
    if (!match) return null;

    const token = jwt.sign(
      {
        uid: user.id,
        restaurantId: user.restaurantId,
        role: user.role,
      },
      process.env.JWT_SECRET || "default_secret",
      { expiresIn: "7d" }
    );

    return { token, user };
  },

  verify(token) {
    try {
      return jwt.verify(token, process.env.JWT_SECRET || "default_secret");
    } catch {
      return null;
    }
  }
};


---

ðŸ§± 3. BACKEND â€” AUTH ROUTES

Create file:

server/routes/auth/authRoutes.ts

import express from "express";
import { AuthService } from "../../services/auth/authService";
const router = express.Router();

// REGISTER (Owner only when SaaS expands)
router.post("/register", async (req, res) => {
  const { email, password, role = "manager" } = req.body;

  try {
    const created = await AuthService.register({
      email,
      password,
      role,
      restaurantId: req.restaurantId, // SBB = 1
    });

    res.json({ success: true, user: created });
  } catch (e) {
    res.status(400).json({ error: e.message });
  }
});

// LOGIN
router.post("/login", async (req, res) => {
  const { email, password } = req.body;
  const result = await AuthService.login({ email, password });

  if (!result) {
    return res.status(401).json({ error: "Invalid credentials" });
  }

  res.json({
    success: true,
    token: result.token,
    user: result.user
  });
});

export default router;


---

ðŸ§± 4. REGISTER ROUTES

Modify only server/routes.ts:

import authRoutes from "./routes/auth/authRoutes";
app.use("/api/auth", authRoutes);


---

ðŸ§± 5. AUTH MIDDLEWARE (Protected APIs)

Create:

server/middleware/authGuard.ts

import { AuthService } from "../services/auth/authService";

export function authGuard(req, res, next) {
  const header = req.headers.authorization;

  if (!header) return res.status(401).json({ error: "No token" });

  const token = header.replace("Bearer ", "");
  const decoded = AuthService.verify(token);

  if (!decoded) return res.status(401).json({ error: "Invalid token" });

  req.user = decoded;
  req.restaurantId = decoded.restaurantId;

  next();
}

No existing routes are modified.
This is foundational only.


---

ðŸ§± 6. FRONTEND â€” BASIC LOGIN PAGE

Create:

client/src/pages/auth/Login.tsx

import React, { useState } from "react";
import axios from "../../utils/axiosInstance";

export default function Login() {
  const [email, setEmail] = useState("");
  const [password, setPassword] = useState("");

  const submit = async () => {
    const res = await axios.post("/api/auth/login", { email, password });
    localStorage.setItem("authToken", res.data.token);
    window.location.href = "/"; // dashboard
  };

  return (
    <div style={{ padding: 40 }}>
      <h1>Restaurant Login</h1>
      <input placeholder="Email" onChange={e => setEmail(e.target.value)} /><br/>
      <input placeholder="Password" type="password" onChange={e => setPassword(e.target.value)} /><br/>
      <button onClick={submit}>Login</button>
    </div>
  );
}


---

ðŸ§± 7. FRONTEND ROUTE REGISTRATION

Modify only client/src/App.tsx:

import Login from "./pages/auth/Login";

<Route path="/login" element={<Login />} />


---

ðŸ§± 8. TENANT + AUTH INITIAL SEED

Modify only server/index.ts:

After TenantScoped.ensureRestaurantExists() add:

async function seedDefaultManager() {
  const exists = await db.restaurant_users.findFirst({
    where: { email: "admin@sbb.com" }
  });

  if (!exists) {
    await AuthService.register({
      email: "admin@sbb.com",
      password: "sbb123",
      role: "owner",
      restaurantId: 1
    });
    console.log("Created default admin@sbb.com (password: sbb123)");
  }
}

seedDefaultManager();


---

ðŸŸ¢ CHUNK 2 DELIVERED

This adds:

âœ” Multi-tenant user accounts

âœ” Restaurant-scoped login

âœ” JWT auth

âœ” Authentication middleware

âœ” Safe default admin seed

âœ” No disturbance to SBB operations

âœ” POS PIN system untouched

âœ” All routes remain working

âœ” Ready for multi-location MRR SaaS expansion


---
