üîê REPLIT AGENT ‚Äî EXECUTE PATCH: P&L READ MODEL LIVE
üö® ABSOLUTE RULES
DO NOT refactor, rename, or ‚Äúimprove‚Äù anything
DO NOT touch Daily Sales V2, Expenses, Purchasing, or POS ingestion logic
DO NOT delete or modify existing tables
ADD ONLY what is missing
If a file already exists ‚Üí LEAVE IT
If something fails ‚Üí STOP AND REPORT
‚úÖ OBJECTIVE
Make the authoritative P&L system live using the pnl_read_model, with deterministic rebuilds and a working UI.
1Ô∏è‚É£ DATABASE ‚Äî CREATE READ MODEL TABLE (IF MISSING)
Run once. If table exists, SKIP.
Copy code
Sql
CREATE TABLE IF NOT EXISTS pnl_read_model (
  date DATE PRIMARY KEY,

  gross_sales NUMERIC NOT NULL DEFAULT 0,
  discounts NUMERIC NOT NULL DEFAULT 0,
  refunds NUMERIC NOT NULL DEFAULT 0,
  net_sales NUMERIC NOT NULL DEFAULT 0,

  shift_expenses NUMERIC NOT NULL DEFAULT 0,
  business_expenses NUMERIC NOT NULL DEFAULT 0,
  total_expenses NUMERIC NOT NULL DEFAULT 0,

  profit NUMERIC NOT NULL DEFAULT 0,

  data_status TEXT NOT NULL CHECK (data_status IN ('OK','PARTIAL','MISSING')),
  notes TEXT,

  rebuilt_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
2Ô∏è‚É£ BACKEND ‚Äî ENSURE ROUTES EXIST
Verify these files exist exactly:
Copy code

server/services/pnlReadModelService.ts
server/routes/pnlReadModel.ts
If missing, create them from Codex output already approved.
3Ô∏è‚É£ REGISTER ROUTES (ONLY IF NOT PRESENT)
In server/routes.ts:
Copy code
Ts
import pnlReadModelRoutes from "./routes/pnlReadModel";

app.use("/api/pnl", pnlReadModelRoutes);
‚ö†Ô∏è If /api/pnl is already registered ‚Üí DO NOTHING
4Ô∏è‚É£ REBUILD P&L DATA (AUTHORITATIVE STEP)
Run in Replit shell:
Copy code
Bash
npm run ts-node server/scripts/rebuildPnlReadModel.ts -- --from=2026-01-01 --to=TODAY
Expected:
No crashes
Deterministic rebuild
No fabricated data
5Ô∏è‚É£ FRONTEND ‚Äî USE READ MODEL ONLY
Confirm Profit & Loss page is loading data from:
Copy code

GET /api/pnl
and NOT:
legacy aggregations
inline calculations
mixed sources
If client/src/pages/ProfitLoss.tsx already does this ‚Üí DO NOTHING
6Ô∏è‚É£ FINAL VERIFICATION (MANDATORY)
Confirm manually:
/analysis/profit-loss loads
Dates return rows
Profit = Net Sales ‚àí Total Expenses
Data status shows OK / PARTIAL / MISSING
No numbers appear without a source
üõë STOP CONDITION
If any of the following occur:
Missing table
Missing route
Build error
Runtime exception
üëâ STOP IMMEDIATELY AND REPORT EXACT ERROR
‚úÖ END OF INSTRUCTION