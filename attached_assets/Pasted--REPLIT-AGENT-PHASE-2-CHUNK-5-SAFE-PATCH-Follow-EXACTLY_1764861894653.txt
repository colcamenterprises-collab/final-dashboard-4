üîí REPLIT AGENT ‚Äî PHASE 2 CHUNK 5 (SAFE PATCH)

‚ö†Ô∏è Follow EXACTLY.
‚ö†Ô∏è Create ONE new file.
‚ö†Ô∏è Modify ONE existing file (cron loader).
‚ö†Ô∏è Do NOT change anything else.


---

üß© FILE 1 ‚Äî CREATE

server/cron/dailyReportCron.ts

Careful: ONLY this file.

/**
 * DAILY REPORT CRON ‚Äî 3AM BANGKOK
 *
 * Automatically compiles the daily report, generates the PDF,
 * saves it, and emails it to SBB management.
 */

import cron from "node-cron";
import { DateTime } from "luxon";
import { compileDailyReportV2, saveDailyReportV2 } from "../services/dailyReportV2";
import { buildDailyReportPDF } from "../pdf/dailyReportV2.pdf";
import { sendDailyReportEmailV2 } from "../lib/dailyReportEmailV2";

export function registerDailyReportCron() {
  console.log("[CRON] Daily report cron registered (03:00 Asia/Bangkok)");

  cron.schedule(
    "0 3 * * *", // 3:00 AM
    async () => {
      try {
        const now = DateTime.now().setZone("Asia/Bangkok");
        const shiftDate = now.minus({ days: 1 }).toISODate();

        console.log(`[CRON] Running daily report for shiftDate=${shiftDate}`);

        // Compile JSON payload
        const reportJson = await compileDailyReportV2(shiftDate);
        if (reportJson.error) {
          console.warn(`[CRON] Report missing: ${reportJson.error}`);
          return;
        }

        // Build PDF
        const pdf = await buildDailyReportPDF(reportJson);

        // Save to DB
        const reportId = await saveDailyReportV2(reportJson);
        console.log(`[CRON] Saved report ID ${reportId}`);

        // Send email
        await sendDailyReportEmailV2(pdf, shiftDate);
        console.log(`[CRON] Email sent for ${shiftDate}`);
      } catch (err) {
        console.error("[CRON] ERROR during daily report:", err);
      }
    },
    {
      timezone: "Asia/Bangkok",
    }
  );
}


---

üß© FILE 2 ‚Äî MODIFY EXISTING FILE

Modify ONLY server/index.ts:

1. Add import at the top:



import { registerDailyReportCron } from "./cron/dailyReportCron";

2. After the server starts listening (app.listen(...)), add:



registerDailyReportCron();

‚ö†Ô∏è DO NOT modify anything else.
‚ö†Ô∏è DO NOT reorder imports.
‚ö†Ô∏è DO NOT auto-format the file or run Prettier.


---

üß™ AFTER AGENT APPLIES CHUNK 5

Run this to simulate the cron manually:

1. Manual Cron Test

node -e "require('./server/cron/dailyReportCron').registerDailyReportCron();"

You should see in logs:

[CRON] Daily report cron registered (03:00 Asia/Bangkok)

2. Trigger the cron job manually

node - <<'EOF'
const { registerDailyReportCron } = require('./server/cron/dailyReportCron');
registerDailyReportCron();
EOF

You should see:

[CRON] Running daily report for shiftDate=YYYY-MM-DD
[CRON] Saved report ID X
[CRON] Email sent for YYYY-MM-DD


---

üéâ If those logs appear, Chunk 5 is complete.

Then tell me:

‚ÄúChunk 5 complete ‚Äî ready for Chunk 6.‚Äù
