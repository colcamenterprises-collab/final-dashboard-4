ðŸ”¥ PATCH 2 â€” SHIFT REPORT BUSINESS LOGIC (Merging Sales, Stock, POS, & Variance Engine)

This is the biggest and most critical patch of the entire module.
It begins the actual functional Shift Report, turning the skeleton into a fully operational system.

Patch 2 delivers:

Automatic retrieval of Daily Sales V2

Automatic retrieval of Daily Stock V2

Automatic retrieval of POS Shift Report

Full merging into a single shift record

First stage variance engine

Stable output saved to shift_report_v2


Still NO UI yet â€” UI comes in Patch 3.
This keeps the system safe and perfectly staged.

As always:
One patch. Cut-and-paste. No free-styling. No touching anything else.


---

ðŸš¨ REPLIT AGENT â€” STRICT INSTRUCTIONS

DO:

Paste exactly the code provided

Modify ONLY the files listed

Save and exit


DO NOT:

âŒ Modify Daily Sales V2 or Daily Stock V2

âŒ Modify any Fort Knox modules

âŒ Modify shopping list logic

âŒ Modify POS import logic from other systems

âŒ Rename paths or imports

âŒ Refactor

âŒ Auto-format project-wide



---

âœ… PATCH 2 â€” FULL BUSINESS LOGIC IMPLEMENTATION

This patch expands the shiftReportBuilder.ts to:

1. Load Daily Sales V2 for the shift date


2. Load Daily Stock V2 linked to the sales entry


3. Load POS Shift Report for the shift


4. Build a combined structure


5. Run first-stage variance logic


6. Save into shift_report_v2 safely



All future enhancements (final variance engine, AI insights, PDF export, manager dashboard) come in later patches.


---

1. Update shiftReportBuilder.ts

File: server/services/shiftReportBuilder.ts
(REPLACE existing file completely)

// PATCH 2 â€” SHIFT REPORT BUSINESS LOGIC
// STRICT: Do not modify other modules, forms, or logic outside this file.

import prisma from "../prismaClient";

/**
 * Get the Daily Sales V2 submission for the shift.
 */
async function getDailySales(shiftDate: Date) {
  // Normalize to YYYY-MM-DD
  const iso = shiftDate.toISOString().split("T")[0];

  return prisma.dailySalesV2.findFirst({
    where: {
      createdAt: {
        gte: new Date(`${iso}T00:00:00+07:00`),
        lte: new Date(`${iso}T23:59:59+07:00`),
      },
    },
  });
}

/**
 * Get the Daily Stock V2 record linked to Daily Sales V2.
 */
async function getDailyStock(salesId: string) {
  return prisma.dailyStockV2.findUnique({
    where: { salesId },
  });
}

/**
 * Get the POS Shift Report (Loyverse upload) matching the shift date.
 */
async function getPOSShiftReport(shiftDate: Date) {
  const iso = shiftDate.toISOString().split("T")[0];

  return prisma.pos_shift_reports.findFirst({
    where: {
      shiftDate: {
        gte: new Date(`${iso}T00:00:00+07:00`),
        lte: new Date(`${iso}T23:59:59+07:00`),
      },
    },
  });
}

/**
 * Basic variance engine â€” establishes foundation.
 */
function computeVariances(salesData: any, posData: any) {
  if (!salesData || !posData) return {};

  return {
    cashVariance:
      (salesData.cash_total || 0) - (posData.cash_sales || 0),
    qrVariance:
      (salesData.qr_total || 0) - (posData.qr_sales || 0),
    grabVariance:
      (salesData.grab_total || 0) - (posData.grab_sales || 0),
    totalSalesVariance:
      (salesData.total_sales || 0) - (posData.total_sales || 0),
  };
}

/**
 * Main shift report builder function.
 */
export async function buildShiftReport(shiftDate: Date) {
  try {
    console.log("SHIFT REPORT BUILDER START:", shiftDate);

    // 1. Fetch Daily Sales
    const salesData = await getDailySales(shiftDate);
    if (!salesData) {
      console.warn("No Daily Sales V2 found for shift.");
    }

    // 2. Fetch Daily Stock
    let stockData = null;
    if (salesData?.id) {
      stockData = await getDailyStock(salesData.id);
    }

    // 3. Fetch POS Report
    const posData = await getPOSShiftReport(shiftDate);

    // 4. Variance Calculation
    const variances = computeVariances(salesData, posData);

    // 5. Save shift report
    const report = await prisma.shift_report_v2.create({
      data: {
        shiftDate,
        salesId: salesData?.id || null,
        stockId: stockData?.salesId || null,
        salesData: salesData || {},
        stockData: stockData || {},
        posData: posData || {},
        variances,
        aiInsights: "",
      },
    });

    console.log("SHIFT REPORT BUILT:", report.id);
    return report;
  } catch (err) {
    console.error("Shift Report Builder error:", err);
    return null;
  }
}


---

2. Update POST /generate route to validate date

File: server/routes/shiftReportRoutes.ts
(REPLACE ONLY the /generate endpoint)

router.post("/generate", async (req, res) => {
  try {
    const { shiftDate } = req.body;

    if (!shiftDate) {
      return res.status(400).json({ error: "shiftDate is required" });
    }

    const date = new Date(shiftDate);

    const report = await buildShiftReport(date);
    return res.json({ success: true, report });
  } catch (err) {
    console.error("Shift Report generation error:", err);
    res.status(500).json({ error: "Failed to generate shift report" });
  }
});


---

ðŸŽ‰ PATCH 2 COMPLETE

This patch now successfully:

Retrieves Daily Sales V2 for a shift

Retrieves Daily Stock V2 linked to sales

Retrieves POS shift report

Constructs a unified shift report

Computes baseline variances

Stores the result in shift_report_v2

Leaves everything else untouched and safe


This is the functional heart of the Shift Report module.


---