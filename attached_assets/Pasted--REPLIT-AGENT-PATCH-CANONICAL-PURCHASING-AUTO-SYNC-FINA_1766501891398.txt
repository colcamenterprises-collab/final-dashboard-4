üîê REPLIT AGENT ‚Äî PATCH: CANONICAL PURCHASING AUTO-SYNC (FINAL)
üéØ OBJECTIVE (NON-NEGOTIABLE)
Restore Purchasing List as the single source of truth and auto-sync it everywhere:
Copy code

purchasing_items (MASTER)
        ‚Üì
Form 2 (Daily Stock) ‚Äî auto-loaded
        ‚Üì
purchasing_shift_items (per shift)
        ‚Üì
Shopping List + Shift Log
No duplication. No JSON hacks. No derived item lists.
üö´ ABSOLUTE RULES (DO NOT VIOLATE)
‚ùå DO NOT create new purchasing tables
‚ùå DO NOT store purchase items in JSON
‚ùå DO NOT hardcode item lists anywhere
‚ùå DO NOT change business logic unrelated to purchasing
‚ùå DO NOT touch UI styling
‚úÖ STEP 1 ‚Äî PURCHASING LIST = CANONICAL MASTER
Action
Ensure ALL purchasable items live in:
Copy code

purchasing_items
Required columns:
id
name
category
supplier
brand
sku
order_unit
unit_cost
active (boolean)
Verification
Copy code
Sql
SELECT COUNT(*) FROM purchasing_items WHERE active = true;
Expected: ~72 items (or full catalog)
‚úÖ STEP 2 ‚Äî AUTO-SYNC FORM 2 (NO MANUAL SYNC)
Action
Form 2 (Daily Stock) must:
Load items LIVE from:
Copy code

GET /api/purchasing-items?active=true
Render items dynamically
NEVER store item definitions locally
ONLY allow staff to enter quantities
Explicit Removal
Remove:
Any static item arrays
Any derived stock lists
Any fallback mappings
Verification
Purchasing page and Form 2 show identical items
Adding/removing an item in Purchasing List updates Form 2 immediately (page refresh only)
‚úÖ STEP 3 ‚Äî WRITE PURCHASES CANONICALLY (FORM 2 SUBMIT)
Action
On Form 2 submit:
For each item with quantity > 0:
Resolve purchasing_item_id
Insert into:
Copy code

purchasing_shift_items
Required fields:
shift_date
purchasing_item_id
quantity
source = 'FORM_2'
Hard Rule
‚ùå Do NOT infer items by name
‚ùå Do NOT write to payload JSON
‚ùå Do NOT calculate costs here
Verification
Copy code
Sql
SELECT * FROM purchasing_shift_items ORDER BY created_at DESC LIMIT 10;
Rows appear immediately after submission.
‚úÖ STEP 4 ‚Äî SHOPPING LIST = READ-ONLY VIEW
Action
Shopping List API MUST:
Read ONLY from:
Copy code

purchasing_shift_items
Join:
Copy code

purchasing_items
for name, unit, cost
Explicitly Forbidden
Reading from daily_stock_v2
Reading from payload JSON
Any fallback logic
Verification
Shopping List populates after Form 2 submit
Costs reflect Purchasing List instantly
Historical lists load correctly
‚úÖ STEP 5 ‚Äî SHIFT LOG VISIBILITY (COMPLETE)
Action
Shift Log must:
Display ALL active purchasing_items
Show per-shift quantities from purchasing_shift_items
Show zero where no quantity exists
Verification
Every purchasing item appears as a row
Shifts align with Daily Stock dates
üîí STEP 6 ‚Äî LOCKDOWN HEADER (MANDATORY)
Add this header to ALL modified files:
Copy code
Ts
/**
 * üîí CANONICAL PURCHASING FLOW (AUTO-SYNC)
 * purchasing_items ‚Üí Form 2 ‚Üí purchasing_shift_items ‚Üí Shopping List
 *
 * RULES:
 * - purchasing_items is the ONLY source of truth
 * - Form 2 auto-loads items (no manual sync)
 * - Shopping List & Shift Log are read-only views
 * - DO NOT duplicate or derive items elsewhere
 */
‚úÖ FINAL ACCEPTANCE CRITERIA (MUST ALL PASS)
‚úÖ Purchasing List shows full catalog
‚úÖ Form 2 auto-updates when Purchasing List changes
‚úÖ Submitting Form 2 creates purchasing_shift_items rows
‚úÖ Shopping List populates correctly
‚úÖ Shift Log shows all items + all shifts
‚úÖ No JSON-based purchasing logic remains
üß† WHY THIS IS LOCKED
This design:
Eliminates drift
Eliminates silent failures
Makes costs editable in one place
Is safe for staff + ops + finance
Is scalable to multi-store later
This is the final purchasing architecture.