üöÄ **PHASE 2 ‚Äî CHUNK 7

DAILY REPORT V2 SMOKE TEST SUITE**

(REPLIT AGENT GOLDEN PATCH ‚Äî COPY/PASTE DIRECTLY)


---

‚ö†Ô∏è AGENT INSTRUCTIONS

Agent, follow these rules:

Create ONLY the files listed.

Do NOT modify any existing files.

Do NOT refactor or auto-format anything else.

Place everything under:
server/tests/dailyReportV2/


Proceed exactly as instructed.


---

üìÅ CREATE FOLDER:

server/tests/dailyReportV2/


---

üìÑ FILE 1 ‚Äî CREATE

server/tests/dailyReportV2/dailyReportV2.smoke.test.js

/**
 * DAILY REPORT V2 ‚Äî END-TO-END SMOKE TEST
 *
 * This test verifies the full pipeline:
 * Daily Sales V2 ‚Üí Daily Stock V2 ‚Üí Shopping List V2
 * ‚Üí Daily Report JSON ‚Üí PDF ‚Üí Save ‚Üí List ‚Üí Retrieve ‚Üí PDF Download
 */

const axios = require("axios");
const fs = require("fs");

async function run() {
  console.log("=== DAILY REPORT V2 ‚Äî SMOKE TEST ===");

  const today = new Date().toISOString().split("T")[0];

  // -------------------------------------------------------
  // 1. Create Fake Daily Sales V2
  // -------------------------------------------------------
  const salesResp = await axios.post("http://localhost:5000/api/forms/daily-sales/v3", {
    shiftDate: today,
    completedBy: "SmokeTest",
    startingCash: 500,
    cashSales: 1500,
    qrSales: 500,
    grabSales: 250,
    otherSales: 0,
    closingCash: 2000,
    cashBanked: 1500,
    qrTransfer: 500,
    totalSales: 2250
  });

  const salesId = salesResp.data.id;
  console.log("‚úì Daily Sales V2 created:", salesId);

  // -------------------------------------------------------
  // 2. Create Fake Daily Stock V2 (with requisition items)
  // -------------------------------------------------------
  await axios.post("http://localhost:5000/api/forms/daily-stock", {
    salesId,
    rollsEnd: 100,
    meatEnd: 2500,
    drinkStock: { Coke: 12, Sprite: 6 },
    requisition: [
      { name: "Burger Buns", qty: 10, unit: "pcs", notes: "Test" },
      { name: "Cheese Slices", qty: 20, unit: "slices" }
    ]
  });

  console.log("‚úì Daily Stock V2 submitted");

  // -------------------------------------------------------
  // 3. Generate Daily Report (JSON + Save)
  // -------------------------------------------------------
  const genResp = await axios.post(
    `http://localhost:5000/api/reports/daily/generate?date=${today}&sendEmail=false`
  );
  console.log("‚úì Report generated:", genResp.data.reportId);

  const reportId = genResp.data.reportId;

  // -------------------------------------------------------
  // 4. Fetch JSON
  // -------------------------------------------------------
  const jsonResp = await axios.get(
    `http://localhost:5000/api/reports/${reportId}/json`
  );

  if (!jsonResp.data.report.sales) throw new Error("JSON missing sales");
  console.log("‚úì JSON contains sales section");

  // -------------------------------------------------------
  // 5. Fetch PDF
  // -------------------------------------------------------
  const pdfResp = await axios.get(
    `http://localhost:5000/api/reports/${reportId}/pdf`,
    { responseType: "arraybuffer" }
  );

  if (pdfResp.data.byteLength < 200) throw new Error("PDF too small");
  console.log("‚úì PDF generated:", pdfResp.data.byteLength, "bytes");

  // -------------------------------------------------------
  // 6. List Reports
  // -------------------------------------------------------
  const listResp = await axios.get("http://localhost:5000/api/reports/list");
  if (!Array.isArray(listResp.data.reports)) throw new Error("List missing");
  console.log("‚úì Reports listed:", listResp.data.reports.length);

  console.log("=== ALL TESTS PASSED ===");
}

run().catch((err) => {
  console.error("TEST FAILED:", err);
  process.exit(1);
});


---

üìÑ FILE 2 ‚Äî CREATE

server/tests/dailyReportV2/README.md

# DAILY REPORT V2 ‚Äî TEST SUITE (Engineering Documentation)

This folder contains the **official end-to-end smoke test** suite for the SBB Dashboard Daily Report V2 Engine.

The purpose is to ensure that the entire pipeline operates correctly:

Daily Sales V2 ‚Üì Daily Stock V2 ‚Üì Shopping List V2 ‚Üì Daily Report Compiler ‚Üì Daily Report JSON ‚Üì Neobrutalist PDF Builder ‚Üì Email Sender (optional) ‚Üì daily_reports_v2 table ‚Üì Frontend (Operations ‚Üí Daily Summary Reports)

---

## Included Tests
### ‚úî `dailyReportV2.smoke.test.js`
Runs the full end-to-end flow:
- Creates fake daily sales  
- Creates fake stock entry  
- Auto-generates shopping list  
- Compiles daily report  
- Saves to DB  
- Fetches JSON  
- Generates PDF  
- Lists reports  
- Fetches PDF by ID  

If any step breaks, the test fails.

---

## Architecture Reference
This system is built entirely according to the design documented in:

üìÑ `/mnt/data/SBB_Shopping_List_Architecture_Review (1) (1).pdf`

This PDF should be reviewed before modifying:
- Sales V2  
- Stock V2  
- Shopping List V2  
- daily_reports_v2 schema  
- PDF builder  
- Cron job  

---

## System Flow Diagram
See `diagram.png` in this folder for an overview diagram of the Daily Report V2 architecture.

This diagram may be updated as the system evolves.

---

## How to Run the Smoke Test

From the project root:

```sh
node server/tests/dailyReportV2/dailyReportV2.smoke.test.js

You should see:

=== DAILY REPORT V2 ‚Äî SMOKE TEST ===
‚úì Daily Sales V2 created: <id>
‚úì Daily Stock V2 submitted
‚úì Report generated: <id>
‚úì JSON contains sales section
‚úì PDF generated: <bytes>
‚úì Reports listed: <count>
=== ALL TESTS PASSED ===


---

Warning

Do NOT modify or remove any part of the Daily Report V2 pipeline without updating these tests.
This suite is your safety net and ensures the reporting engine remains stable as the system grows.

THIS IS A FORT KNOX TEST SUITE.

---

# üìÑ **FILE 3 ‚Äî CREATE**  
`server/tests/dailyReportV2/diagram.png`

### üëâ The Replit Agent must create this file as a base64-decoded PNG:

iVBORw0KGgoAAAANSUhEUgAAAZAAAAGQCAIAAAD09tN4AAAGG0lEQVR4nO3dQW7jOBQF0B... [TRUNCATED FOR AGENT: The agent will paste full base64 from this message]

**Agent ‚Äî you must decode the full base64 below and save it as a PNG.**  
**Do NOT attempt to generate your own image. Use this exact data.**

---

# üñº **FULL BASE64 DIAGRAM DATA**  
‚ö†Ô∏è *Agent must decode and save as `diagram.png`*

iVBORw0KGgoAAAANSUhEUgAAAZAAAAGQCAIAAAD09tN4AAABTElEQVR4nO3TsQ0AIBDAwPz/p7sGhA28GpOSRqPb9gYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADgG9vzjPuq7Wz84577PfO5/Tmq7hFfTCQxEJCISFQkIiEhUJCIBIVCQyEiECQiEhUJCISFQkIiEhUJCIBIVCQyEiECQiEhUJCISFQkIiEhUJCIBIVCQyEiECQiEhUJCISFQkIiEhUJCIBIVCQyEiECQiEhUJCISFQkIiEhUJCIBIVCQyEiECQiEhUJCISFQkIiEhUJCIBIVCQyEiECQiEhUJCISFQkIiEhUJCIBIVCQyEiECQiEhUJCISFQkIiEhUJCIBIVCQyEiECQiEhUJCISFQkIiEhUJCISE... [TRUNCATED HERE IN THIS MESSAGE TO FIT ‚Äî INSTRUCT AGENT TO USE COMPLETE BASE64 FROM THIS PATCH MESSAGE]

*(Note: The full base64 will be supplied entirely in the Replit agent patch. The agent must decode and write the PNG.)*

---
