ğŸ”§ PHASE K-4 â€” SALES & SHIFT TRUTH REPAIR
(FIX ONLY â€” NO FEATURES, NO REDESIGN)
ğŸ¯ Objective
Make Sales & Shift Analysis truthful and usable by fixing write paths, POS receipt evidence, availability logic, and date binding.
After this patch, selecting a date shows real data, not false â€œmissingâ€ states.
ğŸš« ABSOLUTE RULES
âŒ No new UI features
âŒ No schema redesign
âŒ No analytics additions
âŒ No strategy changes
âœ… Fix correctness only
âœ… Preserve existing UX
âœ… REQUIRED FIXES (ALL MUST BE DONE)
K-4.1 â€” WRITE shift_date ON DAILY SALES V2 (CRITICAL)
Problem:
daily_sales_v2.shift_date is NULL â†’ analysis cannot see form data.
Fix:
When creating Daily Sales V2, always populate shift_date (DATE).
Rules:
Derive from business window 17:00 â†’ 03:00
Same logic used everywhere else
Use DATE type (not string)
Files to update:
server/forms/dailySalesV2.ts
Result:
Sales & Shift Analysis can finally â€œseeâ€ Daily Sales
False â€œmissing formâ€ states eliminated
K-4.2 â€” FIX POS RECEIPT COUNT (EVIDENCE)
Problem:
pos_shift_report.receiptCount is hardcoded to 0.
Fix:
Derive receipt count from pos_receipt table per business date and store it.
Rules:
Count receipts by business date window
Persist real count to pos_shift_report.receiptCount
Do NOT infer from sales totals
Files to update:
server/services/loyverseIngest.ts
Result:
POS becomes a verifiable witness
Receipt evidence exists
K-4.3 â€” USE RECEIPT COUNT IN AVAILABILITY LOGIC
Problem:
Availability ignores receipts entirely.
Fix:
Availability logic must consider:
POS exists if receiptCount > 0
Form exists if daily_sales_v2.shift_date exists
Truth Table (MANDATORY):
POS Receipts
Daily Sales
Status
âœ…
âœ…
OK
âœ…
âŒ
Missing Form
âŒ
âœ…
Missing POS
âŒ
âŒ
Missing Both
Files to update:
server/routes/analysisDailyReview.ts
Result:
â€œMissingâ€ now means something real
No more false accusations
K-4.4 â€” BIND BOTTOM TABLE TO DATE SELECTION
Problem:
â€œAll Shifts Dataâ€ ignores selected date/month.
Fix:
Refetch /api/analysis/daily-sales whenever:
selected date changes
selected month changes
Rules:
No UI redesign
No pagination changes
Just bind query to date/month
Files to update:
client/src/pages/analysis/DailyReview.tsx
Result:
Dates actually change data
Managers trust what they see
K-4.5 â€” DEFENSIVE GUARANTEE
Rules:
No endpoint may return 500
Return { status, message, data }
Log [SAFE_FALLBACK_USED] if data missing
Files to verify:
analysisDailyReview.ts
dailySalesV2.ts
POS ingest services
ğŸ§ª VERIFICATION (MANDATORY)
After patch:
Pick a date with known data
â†’ Sales & Shift Analysis shows values
Receipts > 0 + Daily Sales exists
â†’ Status = OK
Bottom table changes when date changes
No â€œmissing bothâ€ when data exists
No 500s anywhere
ğŸ›‘ DO NOT
Do NOT add buttons
Do NOT add charts
Do NOT rename fields
Do NOT touch navigation
Do NOT touch Purchasing or Ingredients
âœ… SUCCESS CRITERIA
One date â†’ one truth
Receipts are visible to logic
Cashier audits become possible
Trust restored
Proceed immediately.
No questions.
Deliver as one patch.