âœ… PATCH 4 â€“ B â€” SHOPPING LIST DATE RANGE EXPORT (PDF BUNDLE ZIP)

Purpose

Allows managers to download a ZIP that contains:

One PDF per shopping list within the selected date range

Automatically named PDFs: shopping-list-YYYY-MM-DD.pdf

Used for compliance audits & weekly purchasing summaries



---

ðŸš¨ STRICT RULES FOR REPLIT AGENT

Modify ONLY the files listed

Paste EXACTLY the code below

Do NOT alter imports or file names

Do NOT add refactors

Do NOT remove existing logic



---

1. Backend â€” Add Date Range ZIP Generator

Create file: server/services/shoppingListZip.ts

// PATCH 4B â€” SHOPPING LIST DATE RANGE ZIP EXPORT
// STRICT: Do not modify other modules.

import PDFDocument from "pdfkit";
import { Readable } from "stream";
import prisma from "../prismaClient";
import archiver from "archiver";

async function renderPDF(items: any[], dateLabel: string) {
  const doc = new PDFDocument({ margin: 40 });

  const stream = new Readable({
    read() {},
  });

  doc.on("data", (chunk) => stream.push(chunk));
  doc.on("end", () => stream.push(null));

  // HEADER
  doc.fontSize(22).fillColor("#000000").text("Smash Brothers Burgers");
  doc.moveDown(0.3);
  doc.fontSize(16).fillColor("#333333").text(`Shopping List â€” ${dateLabel}`);
  doc.moveDown(1);

  // TABLE HEADER
  doc.fontSize(12).fillColor("#ff6a00").text("Item", { continued: true, width: 200 });
  doc.text("Qty", { continued: true, width: 80 });
  doc.text("Notes", { width: 250 });

  doc.moveDown(0.3);
  doc.moveTo(40, doc.y).lineTo(550, doc.y).stroke("#ff6a00");
  doc.moveDown(0.5);

  // ITEMS
  items.forEach((i: any) => {
    doc.fontSize(11).fillColor("#000000").text(i.item, { continued: true, width: 200 });
    doc.text(String(i.quantity), { continued: true, width: 80 });
    doc.text(i.notes || "-", { width: 250 });
    doc.moveDown(0.3);
  });

  doc.end();
  return stream;
}

export async function generateShoppingListZip(start: string, end: string, res: any) {
  const startDate = new Date(start);
  const endDate = new Date(end);

  const lists = await prisma.shoppingListV2.findMany({
    where: {
      createdAt: {
        gte: startDate,
        lte: endDate,
      },
    },
    orderBy: { createdAt: "asc" },
  });

  if (!lists.length) return null;

  const archive = archiver("zip");
  archive.pipe(res);

  for (const list of lists) {
    const dateLabel = new Date(list.createdAt).toISOString().split("T")[0];
    const pdfStream = await renderPDF(list.items, dateLabel);

    archive.append(pdfStream, {
      name: `shopping-list-${dateLabel}.pdf`,
    });
  }

  archive.finalize();
  return true;
}


---

2. Backend â€” Add Date Range ZIP Route

Modify file: server/routes/shoppingListRoutes.ts
(Add this route BELOW pdf/latest)

import { generateShoppingListZip } from "../services/shoppingListZip";

router.get("/pdf/range", async (req, res) => {
  try {
    const { start, end } = req.query;

    if (!start || !end) {
      return res.status(400).json({ error: "start and end query params required" });
    }

    res.setHeader("Content-Type", "application/zip");
    res.setHeader(
      "Content-Disposition",
      "attachment; filename=shopping-lists.zip"
    );

    const ok = await generateShoppingListZip(String(start), String(end), res);

    if (!ok) {
      return res.status(404).json({ error: "No shopping lists found in range" });
    }
  } catch (err) {
    console.error("ZIP export error:", err);
    res.status(500).json({ error: "Failed to generate ZIP" });
  }
});


---

3. Frontend â€” Add Date Range Download UI

Modify file: client/src/pages/operations/shopping-list/index.tsx
(Add this simple form under your PDF button)

<div className="mb-4 p-3 border rounded">
  <h2 className="font-semibold mb-2">Export Range</h2>
  <div className="flex space-x-2">
    <input
      type="date"
      id="startDate"
      className="border p-2"
    />
    <input
      type="date"
      id="endDate"
      className="border p-2"
    />
    <button
      className="px-4 py-2 bg-black text-white rounded"
      onClick={() => {
        const start = (document.getElementById("startDate") as HTMLInputElement).value;
        const end = (document.getElementById("endDate") as HTMLInputElement).value;

        if (!start || !end) {
          alert("Please select a start and end date.");
          return;
        }

        window.open(`/api/shopping-list/pdf/range?start=${start}&end=${end}`, "_blank");
      }}
    >
      Export ZIP
    </button>
  </div>
</div>


---

ðŸŽ‰ PATCH 4B COMPLETE

Once the agent confirms, we immediately move to Patch 5 â€“ C.


---

âœ… PATCH 5 â€“ C â€” SHOPPING LIST HISTORY PAGE

This patch adds:

/operations/shopping-list/history page

Shows all historical shopping lists

Each list is clickable

Each list links to:

View items

Download PDF

Add future actions




---

ðŸ”¥ FULL PATCH 5 â€“ C (READY FOR AGENT)

1. Backend â€” Add history endpoint

Modify shoppingListRoutes.ts:

router.get("/history", async (req, res) => {
  try {
    const lists = await prisma.shoppingListV2.findMany({
      orderBy: { createdAt: "desc" },
    });

    res.json({ lists });
  } catch (err) {
    console.error("History fetch error:", err);
    res.status(500).json({ error: "Failed to fetch history" });
  }
});


---

2. Frontend â€” New History Page

Create file:
client/src/pages/operations/shopping-list/history.tsx

// PATCH 5C â€” Shopping List History
import { useEffect, useState } from "react";
import axios from "../../../utils/axiosInstance";

export default function ShoppingListHistory() {
  const [lists, setLists] = useState([]);

  useEffect(() => {
    axios.get("/shopping-list/history").then((res) => {
      setLists(res.data.lists);
    });
  }, []);

  return (
    <div className="p-6">
      <h1 className="text-2xl font-bold mb-4">Shopping List History</h1>

      {lists.length === 0 && <p>No history found.</p>}

      <div className="space-y-3">
        {lists.map((l: any) => {
          const date = new Date(l.createdAt).toLocaleString("en-TH", {
            timeZone: "Asia/Bangkok",
          });

          return (
            <div key={l.id} className="border p-4 rounded">
              <strong>{date}</strong>

              <div className="mt-2 space-x-2">
                <button
                  onClick={() => window.open("/operations/shopping-list/view/" + l.salesId)}
                  className="px-3 py-1 bg-black text-white rounded"
                >
                  View Items
                </button>

                <button
                  onClick={() =>
                    window.open("/api/shopping-list/pdf/latest?date=" + l.createdAt)
                  }
                  className="px-3 py-1 bg-gray-700 text-white rounded"
                >
                  Download PDF
                </button>
              </div>
            </div>
          );
        })}
      </div>
    </div>
  );
}


---
