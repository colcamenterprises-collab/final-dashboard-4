generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-1.1.x", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model DailySales {
  id             String             @id @default(uuid())
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt
  status         String             @default("draft")
  shiftDate      String
  submittedAtISO DateTime?
  completedBy    String
  startingCash   Int                @default(0)
  endingCash     Int                @default(0)
  cashBanked     Int                @default(0)
  cashSales      Int                @default(0)
  qrSales        Int                @default(0)
  grabSales      Int                @default(0)
  aroiSales      Int                @default(0)
  totalSales     Int                @default(0)
  shoppingTotal  Int                @default(0)
  wagesTotal     Int                @default(0)
  othersTotal    Int                @default(0)
  totalExpenses  Int                @default(0)
  closingCash    Int                @default(0)
  qrTransfer     Int                @default(0)
  notes          String?
  deletedAt      DateTime?
  storeId        String?
  otherSales     Int?               @default(0)
  otherExpense   Int?               @default(0)
  businessDate   DateTime?          @db.Date
  stock          DailyStock?
  comparisons    JussiComparison[]
  snapshots      ShiftSnapshot[]
  others         OtherExpense[]
  shopping       ShoppingPurchase[]
  wages          WageEntry[]

  @@index([businessDate])
}

model ShoppingPurchase {
  id        String     @id @default(uuid())
  createdAt DateTime   @default(now())
  item      String
  cost      Int        @default(0)
  shop      String
  salesId   String
  sales     DailySales @relation(fields: [salesId], references: [id], onDelete: Restrict)

  @@map("shopping_purchases")
}

model WageEntry {
  id        String     @id @default(uuid())
  createdAt DateTime   @default(now())
  staff     String
  amount    Int        @default(0)
  type      String
  salesId   String
  sales     DailySales @relation(fields: [salesId], references: [id], onDelete: Restrict)

  @@map("wage_entries")
}

model OtherExpense {
  id        String     @id @default(uuid())
  createdAt DateTime   @default(now())
  label     String
  amount    Int        @default(0)
  salesId   String
  sales     DailySales @relation(fields: [salesId], references: [id], onDelete: Restrict)

  @@map("other_expenses")
}

model DailyStock {
  id             String     @id @default(uuid())
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt
  salesId        String     @unique
  burgerBuns     Int        @default(0)
  meatWeightG    Int        @default(0)
  drinksJson     Json?
  notes          String?
  purchasingJson Json?
  status         String     @default("submitted")
  deletedAt      DateTime?
  bunsCount      Int        @default(0)
  meatGrams      Int        @default(0)
  sales          DailySales @relation(fields: [salesId], references: [id], onDelete: Restrict)
}

model Restaurant {
  id              String           @id @default(cuid())
  name            String
  slug            String           @unique
  email           String?
  timezone        String           @default("Asia/Bangkok")
  locale          String           @default("en-TH")
  logoUrl         String?
  brandColor      String?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  analyticsDaily  AnalyticsDaily[]
  expenses        Expense[]
  ingestionErrors IngestionError[]
  jobs            Job[]
  menuItems       MenuItem[]
  posConnections  PosConnection[]
  syncLogs        PosSyncLog[]
  receipts        Receipt[]

  @@map("restaurants")
}

model PosConnection {
  id           String      @id @default(cuid())
  restaurantId String
  provider     POSProvider
  apiKey       String?
  refreshToken String?
  meta         Json?
  isActive     Boolean     @default(true)
  lastSyncAt   DateTime?
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  restaurant   Restaurant  @relation(fields: [restaurantId], references: [id])

  @@index([restaurantId])
  @@index([provider, isActive])
  @@map("pos_connections")
}

model Receipt {
  id            String           @id @default(cuid())
  restaurantId  String
  provider      POSProvider
  externalId    String
  receiptNumber String?
  channel       SalesChannel     @default(OTHER)
  createdAtUTC  DateTime
  closedAtUTC   DateTime?
  subtotal      Int
  tax           Int
  discount      Int
  total         Int
  notes         String?
  rawPayload    Json?
  createdAt     DateTime         @default(now())
  items         ReceiptItem[]
  payments      ReceiptPayment[]
  restaurant    Restaurant       @relation(fields: [restaurantId], references: [id])

  @@unique([restaurantId, provider, externalId])
  @@index([restaurantId, createdAtUTC])
  @@map("receipts")
}

model ReceiptItem {
  id             String  @id @default(cuid())
  receiptId      String
  providerItemId String?
  sku            String?
  name           String
  category       String?
  qty            Int
  unitPrice      Int
  total          Int
  modifiers      Json?
  receipt        Receipt @relation(fields: [receiptId], references: [id])

  @@index([receiptId])
  @@map("receipt_items")
}

model ReceiptPayment {
  id        String        @id @default(cuid())
  receiptId String
  method    PaymentMethod @default(OTHER)
  amount    Int
  meta      Json?
  receipt   Receipt       @relation(fields: [receiptId], references: [id])

  @@index([receiptId])
  @@map("receipt_payments")
}

model MenuItem {
  id           String     @id @default(cuid())
  restaurantId String
  sku          String
  name         String
  category     String
  portionGrams Int?
  isDrink      Boolean    @default(false)
  isBurger     Boolean    @default(false)
  active       Boolean    @default(true)
  meta         Json?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id])

  @@unique([restaurantId, sku])
  @@index([restaurantId, category])
  @@map("menu_items")
}

model Expense {
  id           String     @id @default(cuid())
  restaurantId String
  shiftDate    DateTime
  item         String
  costCents    Int
  supplier     String?
  expenseType  String?
  meta         Json?
  createdAt    DateTime   @default(now())
  source       String?
  wages        Decimal?   @default(0) @db.Decimal
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id])

  @@index([restaurantId, shiftDate])
  @@map("expenses")
}

model ExpenseLine {
  id           String      @id @default(uuid())
  expenseId    String
  ingredientId String?
  name         String
  qty          Float?
  uom          String?
  unitPriceTHB Decimal?    @db.Decimal(12, 4)
  lineTotalTHB Decimal?    @db.Decimal(12, 2)
  type         ExpenseType @default(GENERAL)
  createdAt    DateTime    @default(now())

  @@index([ingredientId])
}

model AnalyticsDaily {
  id                 String     @id @default(cuid())
  restaurantId       String
  shiftDate          DateTime
  top5ByQty          Json?
  top5ByRevenue      Json?
  expectedBunsUsed   Int?
  expectedMeatGrams  Int?
  expectedDrinksUsed Int?
  variance           Json?
  shoppingList       Json?
  flags              Json?
  createdAt          DateTime   @default(now())
  restaurant         Restaurant @relation(fields: [restaurantId], references: [id])

  @@unique([restaurantId, shiftDate])
  @@index([restaurantId, shiftDate])
  @@map("analytics_daily")
}

model Job {
  id           String      @id @default(cuid())
  restaurantId String?
  type         JobType
  payload      Json?
  status       JobStatus   @default(QUEUED)
  runAt        DateTime?
  attempts     Int         @default(0)
  lastError    String?
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  restaurant   Restaurant? @relation(fields: [restaurantId], references: [id])

  @@index([status, runAt])
  @@index([restaurantId])
  @@map("jobs")
}

model PosSyncLog {
  id               String      @id @default(cuid())
  restaurantId     String
  provider         POSProvider
  startedAt        DateTime    @default(now())
  finishedAt       DateTime?
  mode             String
  receiptsFetched  Int         @default(0)
  itemsUpserted    Int         @default(0)
  paymentsUpserted Int         @default(0)
  status           String      @default("SUCCESS")
  message          String?
  createdAt        DateTime    @default(now())
  restaurant       Restaurant  @relation(fields: [restaurantId], references: [id])

  @@index([restaurantId, provider, startedAt])
  @@map("pos_sync_logs")
}

model IngestionError {
  id           String       @id @default(cuid())
  restaurantId String?
  provider     POSProvider?
  externalId   String?
  context      String?
  errorMessage String
  rawPayload   Json?
  createdAt    DateTime     @default(now())
  restaurant   Restaurant?  @relation(fields: [restaurantId], references: [id])

  @@index([restaurantId, provider, createdAt])
  @@map("ingestion_errors")
}

model ShiftSnapshot {
  id                  String             @id @default(uuid())
  provider            Provider           @default(LOYVERSE)
  windowStartUTC      DateTime
  windowEndUTC        DateTime
  loyverseShiftNumber Int?
  salesFormId         String?
  createdAt           DateTime           @default(now())
  totalReceipts       Int                @default(0)
  totalSalesSatang    BigInt             @default(0)
  reconcileState      ReconcileState     @default(MISSING_DATA)
  reconcileNotes      String?
  comparisons         JussiComparison[]
  payments            PaymentBreakdown[]
  salesForm           DailySales?        @relation(fields: [salesFormId], references: [id])
  items               SnapshotItem[]
  modifiers           SnapshotModifier[]

  @@index([windowStartUTC, windowEndUTC])
}

model PaymentBreakdown {
  id          String         @id @default(uuid())
  snapshotId  String
  channel     PaymentChannel
  count       Int            @default(0)
  totalSatang BigInt         @default(0)
  snapshot    ShiftSnapshot  @relation(fields: [snapshotId], references: [id], onDelete: Cascade)

  @@unique([snapshotId, channel])
  @@index([snapshotId])
}

model SnapshotItem {
  id            String        @id @default(uuid())
  snapshotId    String
  itemName      String
  sku           String?
  category      String?
  qty           Int           @default(0)
  revenueSatang BigInt        @default(0)
  snapshot      ShiftSnapshot @relation(fields: [snapshotId], references: [id], onDelete: Cascade)

  @@index([snapshotId])
}

model SnapshotModifier {
  id            String        @id @default(uuid())
  snapshotId    String
  modifierName  String
  lines         Int           @default(0)
  revenueSatang BigInt        @default(0)
  snapshot      ShiftSnapshot @relation(fields: [snapshotId], references: [id], onDelete: Cascade)

  @@index([snapshotId])
}

model PaymentMethodMap {
  id         String         @id @default(uuid())
  provider   Provider       @default(LOYVERSE)
  sourceName String
  channel    PaymentChannel @default(OTHER)
  createdAt  DateTime       @default(now())

  @@unique([provider, sourceName])
}

model RecipeItem {
  id         String            @id @default(uuid())
  sku        String?           @unique
  name       String
  category   String?
  isMealDeal Boolean           @default(false)
  createdAt  DateTime          @default(now())
  components RecipeComponent[]
}

model RecipeComponent {
  id           String     @id @default(uuid())
  recipeItemId String
  ingredientId String
  baseQty      Float
  uom          String
  recipeItem   RecipeItem @relation(fields: [recipeItemId], references: [id], onDelete: Cascade)

  @@index([recipeItemId])
}

model JussiComparison {
  id                    String         @id @default(uuid())
  snapshotId            String
  salesFormId           String?
  createdAt             DateTime       @default(now())
  openingBuns           Int?
  openingMeatGram       Int?
  openingDrinks         Int?
  purchasedBuns         Int?
  purchasedMeatGram     Int?
  purchasedDrinks       Int?
  expectedBuns          Int?
  expectedMeatGram      Int?
  expectedDrinks        Int?
  expectedCloseBuns     Int?
  expectedCloseMeatGram Int?
  expectedCloseDrinks   Int?
  staffBuns             Int?
  staffMeatGram         Int?
  staffDrinks           Int?
  varBuns               Int?
  varMeatGram           Int?
  varDrinks             Int?
  state                 ReconcileState @default(MISSING_DATA)
  notes                 String?
  salesForm             DailySales?    @relation(fields: [salesFormId], references: [id])
  snapshot              ShiftSnapshot  @relation(fields: [snapshotId], references: [id], onDelete: Cascade)

  @@index([snapshotId])
  @@index([salesFormId])
}

model DailySalesV2 {
  id                     String               @id @default(uuid())
  createdAt              DateTime             @default(now())
  shiftDate              String
  submittedAtISO         DateTime
  completedBy            String
  startingCash           Int                  @default(0)
  endingCash             Int                  @default(0)
  cashBanked             Int                  @default(0)
  cashSales              Int                  @default(0)
  qrSales                Int                  @default(0)
  grabSales              Int                  @default(0)
  aroiSales              Int                  @default(0)
  totalSales             Int                  @default(0)
  shoppingTotal          Int                  @default(0)
  wagesTotal             Int                  @default(0)
  othersTotal            Int                  @default(0)
  totalExpenses          Int                  @default(0)
  qrTransfer             Int                  @default(0)
  deletedAt              DateTime?
  staff                  String?
  shift_date             DateTime?            @db.Date
  payload                Json?
  q1CashInRegister       Int?
  q2ExpensesMirrorReport Boolean?
  q3CorrectDescriptions  Boolean?
  q4RegisterBalances     Boolean?
  q5AmountToBanked       Int?
  q6ManagerName          String?
  stock                  DailyStockV2?
  others                 OtherExpenseV2[]
  shopping               ShoppingPurchaseV2[]
  wages                  WageEntryV2[]

  @@index([completedBy], map: "idx_daily_sales_v2_completed_by")
  @@index([createdAt], map: "idx_daily_sales_v2_created_at")
  @@index([shiftDate], map: "idx_daily_sales_v2_shift_date")
  @@map("daily_sales_v2")
}

model ShoppingPurchaseV2 {
  id        String       @id @default(uuid())
  createdAt DateTime     @default(now())
  item      String
  cost      Int          @default(0)
  shop      String
  salesId   String
  sales     DailySalesV2 @relation(fields: [salesId], references: [id], onDelete: Restrict)

  @@map("shopping_purchase_v2")
}

model WageEntryV2 {
  id        String       @id @default(uuid())
  createdAt DateTime     @default(now())
  staff     String
  amount    Int          @default(0)
  type      String
  salesId   String
  sales     DailySalesV2 @relation(fields: [salesId], references: [id], onDelete: Restrict)

  @@map("wage_entry_v2")
}

model OtherExpenseV2 {
  id        String       @id @default(uuid())
  createdAt DateTime     @default(now())
  label     String
  amount    Int          @default(0)
  salesId   String
  sales     DailySalesV2 @relation(fields: [salesId], references: [id], onDelete: Restrict)

  @@map("other_expense_v2")
}

model DailyStockV2 {
  id                    String                  @id @default(uuid())
  createdAt             DateTime                @default(now())
  salesId               String                  @unique
  burgerBuns            Int                     @default(0)
  meatWeightG           Int                     @default(0)
  drinksJson            Json?
  purchasingJson        Json?
  notes                 String?
  deletedAt             DateTime?
  sales                 DailySalesV2            @relation(fields: [salesId], references: [id], onDelete: Restrict)
  purchasingShiftItems  PurchasingShiftItem[]

  @@map("daily_stock_v2")
}

model PurchasingShiftItem {
  id               Int          @id @default(autoincrement())
  dailyStockId     String
  purchasingItemId Int
  quantity         Decimal      @default(0) @db.Decimal(10, 2)
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  
  dailyStock       DailyStockV2 @relation(fields: [dailyStockId], references: [id], onDelete: Cascade)

  @@unique([dailyStockId, purchasingItemId])
  @@index([dailyStockId])
  @@index([purchasingItemId])
  @@map("purchasing_shift_items")
}

model IngredientV2 {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  name      String   @unique
  supplier  String?
  category  String?
  brand     String?

  // PACK F fields
  baseUnit              String?  @map("base_unit") // e.g., "g", "ml", "unit", "slice"
  defaultPortion        Decimal? @map("default_portion") // e.g., 90, 12, 1
  linkedPurchasingItemId Int?    @map("linked_purchasing_item_id")
  verified              Boolean  @default(false)

  // Purchasing (pack-based - for shopping lists)
  purchaseUnit String? @map("purchase_unit") // e.g., "kg", "pack"
  purchaseQty  Decimal? @map("purchase_qty") // e.g., 1.0 kg per pack
  packageCost  Decimal? @map("package_cost") // THB per pack

  // Portioning (used ONLY for recipe costing)
  portionUnit String? @map("portion_unit") // e.g., "g", "ml"
  portionQty  Decimal? @map("portion_qty") // e.g., 1000 (for 1kg = 1000g)

  lastReview DateTime? @map("lastreview")
  notes      String?

  items        RecipeItemV2[]
  priceHistory IngredientPriceV2[]

  @@map("ingredient_v2")
}

model IngredientPriceV2 {
  id           String   @id @default(uuid())
  ingredientId String
  recordedAt   DateTime @default(now())
  purchaseUnit String
  purchaseQty  Decimal
  packageCost  Decimal

  ingredient IngredientV2 @relation(fields: [ingredientId], references: [id], onDelete: Cascade)

  @@index([ingredientId, recordedAt])
  @@map("ingredient_price_v2")
}

model RecipeV2 {
  id           String         @id @default(uuid())
  createdAt    DateTime       @default(now())
  name         String         @unique
  yield        Decimal        @default(1)
  targetMargin Decimal        @default(0)
  items        RecipeItemV2[]

  @@map("recipe_v2")
}

model RecipeItemV2 {
  id           String       @id @default(uuid())
  recipeId     String
  ingredientId String
  qty          Decimal      @default(0)
  ingredient   IngredientV2 @relation(fields: [ingredientId], references: [id])
  recipe       RecipeV2     @relation(fields: [recipeId], references: [id], onDelete: Cascade)

  @@unique([recipeId, ingredientId])
  @@map("recipe_item_v2")
}

model MenuV2 {
  id         String       @id @default(uuid())
  name       String
  source     MenuSource
  fileType   String
  version    String?
  importedAt DateTime     @default(now())
  notes      String?
  items      MenuItemV2[]

  @@index([source])
  @@map("menu_v2")
}

model MenuItemV2 {
  id          String           @id @default(uuid())
  menuId      String
  externalId  String?
  name        String
  category    String?
  basePrice   Decimal          @default(0)
  description String?
  active      Boolean          @default(true)
  menu        MenuV2           @relation(fields: [menuId], references: [id], onDelete: Cascade)
  modifiers   MenuModifierV2[]

  @@unique([menuId, name])
  @@index([name])
  @@map("menu_item_v2")
}

model MenuModifierV2 {
  id        String     @id @default(uuid())
  itemId    String
  groupName String?
  name      String
  price     Decimal    @default(0)
  item      MenuItemV2 @relation(fields: [itemId], references: [id], onDelete: Cascade)

  @@index([itemId])
  @@map("menu_modifier_v2")
}

model StockItem {
  id            Int            @id @default(autoincrement())
  name          String
  category      String
  isDrink       Boolean        @default(false)
  isExcluded    Boolean        @default(false)
  displayOrder  Int            @default(0)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  stockRequests StockRequest[]

  @@map("stock_items")
}

model StockRequest {
  id           Int       @id @default(autoincrement())
  shiftId      String
  stockItemId  Int
  requestedQty Int?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  StockItem    StockItem @relation(fields: [stockItemId], references: [id])

  @@unique([shiftId, stockItemId])
  @@map("stock_requests")
}

model PosBatch {
  id         String              @id @default(uuid())
  createdAt  DateTime            @default(now())
  title      String?
  shiftStart DateTime?
  shiftEnd   DateTime?
  payments   PosPaymentSummary[]
  receipts   PosReceipt[]
  items      PosSalesItem[]
  modifiers  PosSalesModifier[]
  shift      PosShiftReport?
}

model PosReceipt {
  id        String   @id @default(uuid())
  batchId   String
  receiptId String
  datetime  DateTime
  total     Decimal  @db.Decimal(10, 2)
  itemsJson Json
  payment   String?
  batch     PosBatch @relation(fields: [batchId], references: [id])
}

model PosShiftReport {
  id            String    @id @default(uuid())
  batchId       String    @unique
  grossSales    Decimal   @db.Decimal(10, 2)
  discounts     Decimal   @db.Decimal(10, 2)
  netSales      Decimal   @db.Decimal(10, 2)
  cashInDrawer  Decimal   @db.Decimal(10, 2)
  cashSales     Decimal   @db.Decimal(10, 2)
  qrSales       Decimal   @db.Decimal(10, 2)
  otherSales    Decimal   @db.Decimal(10, 2)
  receiptCount  Int
  storeId       String?
  openedAt      DateTime?
  closedAt      DateTime?
  cashTotal     Int?      @default(0)
  qrTotal       Int?      @default(0)
  grabTotal     Int?      @default(0)
  otherTotal    Int?      @default(0)
  grandTotal    Int?      @default(0)
  shoppingTotal Int?      @default(0)
  wagesTotal    Int?      @default(0)
  otherExpense  Int?      @default(0)
  startingCash  Int?      @default(0)
  businessDate  DateTime? @db.Date
  batch         PosBatch  @relation(fields: [batchId], references: [id])

  @@index([businessDate])
}

model PosSalesItem {
  id      String   @id @default(uuid())
  batchId String
  name    String
  qty     Int
  net     Decimal  @db.Decimal(10, 2)
  batch   PosBatch @relation(fields: [batchId], references: [id])
}

model PosSalesModifier {
  id      String   @id @default(uuid())
  batchId String
  name    String
  qty     Int
  net     Decimal  @db.Decimal(10, 2)
  batch   PosBatch @relation(fields: [batchId], references: [id])
}

model PosPaymentSummary {
  id      String   @id @default(uuid())
  batchId String
  method  String
  amount  Decimal  @db.Decimal(10, 2)
  batch   PosBatch @relation(fields: [batchId], references: [id])
}

model BankImportBatch {
  id        String    @id @default(uuid())
  createdAt DateTime  @default(now())
  source    String
  filename  String
  status    String    @default("pending")
  txns      BankTxn[]
}

model BankTxn {
  id          String          @id @default(uuid())
  batchId     String
  postedAt    DateTime
  description String
  amountTHB   Decimal         @db.Decimal(12, 2)
  ref         String?
  raw         Json
  status      String          @default("pending")
  category    String?
  supplier    String?
  notes       String?
  expenseId   String?
  dedupeKey   String          @unique
  batch       BankImportBatch @relation(fields: [batchId], references: [id], onDelete: Cascade)
}

model VendorRule {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  matchText String
  category  String
  supplier  String
}

model ManagerCheckQuestion {
  id         Int       @id @default(autoincrement())
  text       String
  text_en    String?
  text_th    String?
  category   String?
  enabled    Boolean?  @default(true)
  weight     Int?      @default(1)
  created_at DateTime? @default(now()) @db.Timestamp(6)
  updated_at DateTime? @default(now()) @db.Timestamp(6)
}

model AnalyticsShiftBurgerItem {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  restaurant_id   String?
  shift_date      DateTime @db.Date
  from_ts         DateTime @db.Timestamptz(6)
  to_ts           DateTime @db.Timestamptz(6)
  normalized_name String
  qty             Int      @default(0)
  patties         Int      @default(0)
  red_meat_g      Int      @default(0)
  chicken_g       Int      @default(0)
  rolls           Int      @default(0)
  raw_hits        Json     @default("[]")
  created_at      DateTime @default(now()) @db.Timestamptz(6)
  updated_at      DateTime @default(now()) @db.Timestamptz(6)

  @@unique([restaurant_id, shift_date, normalized_name])
  @@index([shift_date], map: "idx_asbi_shift")
  @@map("analytics_shift_burger_item")
}

model AnalyticsShiftBurgerSummary {
  id               String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  restaurant_id    String?
  shift_date       DateTime @unique @db.Date
  from_ts          DateTime @db.Timestamptz(6)
  to_ts            DateTime @db.Timestamptz(6)
  burgers_total    Int      @default(0)
  patties_total    Int      @default(0)
  red_meat_g_total Int      @default(0)
  chicken_g_total  Int      @default(0)
  rolls_total      Int      @default(0)
  created_at       DateTime @default(now()) @db.Timestamptz(6)
  updated_at       DateTime @default(now()) @db.Timestamptz(6)

  @@map("analytics_shift_burger_summary")
}

model MenuCategory {
  id        String            @id @default(cuid())
  name      String
  slug      String            @unique
  position  Int?              @default(0)
  createdAt DateTime          @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime          @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  items     MenuItem_Online[]

  @@map("menu_categories_online")
}

model MenuItem_Online {
  id          String                 @id @default(cuid())
  categoryId  String
  name        String
  description String?
  price       Int
  imageUrl    String?
  sku         String?                @unique
  position    Int?                   @default(0)
  available   Boolean?               @default(true)
  createdAt   DateTime               @default(now()) @db.Timestamp(6)
  updatedAt   DateTime               @default(now()) @updatedAt @db.Timestamp(6)
  category    MenuCategory           @relation(fields: [categoryId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  groups      ModifierGroup_Online[]

  @@map("menu_items_online")
}

model ModifierGroup_Online {
  id       String                  @id @default(cuid())
  itemId   String
  name     String
  type     String
  required Boolean?                @default(false)
  maxSel   Int?
  position Int?                    @default(0)
  item     MenuItem_Online         @relation(fields: [itemId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  options  ModifierOption_Online[]

  @@map("modifier_groups_online")
}

model ModifierOption_Online {
  id         String               @id @default(cuid())
  groupId    String
  name       String
  priceDelta Int
  position   Int?                 @default(0)
  group      ModifierGroup_Online @relation(fields: [groupId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@map("modifier_options_online")
}

model OrderOnline {
  id         String             @id @default(cuid())
  ref        String             @unique
  status     String?            @default("pending")
  name       String?
  phone      String?
  type       String?            @default("Pickup")
  address    String?
  payment    String?            @default("Cash")
  subtotal   Int
  vatAmount  Int
  total      Int
  rawPayload Json?
  createdAt  DateTime           @default(now()) @db.Timestamp(6)
  updatedAt  DateTime           @default(now()) @updatedAt @db.Timestamp(6)
  lines      OrderLine_Online[]

  @@map("orders_online")
}

model OrderLine_Online {
  id        String      @id @default(cuid())
  orderId   String
  itemId    String?
  sku       String?
  name      String
  qty       Int?        @default(1)
  basePrice Int
  modifiers Json?
  note      String?
  lineTotal Int
  order     OrderOnline @relation(fields: [orderId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@map("order_lines_online")
}

model ManagerChecklist {
  id             Int       @id @default(autoincrement())
  shiftId        String
  managerName    String
  tasksAssigned  Json
  tasksCompleted Json
  createdAt      DateTime? @default(now()) @db.Timestamptz(6)
  signedAt       DateTime? @db.Timestamptz(6)

  @@index([shiftId], map: "idx_manager_checklist_shift")
}

model analytics_shift_category_summary {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  shift_date  DateTime @db.Date
  from_ts     DateTime @db.Timestamptz(6)
  to_ts       DateTime @db.Timestamptz(6)
  category    String
  items_total Int      @default(0)
  created_at  DateTime @default(now()) @db.Timestamptz(6)
  updated_at  DateTime @default(now()) @db.Timestamptz(6)

  @@unique([shift_date, category])
  @@index([shift_date, category], map: "idx_ascs_shift")
}

/// This model contains an expression index which requires additional setup for migrations. Visit https://pris.ly/d/expression-indexes for more info.
model analytics_shift_item {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  shift_date DateTime @db.Date
  from_ts    DateTime @db.Timestamptz(6)
  to_ts      DateTime @db.Timestamptz(6)
  sku        String?
  name       String
  category   String
  qty        Int      @default(0)
  raw_hits   Json     @default("[]")
  created_at DateTime @default(now()) @db.Timestamptz(6)
  updated_at DateTime @default(now()) @db.Timestamptz(6)
  patties    Int?     @default(0)
  red_meat_g Float?   @default(0) @db.Real
  chicken_g  Float?   @default(0) @db.Real
  rolls      Int?     @default(0)

  @@index([shift_date, category], map: "idx_asi_shift")
}

/// This model contains an expression index which requires additional setup for migrations. Visit https://pris.ly/d/expression-indexes for more info.
model analytics_shift_modifier {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  shift_date DateTime @db.Date
  from_ts    DateTime @db.Timestamptz(6)
  to_ts      DateTime @db.Timestamptz(6)
  sku        String?
  name       String
  category   String   @default("modifier")
  qty        Int
  raw_hits   Json     @default("[]")
  updated_at DateTime @default(now()) @db.Timestamptz(6)
}

model checklist_assignments {
  id                String    @id @default(dbgenerated("gen_random_uuid()"))
  shift_id          String
  manager_name      String
  assigned_task_ids Json
  created_at        DateTime? @default(now()) @db.Timestamp(6)
  expires_at        DateTime  @db.Timestamp(6)
}

model cleaning_tasks {
  id         Int       @id @default(autoincrement())
  taskName   String
  taskDetail String?
  zone       String
  shiftPhase String
  active     Boolean?  @default(true)
  createdAt  DateTime? @default(now()) @db.Timestamp(6)
}

model dailyReceiptSummaries {
  id         Int       @id @default(autoincrement())
  shift_date DateTime  @unique @db.Date
  data       Json
  created_at DateTime? @default(now()) @db.Timestamp(6)
}

model dailyShiftAnalysis {
  id         Int       @id @default(autoincrement())
  shift_date DateTime  @unique @db.Date
  analysis   Json
  created_at DateTime? @default(now()) @db.Timestamp(6)
}

model daily_review_comments {
  id                   Int      @id @default(autoincrement())
  business_date        DateTime @unique @db.Date
  comment              String
  created_by           String?
  created_at           DateTime @default(now()) @db.Timestamp(6)
  updated_at           DateTime @default(now()) @db.Timestamp(6)
  actual_amount_banked Decimal? @db.Decimal(10, 2)
}

model daily_stock_sales {
  id                      Int       @id @default(autoincrement())
  completed_by            String
  shift_type              String
  shift_date              DateTime  @db.Timestamp(6)
  starting_cash           Decimal?  @db.Decimal(10, 2)
  ending_cash             Decimal?  @db.Decimal(10, 2)
  grab_sales              Decimal?  @db.Decimal(10, 2)
  food_panda_sales        Decimal?  @db.Decimal(10, 2)
  aroi_dee_sales          Decimal?  @db.Decimal(10, 2)
  qr_scan_sales           Decimal?  @db.Decimal(10, 2)
  cash_sales              Decimal?  @db.Decimal(10, 2)
  total_sales             Decimal?  @db.Decimal(10, 2)
  salary_wages            Decimal?  @db.Decimal(10, 2)
  gas_expense             Decimal?  @db.Decimal(10, 2)
  total_expenses          Decimal?  @db.Decimal(10, 2)
  expense_description     String?
  burger_buns_stock       Int?
  rolls_ordered_count     Int?
  meat_weight             Decimal?  @db.Decimal(10, 2)
  drink_stock_count       Int?
  food_items              Json?
  drink_stock             Json?
  kitchen_items           Json?
  packaging_items         Json?
  fresh_food              Json?
  frozen_food             Json?
  shelf_items             Json?
  wage_entries            Json?
  shopping_entries        Json?
  rolls_ordered_confirmed Boolean?
  wages                   Json?
  banked_amount           Decimal?  @db.Decimal(10, 2)
  purchased_amounts       Json?
  number_needed           Json?
  shopping                Json?
  pdf_path                String?
  is_draft                Boolean?  @default(false)
  deleted_at              DateTime? @db.Timestamp(6)
  created_at              DateTime? @default(now()) @db.Timestamp(6)
  updated_at              DateTime? @default(now()) @db.Timestamp(6)
  status                  String?
  notes                   String?
  discrepancy_notes       String?
}

model drink_brand {
  id                  Int                   @id @default(autoincrement())
  name                String                @unique
  unit                String                @default("can")
  manual_drink_ledger manual_drink_ledger[]
}

model import_log {
  run_id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  provider          String
  from_ts           DateTime  @db.Timestamptz(6)
  to_ts             DateTime  @db.Timestamptz(6)
  receipts_fetched  Int       @default(0)
  receipts_upserted Int       @default(0)
  status            String    @default("ok")
  message           String?
  started_at        DateTime  @default(now()) @db.Timestamptz(6)
  finished_at       DateTime? @db.Timestamptz(6)
}

model imported_expenses {
  id              String                  @id @default(dbgenerated("gen_random_uuid()"))
  restaurant_id   String
  import_batch_id String
  date            DateTime?               @db.Date
  description     String?
  amount_cents    Int?
  raw_data        Json?
  status          imported_expense_status @default(PENDING)
  approved_by     String?
  approved_at     DateTime?               @db.Timestamp(6)
  created_at      DateTime?               @default(now()) @db.Timestamp(6)
  supplier        String?
  category        String?
  source          String?                 @default("MANUAL_ENTRY")
}

model ingredients {
  id               Int        @id @default(autoincrement())
  name             String
  category         String
  supplier         String
  unit_price       Decimal    @db.Decimal(10, 2)
  price            Decimal?   @db.Decimal(10, 2)
  package_size     Decimal?   @db.Decimal(10, 2)
  portion_size     Decimal?   @db.Decimal(10, 2)
  cost_per_portion Decimal?   @db.Decimal(10, 2)
  unit             String
  notes            String?
  brand            String?
  packaging_qty    String?
  last_review_date String?
  source           String?    @default("manual")
  last_updated     DateTime?  @default(now()) @db.Timestamp(6)
  updated_at       DateTime?  @default(now()) @db.Timestamp(6)
  created_at       DateTime?  @default(now()) @db.Timestamp(6)
  supplier_id      Int?
  package_qty      Decimal?   @db.Decimal(10, 3)
  package_unit     String?    @db.VarChar(50)
  package_cost     Decimal?   @db.Decimal(10, 2)
  portion_qty      Decimal?   @db.Decimal(10, 3)
  portion_unit     String?    @db.VarChar(50)
  purchase_qty     Decimal?   @db.Decimal
  suppliers        suppliers? @relation(fields: [supplier_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([category], map: "idx_ingredients_category")
  @@index([supplier_id], map: "idx_ingredients_supplier_id")
}

model item_alias {
  alias_name   String       @id
  sku          String
  item_catalog item_catalog @relation(fields: [sku], references: [sku], onDelete: NoAction)
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model item_catalog {
  sku         String       @id
  name        String
  category    String
  kind        String?
  patties_per Int?
  grams_per   Int?
  rolls_per   Int          @default(1)
  updated_at  DateTime     @default(now()) @db.Timestamptz(6)
  active      Boolean      @default(true)
  is_meal_set Boolean      @default(false)
  base_sku    String?
  item_alias  item_alias[]

  @@index([category], map: "idx_item_catalog_category")
  @@index([kind], map: "idx_item_catalog_kind")
}

model loyverse_receipts {
  shift_date DateTime @id @db.Date
  data       Json?
}

model loyverse_shifts {
  shift_date DateTime @id @db.Date
  data       Json?
}

model lv_line_item {
  receipt_id    String
  line_no       Int
  sku           String?
  name          String
  qty           Int
  unit_price    Decimal?      @db.Decimal(12, 2)
  category_hint String?
  raw_json      Json?         @default("{}")
  created_at    DateTime      @default(now()) @db.Timestamptz(6)
  lv_receipt    lv_receipt    @relation(fields: [receipt_id], references: [receipt_id], onDelete: Cascade, onUpdate: NoAction)
  lv_modifier   lv_modifier[]

  @@id([receipt_id, line_no])
  @@index([receipt_id], map: "ix_lv_line_item_receipt")
  @@index([sku], map: "ix_lv_line_item_sku")
}

model lv_modifier {
  receipt_id   String
  line_no      Int
  mod_no       Int
  sku          String?
  name         String
  qty          Int          @default(1)
  raw_json     Json?        @default("{}")
  created_at   DateTime     @default(now()) @db.Timestamptz(6)
  lv_line_item lv_line_item @relation(fields: [receipt_id, line_no], references: [receipt_id, line_no], onDelete: Cascade, onUpdate: NoAction)

  @@id([receipt_id, line_no, mod_no])
}

model lv_receipt {
  receipt_id   String         @id @unique(map: "ux_lv_receipt")
  datetime_bkk DateTime       @db.Timestamptz(6)
  staff_name   String?
  customer_id  String?
  total_amount Decimal?       @db.Decimal(12, 2)
  payment_json Json?          @default("{}")
  raw_json     Json?          @default("{}")
  created_at   DateTime       @default(now()) @db.Timestamptz(6)
  lv_line_item lv_line_item[]

  @@index([datetime_bkk], map: "ix_lv_receipt_bkk")
  @@index([datetime_bkk], map: "ix_lv_receipt_datetime")
}

model manager_checklists {
  id             Int       @id @default(autoincrement())
  shiftId        String
  managerName    String
  tasksAssigned  Json
  tasksCompleted Json
  createdAt      DateTime? @default(now()) @db.Timestamp(6)
  signedAt       DateTime? @default(now()) @db.Timestamp(6)
}

model manual_drink_ledger {
  id                  String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  shift_id            String              @db.Uuid
  brand_id            Int
  prev_end            Int?                @default(0)
  purchased           Int?                @default(0)
  sold                Int?                @default(0)
  expected            Int?                @default(0)
  actual              Int?                @default(0)
  variance            Int?                @default(0)
  paid                Boolean?            @default(false)
  drink_brand         drink_brand         @relation(fields: [brand_id], references: [id], onUpdate: NoAction)
  manual_stock_ledger manual_stock_ledger @relation(fields: [shift_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([shift_id, brand_id], map: "idx_manual_drink_ledger_shift_brand")
}

model manual_stock_ledger {
  id                  String                @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  shift_date          DateTime              @db.Date
  completed_by        String?
  source_form_id      String?               @db.Uuid
  total_sales         Decimal?              @db.Decimal(12, 2)
  cash_sales          Decimal?              @db.Decimal(12, 2)
  qr_sales            Decimal?              @db.Decimal(12, 2)
  grab_sales          Decimal?              @db.Decimal(12, 2)
  other_sales         Decimal?              @db.Decimal(12, 2)
  shopping_total      Decimal?              @db.Decimal(12, 2)
  wages_total         Decimal?              @db.Decimal(12, 2)
  rolls_prev_end      Int?                  @default(0)
  rolls_purchased     Int?                  @default(0)
  burgers_sold        Int?                  @default(0)
  rolls_expected      Int?                  @default(0)
  rolls_actual        Int?                  @default(0)
  rolls_variance      Int?                  @default(0)
  rolls_paid          Boolean?              @default(false)
  meat_prev_end_g     Int?                  @default(0)
  meat_purchased_g    Int?                  @default(0)
  meat_sold_g         Int?                  @default(0)
  meat_expected_g     Int?                  @default(0)
  meat_actual_g       Int?                  @default(0)
  meat_variance_g     Int?                  @default(0)
  meat_paid           Boolean?              @default(false)
  notes               String?
  created_at          DateTime?             @default(now()) @db.Timestamptz(6)
  manual_drink_ledger manual_drink_ledger[]

  @@index([shift_date], map: "idx_manual_stock_ledger_shift_date")
}

model partner_statements {
  id                String                  @id @default(dbgenerated("gen_random_uuid()"))
  restaurant_id     String
  partner           String?
  import_batch_id   String
  statement_date    DateTime?               @db.Date
  gross_sales_cents Int?
  commission_cents  Int?
  net_payout_cents  Int?
  raw_data          Json?
  status            imported_expense_status @default(PENDING)
  created_at        DateTime?               @default(now()) @db.Timestamp(6)
  approved_by       String?
  approved_at       DateTime?               @db.Timestamp(6)
}

model pos_receipt {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  batch_id   String
  receipt_id String   @unique(map: "ux_pos_receipt_receiptid")
  datetime   DateTime @db.Timestamptz(6)
  total      Decimal  @default(0) @db.Decimal(10, 2)
  items_json Json     @default("[]")
  payment    String?
  created_at DateTime @default(now()) @db.Timestamptz(6)

  @@unique([batch_id, receipt_id])
  @@index([batch_id], map: "idx_pos_receipt_batch_id")
  @@index([datetime], map: "idx_pos_receipt_datetime")
}

model purchase_tally {
  id                   String                 @id @default(dbgenerated("gen_random_uuid()")) @db.VarChar
  created_at           DateTime               @default(now()) @db.Timestamp(6)
  date                 DateTime               @db.Date
  staff                String?
  supplier             String?
  amount_thb           Decimal?               @db.Decimal(10, 2)
  notes                String?
  rolls_pcs            Int?
  meat_grams           Int?
  purchase_tally_drink purchase_tally_drink[]
}

model purchase_tally_drink {
  id             String         @id @default(dbgenerated("gen_random_uuid()")) @db.VarChar
  tally_id       String         @db.VarChar
  item_name      String
  qty            Int
  unit           String         @default("pcs")
  purchase_tally purchase_tally @relation(fields: [tally_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([item_name])
  @@index([tally_id])
}

model recipe_lines {
  id              BigInt   @id @default(autoincrement())
  recipe_id       BigInt?
  ingredient_id   String?
  ingredient_name String
  qty             Decimal  @default(0) @db.Decimal
  unit            String
  unit_cost_thb   Decimal  @default(0) @db.Decimal
  cost_thb        Decimal  @default(0) @db.Decimal
  supplier        String?
  recipes         recipes? @relation(fields: [recipe_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

model recipes {
  id               BigInt         @id @default(autoincrement())
  name             String
  note             String?
  waste_pct        Decimal?       @default(0) @db.Decimal
  portions         Int?           @default(1)
  menu_price_thb   Decimal?       @default(0) @db.Decimal
  totals_json      Json?
  description      String?
  created_at       DateTime?      @default(now()) @db.Timestamptz(6)
  category         String?        @default("Burgers")
  yield_quantity   Decimal?       @default(1) @db.Decimal
  yield_unit       String?        @default("servings")
  ingredients      Json?          @default("[]")
  total_cost       Decimal?       @default(0) @db.Decimal
  cost_per_serving Decimal?       @default(0) @db.Decimal
  cogs_percent     Decimal?       @default(0) @db.Decimal
  suggested_price  Decimal?       @default(0) @db.Decimal
  waste_factor     Decimal?       @default(0.05) @db.Decimal
  yield_efficiency Decimal?       @default(0.90) @db.Decimal
  image_url        String?
  instructions     String?
  notes            String?
  is_active        Boolean?       @default(true)
  updated_at       DateTime?      @default(now()) @db.Timestamptz(6)
  version          Int?           @default(1)
  parent_id        Int?
  recipe_lines     recipe_lines[]
}

model shopping_list {
  id                  String                @id @default(dbgenerated("gen_random_uuid()"))
  created_at          DateTime?             @default(now()) @db.Timestamp(6)
  sales_form_id       String?
  stock_form_id       String?
  rolls_count         Int?                  @default(0)
  meat_weight_grams   Int?                  @default(0)
  drinks_counts       Json?                 @default("[]")
  items               Json?                 @default("[]")
  total_items         Int?                  @default(0)
  item_name           String?               @db.VarChar(255)
  quantity            Int?
  unit                String?               @default("unit") @db.VarChar(50)
  form_id             Int?
  list_date           DateTime?             @db.Timestamp(6)
  estimated_cost      Decimal?              @default(0) @db.Decimal(10, 2)
  supplier            String?               @default("") @db.VarChar(255)
  price_per_unit      Decimal?              @default(0) @db.Decimal(10, 2)
  notes               String?               @default("") @db.VarChar(255)
  priority            String?               @default("medium")
  selected            Boolean?              @default(false)
  ai_generated        Boolean?              @default(false)
  list_name           String?
  is_completed        Boolean?              @default(false)
  completed_at        DateTime?             @db.Timestamp(6)
  actual_cost         Decimal?              @default(0) @db.Decimal(10, 2)
  updated_at          DateTime?             @default(now()) @db.Timestamp(6)
  shopping_list_items shopping_list_items[]
}

model shopping_list_items {
  id               Int            @id @default(autoincrement())
  shopping_list_id String?
  ingredient_name  String         @db.VarChar(255)
  requested_qty    Decimal?       @db.Decimal(10, 3)
  requested_unit   String?        @db.VarChar(50)
  notes            String?
  created_at       DateTime?      @default(now()) @db.Timestamp(6)
  shopping_list    shopping_list? @relation(fields: [shopping_list_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([shopping_list_id], map: "idx_shopping_list_items_list_id")
}

model stock_ledger_day {
  day              DateTime  @id @db.Date
  rolls_prev_end   Int       @default(0)
  rolls_purchased  Int       @default(0)
  burgers_sold     Int       @default(0)
  rolls_expected   Int       @default(0)
  rolls_actual     Int       @default(0)
  rolls_paid       String    @default("N") @db.Char(1)
  meat_prev_end_g  Int       @default(0)
  meat_purchased_g Int       @default(0)
  meat_sold_g      Int       @default(0)
  meat_expected_g  Int       @default(0)
  meat_actual_g    Int       @default(0)
  meat_paid        String    @default("N") @db.Char(1)
  created_at       DateTime? @default(now()) @db.Timestamp(6)
  updated_at       DateTime? @default(now()) @db.Timestamp(6)
  rolls_sold       Int?      @default(0)
  submitted        Boolean?  @default(false)
}

model stock_ledger_drinks {
  day        DateTime  @db.Date
  brand      String
  prev_end   Int       @default(0)
  purchased  Int       @default(0)
  sold       Int       @default(0)
  expected   Int       @default(0)
  actual     Int       @default(0)
  variance   Int       @default(0)
  paid       String    @default("N") @db.Char(1)
  created_at DateTime? @default(now()) @db.Timestamp(6)
  updated_at DateTime? @default(now()) @db.Timestamp(6)

  @@id([day, brand])
}

model supplier_defaults {
  id               String    @id @default(dbgenerated("gen_random_uuid()"))
  restaurant_id    String
  supplier         String
  default_category String
  notes_template   String?
  updated_at       DateTime? @default(now()) @db.Timestamp(6)
}

model suppliers {
  id           Int           @id @default(autoincrement())
  name         String        @unique @db.VarChar(255)
  contact_info String?
  created_at   DateTime?     @default(now()) @db.Timestamp(6)
  ingredients  ingredients[]
}

enum POSProvider {
  LOYVERSE
  TOAST
  SQUARE
  LIGHTSPEED
  OTHER
}

enum ExpenseType {
  GENERAL
  PURCHASE
  WAGE
}

enum PaymentMethod {
  CASH
  CARD
  QR
  WALLET
  DELIVERY_PARTNER
  OTHER
}

enum SalesChannel {
  IN_STORE
  GRAB
  FOODPANDA
  LINE_MAN
  ONLINE
  OTHER
}

enum JobType {
  POS_BACKFILL
  POS_INCREMENTAL_SYNC
  ANALYTICS_DAILY
  EMAIL_SUMMARY
}

enum JobStatus {
  QUEUED
  RUNNING
  SUCCESS
  FAILED
  DEAD_LETTER
}

enum Provider {
  LOYVERSE
}

enum PaymentChannel {
  CASH
  QR
  CARD
  GRAB
  OTHER
}

enum ReconcileState {
  OK
  MISMATCH
  MISSING_DATA
}

enum MenuSource {
  house
  pos
  grab
  foodpanda
  other
}

enum imported_expense_status {
  PENDING
  APPROVED
  REJECTED
}

// === External SKU Mapping (Grab <-> POS) ===

enum SkuKind {
  ITEM
  MODIFIER
  BUNDLE
}

// PATCH O14 Chunk 5  Multi-Gateway Payment Provider Enum
enum PaymentGateway {
  stripe
  scb
  cash
  custom1
  custom2
}

// PATCH O14 Chunk 5  Restaurant Payment Providers (SaaS)
model restaurant_payment_providers_v1 {
  id             String          @id @default(cuid())
  restaurantId   String
  provider       PaymentGateway
  status         Boolean         @default(false)
  credentials    Json?
  createdAt      DateTime        @default(now())

  @@unique([restaurantId, provider])
  @@index([restaurantId])
}

model ExternalSkuMap {
  id          String   @id @default(cuid())
  channel     String   @db.VarChar(20) // 'grab' | 'pos'
  channelSku  String
  kind        SkuKind
  internalId  String   // maps to your internal Items/Modifiers ID (string UUID/cuid/sku)
  active      Boolean  @default(true)
  meta        Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([channel, channelSku, kind])
  @@index([kind, internalId])
}

model MissingSkuEvent {
  id            String   @id @default(cuid())
  channel       String   @db.VarChar(20) // 'grab' | 'pos'
  kind          SkuKind
  sku           String
  count         Int      @default(1)
  samplePayload Json?
  lastOrderRef  String?
  firstSeenAt   DateTime @default(now())
  lastSeenAt    DateTime @updatedAt

  @@unique([channel, kind, sku])
}

model PurchasingItem {
  id              Int      @id @default(autoincrement())
  item            String
  category        String?
  supplierName    String?
  brand           String?
  supplierSku     String?
  orderUnit       String?
  unitDescription String?
  unitCost        Decimal? @db.Decimal(10, 2)
  lastReviewDate  String?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("purchasing_items")
}

// PATCH 1  SHIFT REPORT REBUILD MODULE
model shift_report_v2 {
  id           String   @id @default(cuid())
  shiftDate    DateTime
  salesId      String?
  stockId      String?
  posData      Json?
  salesData    Json?
  stockData    Json?
  variances    Json?
  aiInsights   String?
  createdAt    DateTime @default(now())
  restaurantId String?
}


// PATCH  EXPENSES V2
model expenses_v2 {
  id          String   @id @default(cuid())
  date        DateTime
  category    String
  subcategory String?
  description String?
  amount      Float
  paymentType String?
  vendor      String?
  createdAt   DateTime @default(now())
}

// PATCH O2  ONLINE ORDERING
model orders_v2 {
  id              String   @id @default(cuid())
  createdAt       DateTime @default(now())

  customerName    String
  customerPhone   String
  orderType       String   // pickup | delivery | instore
  address         String?
  notes           String?

  paymentType     String   // cash | qr | pickup-cash
  paidStatus      String   @default("unverified")

  subtotal        Float
  total           Float

  distanceKm      Float?
  deliveryAllowed Boolean?

  partnerCode     String?
  partnerId       String?
  partner         partner_bars_v1? @relation(fields: [partnerId], references: [id])

  loyverseStatus  String   @default("pending")

  orderNumber     String?

  // KDS FIELDS
  kdsStatus       String   @default("new")
  kdsUpdatedAt    DateTime @updatedAt

  items           order_items_v2[]
  restaurantId    String?
}

model order_items_v2 {
  id          String   @id @default(cuid())
  orderId     String
  order       orders_v2 @relation(fields: [orderId], references: [id])

  itemId      String
  itemName    String
  qty         Int
  basePrice   Float

  modifiers   order_modifiers_v2[]
}

model order_modifiers_v2 {
  id          String   @id @default(cuid())
  orderItemId String
  orderItem   order_items_v2 @relation(fields: [orderItemId], references: [id])

  name        String
  price       Float
}

// PATCH O3  ORDER NUMBER SEQUENCE
model order_counters {
  id      String @id @default(cuid())
  key     String @unique
  value   Int
}

// PATCH O3  LOYVERSE MAPPING TABLE
model loyverse_map_v2 {
  id                String @id @default(cuid())
  menuItemId        String?
  loyverseItemId    String?
  modifierName      String?
  loyverseModifierId String?
}

// PATCH O5  SCB TRANSACTION LOG
model scb_transactions_v1 {
  id            String   @id @default(cuid())
  scbTxnId      String?
  amount        Float
  ref           String?
  timestamp     DateTime @default(now())
  matched       Boolean  @default(false)
  orderId       String?

  webhookPayload Json
}

// PATCH O7  PARTNER BAR REFERRAL ENGINE
model partner_bars_v1 {
  id          String   @id @default(cuid())
  name        String
  code        String   @unique  // e.g., "RAWAI123"
  contactName String?
  phone       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  restaurantId String?

  // relationship
  orders orders_v2[]
  activity partner_activity_v1[]
}

model partner_activity_v1 {
  id          String   @id @default(cuid())
  partnerId   String
  orderId     String?
  amount      Float
  channel     String   // "qr" | "manual" | "direct"
  createdAt   DateTime @default(now())

  partner partner_bars_v1 @relation(fields: [partnerId], references: [id])
}

// PATCH O8  DELIVERY ENGINE BACKEND CORE

model drivers_v1 {
  id          String   @id @default(cuid())
  name        String
  phone       String?
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  restaurantId String?

  sessions driver_sessions_v1[]
  deliveries deliveries_v1[]
}

model driver_sessions_v1 {
  id        String   @id @default(cuid())
  driverId  String
  online    Boolean  @default(true)
  startedAt DateTime @default(now())
  endedAt   DateTime?

  driver drivers_v1 @relation(fields: [driverId], references: [id])
}

model deliveries_v1 {
  id            String   @id @default(cuid())
  orderId       String
  driverId      String?
  status        String   @default("pending") 
  // pending  assigned  picked_up  on_the_way  delivered  cancelled

  address       String?
  lat           Float?
  lng           Float?
  deliveryType  String   @default("delivery") // delivery | pickup | partner
  fee           Float    @default(0)
  assignedAt    DateTime?
  pickedUpAt    DateTime?
  deliveredAt   DateTime?
  createdAt     DateTime @default(now())
  restaurantId  String?

  driver drivers_v1? @relation(fields: [driverId], references: [id])
}

// PATCH O10-A  MENU MASTER ENGINE V3

model menu_categories_v3 {
  id             String   @id @default(cuid())
  name           String
  sortOrder      Int       @default(0)
  visiblePOS     Boolean   @default(true)
  visibleOnline  Boolean   @default(true)
  visibleDelivery Boolean  @default(true)
  visiblePartner Boolean   @default(true)
  isActive       Boolean   @default(true)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  restaurantId   String?

  items          menu_items_v3[]
}

model menu_items_v3 {
  id             String   @id @default(cuid())
  categoryId     String
  name           String
  description    String?
  basePrice      Float
  imageUrl       String?
  posEnabled     Boolean   @default(true)
  onlineEnabled  Boolean   @default(true)
  partnerEnabled Boolean   @default(true)
  kitchenStation String     @default("prep")
  sortOrder      Int        @default(0)
  isActive       Boolean    @default(true)
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt
  restaurantId   String?

  category       menu_categories_v3 @relation(fields: [categoryId], references: [id])
  modifiers      menu_modifiers_group_v3[] @relation("ItemToModifierGroup")
  recipes        menu_item_recipes_v3[]
}

model menu_modifiers_group_v3 {
  id             String    @id @default(cuid())
  name           String
  minSelect      Int        @default(0)
  maxSelect      Int        @default(10)
  sortOrder      Int        @default(0)
  required       Boolean    @default(false)
  isActive       Boolean    @default(true)
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt
  restaurantId   String?

  modifiers      menu_modifiers_v3[]
  appliesToItems menu_items_v3[] @relation("ItemToModifierGroup")
}

model menu_modifiers_v3 {
  id             String   @id @default(cuid())
  groupId        String
  name           String
  price          Float     @default(0)
  sortOrder      Int       @default(0)
  isActive       Boolean   @default(true)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  restaurantId   String?

  group          menu_modifiers_group_v3 @relation(fields: [groupId], references: [id])
}

model menu_item_recipes_v3 {
  id             String   @id @default(cuid())
  itemId         String
  ingredientId   String
  quantityUsed   Float
  unit           String
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  restaurantId   String?

  item           menu_items_v3 @relation(fields: [itemId], references: [id])
}

// PATCH O12  REAL-TIME STOCK & INGREDIENT DEDUCTION ENGINE

model stock_ledger_v1 {
  id          String   @id @default(cuid())
  itemId      String
  itemName    String
  change      Float
  reason      String
  source      String
  orderId     String?
  createdAt   DateTime @default(now())
  restaurantId String?
}

model stock_item_live_v1 {
  id        String   @id @default(cuid())
  name      String
  unit      String
  qty       Float    @default(0)
  updatedAt DateTime @default(now())
  restaurantId String?
}

model recipe_portions_v1 {
  id             String   @id @default(cuid())
  menuItemId     String
  ingredientId   String
  ingredientName String
  qty            Float
  unit           String
  restaurantId   String?
}

// PATCH O14  MULTI-TENANT SAAS FOUNDATION

model saas_tenants {
  id          Int       @id @default(autoincrement())
  name        String
  domain      String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @default(now())
  users       saas_tenant_users[]
  settings    saas_tenant_settings?
}

model saas_tenant_users {
  id            Int       @id @default(autoincrement())
  tenantId      Int
  email         String    @unique
  passwordHash  String
  role          String    // owner, manager, staff, pos
  createdAt     DateTime  @default(now())

  tenant        saas_tenants @relation(fields: [tenantId], references: [id])
}

model saas_tenant_settings {
  id            Int       @id @default(autoincrement())
  tenantId      Int       @unique
  timezone      String    @default("Asia/Bangkok")
  currency      String    @default("THB")
  locale        String    @default("en")
  logoUrl       String?
  colorPrimary  String?

  tenant        saas_tenants @relation(fields: [tenantId], references: [id])
}

// PATCH DS-LY-DB  DATA SAFETY + LOYVERSE HISTORICAL IMPORT

model backup_logs_v1 {
  id            String   @id @default(cuid())
  createdAt     DateTime @default(now())
  status        String   @default("pending") // pending | success | failed
  type          String   // full | daily | manual
  sqlDumpPath   String?
  csvZipPath    String?
  tableCounts   Json?    // { table_name: count }
  sizeBytes     Int?
  durationMs    Int?
  errorMessage  String?
  triggeredBy   String?  // system | manual | scheduled
}

model historical_shifts_v1 {
  id            String   @id @default(cuid())
  shiftDate     String
  businessDate  DateTime @db.Date
  source        String   @default("loyverse_import")
  importedAt    DateTime @default(now())
  totalReceipts Int      @default(0)
  totalRevenue  Float    @default(0)
  totalOrders   Int      @default(0)
  cashAmount    Float    @default(0)
  cardAmount    Float    @default(0)
  qrAmount      Float    @default(0)
  otherAmount   Float    @default(0)
  topItems      Json?
  rawData       Json?

  @@unique([shiftDate, source])
}

model historical_sales_v1 {
  id            String   @id @default(cuid())
  shiftDate     String
  businessDate  DateTime @db.Date
  source        String   @default("loyverse_import")
  importedAt    DateTime @default(now())
  itemId        String
  itemName      String
  categoryName  String?
  quantitySold  Int      @default(0)
  grossSales    Float    @default(0)
  netSales      Float    @default(0)
  
  @@index([businessDate])
  @@index([itemName])
}

// PATCH L2.1  MIGRATION REPORTS FOR AUDIT TRAIL
model migration_reports_v1 {
  id            String   @id @default(cuid())
  type          String   // 'loyverse_menu_import'
  dryRun        Boolean  @default(false)
  status        String   @default("pending") // pending | success | failed
  startedAt     DateTime @default(now())
  finishedAt    DateTime?
  categoriesFound    Int @default(0)
  categoriesCreated  Int @default(0)
  categoriesSkipped  Int @default(0)
  itemsFound         Int @default(0)
  itemsCreated       Int @default(0)
  itemsSkipped       Int @default(0)
  modifiersFound     Int @default(0)
  modifiersCreated   Int @default(0)
  modifiersSkipped   Int @default(0)
  conflicts     Json?
  errors        Json?
  report        Json?
  restaurantId  String?
}

// PATCH A  HEALTH & SAFETY AUDIT
model HealthSafetyQuestion {
  id          String   @id @default(cuid())
  section     String
  label       String
  isCritical  Boolean  @default(false)
  isActive    Boolean  @default(true)
  sortOrder   Int
  createdAt   DateTime @default(now())

  auditItems  HealthSafetyAuditItem[]
}

model HealthSafetyAudit {
  id           String   @id @default(cuid())
  managerName  String
  status       AuditStatus
  notes        String?
  completedAt  DateTime @default(now())
  createdAt    DateTime @default(now())

  items        HealthSafetyAuditItem[]
}

model HealthSafetyAuditItem {
  id          String   @id @default(cuid())
  auditId     String
  questionId  String
  checked     Boolean

  audit       HealthSafetyAudit    @relation(fields: [auditId], references: [id])
  question    HealthSafetyQuestion @relation(fields: [questionId], references: [id])
}

enum AuditStatus {
  PASS
  FAIL
}

// 
// PATCH 1  CANONICAL SOLD ITEM LAYER
// 

model SoldItem {
  id              String   @id @default(uuid())

  receiptId       String
  receiptItemId   String
  soldAt          DateTime
  shiftId         String

  channel         String
  externalSku     String?
  internalItemId  String?
  recipeId        String?

  unitPrice       Int
  quantity        Int      // ALWAYS 1
  grossAmount     Int
  discountAmount  Int
  netAmount       Int

  createdAt       DateTime @default(now())

  modifiers       SoldItemModifier[]

  @@index([receiptId])
  @@index([receiptItemId])
  @@index([soldAt])
  @@index([shiftId])
  @@map("sold_items")
}

model SoldItemModifier {
  id         String   @id @default(uuid())
  soldItemId String
  name       String
  priceDelta Int
  createdAt  DateTime @default(now())

  soldItem   SoldItem @relation(fields: [soldItemId], references: [id], onDelete: Cascade)

  @@index([soldItemId])
  @@map("sold_item_modifiers")
}

// 
// PATCH 2  MATERIALISED INGREDIENT USAGE
// 

model ShiftIngredientUsage {
  id             String   @id @default(uuid())
  shiftId        String
  ingredientId   String
  ingredientName String
  quantityUsed   Decimal
  unit           String
  source         String   // SOLD_ITEM_RECIPE
  createdAt      DateTime @default(now())

  @@index([shiftId])
  @@index([ingredientId])
  @@map("shift_ingredient_usage")
}

// 
// PATCH 3  RECONCILIATION V2 (POS vs DAILY SALES)
// 

enum ReconciliationStatus {
  OK
  WARNING
  FAIL
}

model ShiftReconciliation {
  id             String               @id @default(uuid())
  shiftId        String

  posSales       Int
  declaredSales  Int
  salesVariance  Int

  expectedBuns   Int
  declaredBuns   Int
  bunsVariance   Int

  expectedMeat   Decimal
  declaredMeat   Decimal
  meatVariance   Decimal

  status         ReconciliationStatus
  createdAt      DateTime             @default(now())

  @@index([shiftId])
  @@map("shift_reconciliation")
}
