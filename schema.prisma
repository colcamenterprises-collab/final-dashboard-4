generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model DailySales {
  id              String   @id @default(uuid())
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  status          String   @default("draft") // "draft" or "submitted"
  shiftDate       String   // "DD/MM/YYYY" (as entered)
  submittedAtISO  DateTime?

  completedBy     String
  startingCash    Int      @default(0)
  endingCash      Int      @default(0)
  cashBanked      Int      @default(0)

  // Sales
  cashSales       Int      @default(0)
  qrSales         Int      @default(0)
  grabSales       Int      @default(0)
  aroiSales       Int      @default(0) // renamed from aroiDeeSales
  totalSales      Int      @default(0)

  // Expenses totals
  shoppingTotal   Int      @default(0)
  wagesTotal      Int      @default(0)
  othersTotal     Int      @default(0)
  totalExpenses   Int      @default(0)

  // Banking
  closingCash     Int      @default(0)
  qrTransfer      Int      @default(0)

  // Relations
  shopping        ShoppingPurchase[]
  wages           WageEntry[]
  others          OtherExpense[]
  stock           DailyStock?

  // Notes
  notes           String?

  // Soft delete
  deletedAt       DateTime? // null = active, otherwise hidden
  
  // Phase 2 Relations
  snapshots       ShiftSnapshot[]
  comparisons     JussiComparison[]
}

model ShoppingPurchase {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())

  item      String
  cost      Int      @default(0)
  shop      String

  salesId   String
  sales     DailySales @relation(fields: [salesId], references: [id], onDelete: Cascade)

  @@map("shopping_purchases")
}

model WageEntry {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())

  staff     String
  amount    Int      @default(0)
  type      String   // WAGES | OVERTIME | BONUS | REIMBURSEMENT

  salesId   String
  sales     DailySales @relation(fields: [salesId], references: [id], onDelete: Cascade)

  @@map("wage_entries")
}

model OtherExpense {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())

  label     String
  amount    Int      @default(0)

  salesId   String
  sales     DailySales @relation(fields: [salesId], references: [id], onDelete: Cascade)

  @@map("other_expenses")
}

model DailyStock {
  id                String   @id @default(uuid())
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  salesId           String   @unique
  sales             DailySales @relation(fields: [salesId], references: [id], onDelete: Cascade)

  // Stock counts (per your ops rules)
  burgerBuns        Int      @default(0) // end-of-shift count - RENAMED: was bunsCount
  meatWeightG       Int      @default(0) // grams remaining - RENAMED: was meatGrams
  // Drinks by item â€“ simple JSON to stay flexible
  drinksJson        Json?

  // Notes & purchasing needs
  notes             String?  // free text
  purchasingJson    Json?    // items requested (>0) from Form 2

  // Status
  status            String   @default("submitted") // keep simple for now
  deletedAt         DateTime?
  
  // Additional fields for new spec
  bunsCount         Int      @default(0) // new alias for burgerBuns
  meatGrams         Int      @default(0) // new alias for meatWeightG
}

// New models for POS ingestion and analytics
enum POSProvider {
  LOYVERSE
  TOAST
  SQUARE
  LIGHTSPEED
  OTHER
}

enum ExpenseType { 
  GENERAL 
  PURCHASE 
  WAGE 
}

enum PaymentMethod {
  CASH
  CARD
  QR
  WALLET
  DELIVERY_PARTNER
  OTHER
}

enum SalesChannel {
  IN_STORE
  GRAB
  FOODPANDA
  LINE_MAN
  ONLINE
  OTHER
}

enum JobType {
  POS_BACKFILL
  POS_INCREMENTAL_SYNC
  ANALYTICS_DAILY
  EMAIL_SUMMARY
}

enum JobStatus {
  QUEUED
  RUNNING
  SUCCESS
  FAILED
  DEAD_LETTER
}

model Restaurant {
  id              String           @id @default(cuid())
  name            String
  slug            String           @unique
  email           String?
  timezone        String           @default("Asia/Bangkok")
  locale          String           @default("en-TH")
  logoUrl         String?
  brandColor      String?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  posConnections  PosConnection[]
  menuItems       MenuItem[]
  receipts        Receipt[]
  expenses        Expense[]
  analyticsDaily  AnalyticsDaily[]
  jobs            Job[]
  syncLogs        PosSyncLog[]
  ingestionErrors IngestionError[]

  @@map("restaurants")
}

model PosConnection {
  id            String      @id @default(cuid())
  restaurantId  String
  provider      POSProvider
  apiKey        String?
  refreshToken  String?
  meta          Json?
  isActive      Boolean     @default(true)
  lastSyncAt    DateTime?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  restaurant    Restaurant  @relation(fields: [restaurantId], references: [id])

  @@index([restaurantId])
  @@index([provider, isActive])
  @@map("pos_connections")
}

model Receipt {
  id            String        @id @default(cuid())
  restaurantId  String
  provider      POSProvider
  externalId    String
  receiptNumber String?
  channel       SalesChannel  @default(OTHER)
  createdAtUTC  DateTime
  closedAtUTC   DateTime?
  subtotal      Int
  tax           Int
  discount      Int
  total         Int
  notes         String?
  rawPayload    Json?
  createdAt     DateTime      @default(now())

  restaurant    Restaurant    @relation(fields: [restaurantId], references: [id])
  items         ReceiptItem[]
  payments      ReceiptPayment[]

  @@unique([restaurantId, provider, externalId])
  @@index([restaurantId, createdAtUTC])
  @@map("receipts")
}

model ReceiptItem {
  id             String   @id @default(cuid())
  receiptId      String
  providerItemId String?
  sku            String?
  name           String
  category       String?
  qty            Int
  unitPrice      Int
  total          Int
  modifiers      Json?

  receipt        Receipt  @relation(fields: [receiptId], references: [id])

  @@index([receiptId])
  @@map("receipt_items")
}

model ReceiptPayment {
  id        String        @id @default(cuid())
  receiptId String
  method    PaymentMethod @default(OTHER)
  amount    Int
  meta      Json?

  receipt   Receipt       @relation(fields: [receiptId], references: [id])

  @@index([receiptId])
  @@map("receipt_payments")
}

model MenuItem {
  id            String     @id @default(cuid())
  restaurantId  String
  sku           String
  name          String
  category      String
  portionGrams  Int?
  isDrink       Boolean    @default(false)
  isBurger      Boolean    @default(false)
  active        Boolean    @default(true)
  meta          Json?
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  restaurant    Restaurant @relation(fields: [restaurantId], references: [id])

  @@unique([restaurantId, sku])
  @@index([restaurantId, category])
  @@map("menu_items")
}

model Expense {
  id            String     @id @default(cuid())
  restaurantId  String
  shiftDate     DateTime
  item          String
  costCents     Int
  supplier      String?
  expenseType   String?
  meta          Json?
  createdAt     DateTime   @default(now())

  restaurant    Restaurant @relation(fields: [restaurantId], references: [id])

  @@index([restaurantId, shiftDate])
  @@map("expenses")
}

model ExpenseLine {
  id           String      @id @default(uuid())
  expenseId    String
  ingredientId String?
  name         String
  qty          Float?
  uom          String?
  unitPriceTHB Decimal?    @db.Decimal(12,4)
  lineTotalTHB Decimal?    @db.Decimal(12,2)
  type         ExpenseType @default(GENERAL)
  createdAt    DateTime    @default(now())
  
  @@index([ingredientId])
}

model AnalyticsDaily {
  id                String    @id @default(cuid())
  restaurantId      String
  shiftDate         DateTime
  top5ByQty         Json?
  top5ByRevenue     Json?
  expectedBunsUsed  Int?
  expectedMeatGrams Int?
  expectedDrinksUsed Int?
  variance          Json?
  shoppingList      Json?
  flags             Json?
  createdAt         DateTime  @default(now())

  restaurant        Restaurant @relation(fields: [restaurantId], references: [id])

  @@unique([restaurantId, shiftDate])
  @@index([restaurantId, shiftDate])
  @@map("analytics_daily")
}

model Job {
  id            String     @id @default(cuid())
  restaurantId  String?
  type          JobType
  payload       Json?
  status        JobStatus  @default(QUEUED)
  runAt         DateTime?
  attempts      Int        @default(0)
  lastError     String?
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  restaurant    Restaurant? @relation(fields: [restaurantId], references: [id])

  @@index([status, runAt])
  @@index([restaurantId])
  @@map("jobs")
}

model PosSyncLog {
  id               String      @id @default(cuid())
  restaurantId     String
  provider         POSProvider
  startedAt        DateTime    @default(now())
  finishedAt       DateTime?
  mode             String
  receiptsFetched  Int         @default(0)
  itemsUpserted    Int         @default(0)
  paymentsUpserted Int         @default(0)
  status           String      @default("SUCCESS")
  message          String?
  createdAt        DateTime    @default(now())

  restaurant       Restaurant  @relation(fields: [restaurantId], references: [id])

  @@index([restaurantId, provider, startedAt])
  @@map("pos_sync_logs")
}

model IngestionError {
  id            String      @id @default(cuid())
  restaurantId  String?
  provider      POSProvider?
  externalId    String?
  context       String?
  errorMessage  String
  rawPayload    Json?
  createdAt     DateTime    @default(now())

  restaurant    Restaurant? @relation(fields: [restaurantId], references: [id])

  @@index([restaurantId, provider, createdAt])
  @@map("ingestion_errors")
}

// ========= Phase 2: Snapshot System Enums =========
enum Provider {
  LOYVERSE
}

enum PaymentChannel {
  CASH
  QR
  CARD
  GRAB
  OTHER
}

enum ReconcileState {
  OK
  MISMATCH
  MISSING_DATA
}

// ========= Core Snapshot =========
model ShiftSnapshot {
  id                  String            @id @default(uuid())
  provider            Provider          @default(LOYVERSE)
  windowStartUTC      DateTime
  windowEndUTC        DateTime
  loyverseShiftNumber Int?
  salesFormId         String?
  createdAt           DateTime          @default(now())
  totalReceipts       Int               @default(0)
  totalSalesSatang    BigInt            @default(0)
  reconcileState      ReconcileState    @default(MISSING_DATA)
  reconcileNotes      String?

  payments   PaymentBreakdown[]
  items      SnapshotItem[]
  modifiers  SnapshotModifier[]
  comparisons JussiComparison[]

  salesForm  DailySales? @relation(fields: [salesFormId], references: [id], onDelete: SetNull)

  @@index([windowStartUTC, windowEndUTC])
}

model PaymentBreakdown {
  id           String         @id @default(uuid())
  snapshotId   String
  channel      PaymentChannel
  count        Int            @default(0)
  totalSatang  BigInt         @default(0)

  snapshot     ShiftSnapshot  @relation(fields: [snapshotId], references: [id], onDelete: Cascade)

  @@index([snapshotId])
  @@unique([snapshotId, channel])
}

model SnapshotItem {
  id            String         @id @default(uuid())
  snapshotId    String
  itemName      String
  sku           String?
  category      String?
  qty           Int            @default(0)
  revenueSatang BigInt         @default(0)

  snapshot      ShiftSnapshot  @relation(fields: [snapshotId], references: [id], onDelete: Cascade)

  @@index([snapshotId])
}

model SnapshotModifier {
  id            String         @id @default(uuid())
  snapshotId    String
  modifierName  String
  lines         Int            @default(0)
  revenueSatang BigInt         @default(0)

  snapshot      ShiftSnapshot  @relation(fields: [snapshotId], references: [id], onDelete: Cascade)

  @@index([snapshotId])
}

// Map LV payment labels to canonical channels
model PaymentMethodMap {
  id         String         @id @default(uuid())
  provider   Provider       @default(LOYVERSE)
  sourceName String
  channel    PaymentChannel @default(OTHER)
  createdAt  DateTime       @default(now())

  @@unique([provider, sourceName])
}

// ========= Recipes (for precise Jussi) =========
model RecipeItem {
  id         String   @id @default(uuid())
  sku        String?  @unique
  name       String
  category   String?
  isMealDeal Boolean  @default(false)
  createdAt  DateTime @default(now())

  components RecipeComponent[]
}

model RecipeComponent {
  id           String     @id @default(uuid())
  recipeItemId String
  ingredientId String
  baseQty      Float
  uom          String

  recipeItem   RecipeItem @relation(fields: [recipeItemId], references: [id], onDelete: Cascade)

  @@index([recipeItemId])
}

// ========= Jussi Comparison Record =========
model JussiComparison {
  id               String         @id @default(uuid())
  snapshotId       String
  salesFormId      String?
  createdAt        DateTime       @default(now())

  // Opening stock (from previous shift)
  openingBuns      Int?
  openingMeatGram  Int?
  openingDrinks    Int?

  // Purchases during the window
  purchasedBuns    Int?
  purchasedMeatGram Int?
  purchasedDrinks  Int?

  // Usage from POS
  expectedBuns     Int?
  expectedMeatGram Int?
  expectedDrinks   Int?

  // Expected closing (opening + purchases - usage)
  expectedCloseBuns    Int?
  expectedCloseMeatGram Int?
  expectedCloseDrinks  Int?

  // Staff closing (actual counts)
  staffBuns        Int?
  staffMeatGram    Int?
  staffDrinks      Int?

  // Variance (staff - expected closing)
  varBuns          Int?
  varMeatGram      Int?
  varDrinks        Int?

  state            ReconcileState @default(MISSING_DATA)
  notes            String?

  snapshot         ShiftSnapshot  @relation(fields: [snapshotId], references: [id], onDelete: Cascade)
  salesForm        DailySales?    @relation(fields: [salesFormId], references: [id], onDelete: SetNull)

  @@index([snapshotId])
  @@index([salesFormId])
}

// V2 Models (additive, non-destructive)
model DailySalesV2 {
  id             String   @id @default(uuid())
  createdAt      DateTime @default(now())
  shiftDate      String
  submittedAtISO DateTime
  completedBy    String
  startingCash   Int      @default(0)
  endingCash     Int      @default(0)
  cashBanked     Int      @default(0)
  cashSales      Int      @default(0)
  qrSales        Int      @default(0)
  grabSales      Int      @default(0)
  aroiSales      Int      @default(0)
  totalSales     Int      @default(0)
  shoppingTotal  Int      @default(0)
  wagesTotal     Int      @default(0)
  othersTotal    Int      @default(0)
  totalExpenses  Int      @default(0)
  qrTransfer     Int      @default(0)
  payload        Json?
  staff          String?
  shift_date     DateTime? @db.Date
  shopping       ShoppingPurchaseV2[]
  wages          WageEntryV2[]
  others         OtherExpenseV2[]
  stock          DailyStockV2?
  deletedAt      DateTime?
  @@map("daily_sales_v2")
}

model ShoppingPurchaseV2 {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  item      String
  cost      Int      @default(0)
  shop      String
  salesId   String
  sales     DailySalesV2 @relation(fields: [salesId], references: [id], onDelete: Cascade)
  @@map("shopping_purchase_v2")
}

model WageEntryV2 {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  staff     String
  amount    Int      @default(0)
  type      String
  salesId   String
  sales     DailySalesV2 @relation(fields: [salesId], references: [id], onDelete: Cascade)
  @@map("wage_entry_v2")
}

model OtherExpenseV2 {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  label     String
  amount    Int      @default(0)
  salesId   String
  sales     DailySalesV2 @relation(fields: [salesId], references: [id], onDelete: Cascade)
  @@map("other_expense_v2")
}

model DailyStockV2 {
  id            String   @id @default(uuid())
  createdAt     DateTime @default(now())
  salesId       String   @unique
  sales         DailySalesV2 @relation(fields: [salesId], references: [id], onDelete: Cascade)
  burgerBuns    Int      @default(0)
  meatWeightG   Int      @default(0)
  drinksJson    Json?
  purchasingJson Json?
  notes         String?
  deletedAt     DateTime?
  @@map("daily_stock_v2")
}

model IngredientV2 {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  name      String   @unique
  unit      String
  unitCost  Decimal  @default(0)
  supplier  String?
  notes     String?
  recipeItems RecipeItemV2[]
  @@map("ingredient_v2")
}

model RecipeV2 {
  id           String   @id @default(uuid())
  createdAt    DateTime @default(now())
  name         String   @unique
  yield        Decimal  @default(1)
  targetMargin Decimal  @default(0)
  items        RecipeItemV2[]
  @@map("recipe_v2")
}

model RecipeItemV2 {
  id           String   @id @default(uuid())
  recipeId     String
  ingredientId String
  qty          Decimal  @default(0)
  recipe       RecipeV2      @relation(fields:[recipeId], references:[id], onDelete:Cascade)
  ingredient   IngredientV2  @relation(fields:[ingredientId], references:[id], onDelete:Restrict)
  @@unique([recipeId, ingredientId])
  @@map("recipe_item_v2")
}

enum MenuSource {
  house
  pos
  grab
  foodpanda
  other
}

model MenuV2 {
  id          String      @id @default(uuid())
  name        String
  source      MenuSource
  fileType    String
  version     String?     // optional partner version tag
  importedAt  DateTime    @default(now())
  notes       String?
  items       MenuItemV2[]
  @@index([source])
  @@map("menu_v2")
}

model MenuItemV2 {
  id          String   @id @default(uuid())
  menuId      String
  externalId  String?  // partner id / SKU
  name        String
  category    String?
  basePrice   Decimal  @default(0)
  description String?
  active      Boolean  @default(true)

  menu        MenuV2     @relation(fields: [menuId], references: [id], onDelete: Cascade)
  modifiers   MenuModifierV2[]

  @@unique([menuId, name])
  @@index([name])
  @@map("menu_item_v2")
}

model MenuModifierV2 {
  id        String   @id @default(uuid())
  itemId    String
  groupName String?
  name      String
  price     Decimal  @default(0)

  item      MenuItemV2 @relation(fields: [itemId], references: [id], onDelete: Cascade)

  @@index([itemId])
  @@map("menu_modifier_v2")
}

// ========= Stock Catalog System =========
// Stock catalog (imported from CSV)
model StockItem {
  id             Int       @id @default(autoincrement())
  name           String
  category       String     // e.g., "Fresh Food", "Drinks", "Packaging"
  isDrink        Boolean    @default(false)
  isExcluded     Boolean    @default(false) // will be true for the first 4 rows from CSV
  displayOrder   Int        @default(0)     // for stable ordering within categories
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt

  // reverse relation
  stockRequests  StockRequest[]

  @@map("stock_items")
}

// One row per (shiftId, item)
model StockRequest {
  id         Int      @id @default(autoincrement())
  shiftId    String   // UUID from Form 1
  stockItemId Int
  requestedQty Int?   // null or >= 0; null treated like "not requested"

  // audit
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  StockItem  StockItem @relation(fields: [stockItemId], references: [id])

  @@unique([shiftId, stockItemId])
  @@map("stock_requests")
}

model PosBatch {
  id         String   @id @default(uuid())
  createdAt  DateTime @default(now())
  title      String?
  shiftStart DateTime?
  shiftEnd   DateTime?

  receipts   PosReceipt[]
  shift      PosShiftReport?
  items      PosSalesItem[]
  modifiers  PosSalesModifier[]
  payments   PosPaymentSummary[]
}

model PosReceipt {
  id         String   @id @default(uuid())
  batchId    String
  batch      PosBatch @relation(fields: [batchId], references: [id])
  receiptId  String
  datetime   DateTime
  total      Decimal  @db.Decimal(10,2)
  itemsJson  Json
  payment    String?
}

model PosShiftReport {
  id                 String   @id @default(uuid())
  batchId            String   @unique
  batch              PosBatch @relation(fields: [batchId], references: [id])
  grossSales         Decimal  @db.Decimal(10,2)
  discounts          Decimal  @db.Decimal(10,2)
  netSales           Decimal  @db.Decimal(10,2)
  cashInDrawer       Decimal  @db.Decimal(10,2)
  cashSales          Decimal  @db.Decimal(10,2)
  qrSales            Decimal  @db.Decimal(10,2)
  otherSales         Decimal  @db.Decimal(10,2)
  receiptCount       Int
}

model PosSalesItem {
  id        String   @id @default(uuid())
  batchId   String
  batch     PosBatch @relation(fields: [batchId], references: [id])
  name      String
  qty       Int
  net       Decimal  @db.Decimal(10,2)
}

model PosSalesModifier {
  id        String   @id @default(uuid())
  batchId   String
  batch     PosBatch @relation(fields: [batchId], references: [id])
  name      String
  qty       Int
  net       Decimal  @db.Decimal(10,2)
}

model PosPaymentSummary {
  id        String   @id @default(uuid())
  batchId   String
  batch     PosBatch @relation(fields: [batchId], references: [id])
  method    String
  amount    Decimal  @db.Decimal(10,2)
}
model BankImportBatch {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  source    String
  filename  String
  status    String   @default("pending") // pending | partially_approved | approved
  txns      BankTxn[]
}

model BankTxn {
  id        String   @id @default(uuid())
  batchId   String
  batch     BankImportBatch @relation(fields: [batchId], references: [id], onDelete: Cascade)

  postedAt  DateTime
  description String
  amountTHB Decimal   @db.Decimal(12,2) // POSITIVE = expense/outflow
  ref       String?
  raw       Json

  status    String    @default("pending") // pending | approved | rejected | deleted
  category  String?
  supplier  String?
  notes     String?
  expenseId String?

  dedupeKey String    @unique
}

model VendorRule {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  matchText String   // e.g., "MAKRO"
  category  String   // e.g., "Supplies"
  supplier  String   // e.g., "Makro"
}

// Manager Quick Check System
model ManagerCheckQuestion {
  id          Int       @id @default(autoincrement())
  text        String
  category    String?   // e.g., Hygiene, Equipment, Food Safety
  enabled     Boolean   @default(true)
  weight      Int       @default(1)
  lastUsedAt  DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  items       DailyManagerCheckItem[]
}

model DailyManagerCheck {
  id           Int       @id @default(autoincrement())
  salesId      Int       // link to your DailySalesV2 or the ID used to join Form 1 -> Form 2 (shift id)
  createdAt    DateTime  @default(now())
  answeredBy   String?
  managerPin   String?
  status       String    @default("PENDING") // PENDING | COMPLETED | SKIPPED | UNAVAILABLE
  skipReason   String?
  items        DailyManagerCheckItem[]
}

model DailyManagerCheckItem {
  id            Int       @id @default(autoincrement())
  dailyCheckId  Int
  questionId    Int
  response      String?   // PASS | FAIL | NA
  note          String?
  photoUrl      String?

  ManagerCheckQuestion ManagerCheckQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)
  DailyManagerCheck    DailyManagerCheck    @relation(fields: [dailyCheckId], references: [id], onDelete: Cascade)

  @@unique([dailyCheckId, questionId])
}

